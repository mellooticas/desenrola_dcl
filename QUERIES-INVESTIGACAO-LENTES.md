# ðŸ” Queries para Investigar Banco de Lentes

Execute estas queries no **Supabase SQL Editor** do banco de lentes (`ahcikwsoxhmqqteertkx.supabase.co`) e me envie os resultados.

---

## 1ï¸âƒ£ Listar todas as VIEWS disponÃ­veis

```sql
SELECT
    schemaname,
    viewname,
    definition
FROM pg_views
WHERE schemaname = 'public'
ORDER BY viewname;
```

**O que busco**: Lista completa de views que posso usar

| schemaname | viewname                     | definition                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          |
| ---------- | ---------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| public     | v_estatisticas_catalogo      |  SELECT ( SELECT count(*) AS count
           FROM lens_catalog.lentes
          WHERE (lentes.ativo = true)) AS total_lentes,
    ( SELECT count(*) AS count
           FROM lens_catalog.marcas
          WHERE (marcas.ativo = true)) AS total_marcas,
    ( SELECT count(*) AS count
           FROM core.fornecedores
          WHERE (fornecedores.ativo = true)) AS total_fornecedores,
    ( SELECT count(*) AS count
           FROM lens_catalog.grupos_canonicos) AS total_grupos,
    ( SELECT count(*) AS count
           FROM lens_catalog.lentes
          WHERE ((lentes.tipo_lente = 'visao_simples'::lens_catalog.tipo_lente) AND (lentes.ativo = true))) AS lentes_visao_simples,
    ( SELECT count(*) AS count
           FROM lens_catalog.lentes
          WHERE ((lentes.tipo_lente = 'multifocal'::lens_catalog.tipo_lente) AND (lentes.ativo = true))) AS lentes_multifocal,
    ( SELECT count(*) AS count
           FROM lens_catalog.lentes
          WHERE ((lentes.tipo_lente = 'bifocal'::lens_catalog.tipo_lente) AND (lentes.ativo = true))) AS lentes_bifocal,
    ( SELECT min(lentes.preco_venda_sugerido) AS min
           FROM lens_catalog.lentes
          WHERE (lentes.ativo = true)) AS preco_minimo_geral,
    ( SELECT max(lentes.preco_venda_sugerido) AS max
           FROM lens_catalog.lentes
          WHERE (lentes.ativo = true)) AS preco_maximo_geral,
    ( SELECT avg(lentes.preco_venda_sugerido) AS avg
           FROM lens_catalog.lentes
          WHERE (lentes.ativo = true)) AS preco_medio_geral,
    ( SELECT count(*) AS count
           FROM compras.estoque_saldo
          WHERE (estoque_saldo.quantidade_disponivel > 0)) AS lentes_em_estoque,
    ( SELECT sum(estoque_saldo.quantidade_disponivel) AS sum
           FROM compras.estoque_saldo) AS quantidade_total_estoque,
    ( SELECT sum(estoque_saldo.valor_total_estoque) AS sum
           FROM compras.estoque_saldo) AS valor_total_estoque,
    ( SELECT count(*) AS count
           FROM compras.pedidos
          WHERE (pedidos.status <> ALL (ARRAY['recebido'::compras.status_pedido, 'cancelado'::compras.status_pedido]))) AS pedidos_pendentes,
    ( SELECT count(*) AS count
           FROM compras.pedidos
          WHERE ((pedidos.status = 'recebido'::compras.status_pedido) AND (pedidos.data_recebimento >= (now() - '30 days'::interval)))) AS pedidos_recebidos_mes;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |
| public     | v_estoque_disponivel         |  SELECT l.id AS lente_id,
    l.slug AS lente_slug,
    l.nome_canonizado AS lente_nome,
    f.nome AS fornecedor_nome,
    es.quantidade_disponivel,
    es.quantidade_reservada,
    es.quantidade_minima,
    (es.quantidade_disponivel - es.quantidade_reservada) AS quantidade_livre,
        CASE
            WHEN (es.quantidade_disponivel = 0) THEN 'esgotado'::text
            WHEN (es.quantidade_disponivel <= es.quantidade_minima) THEN 'baixo'::text
            WHEN (es.quantidade_disponivel >= es.quantidade_maxima) THEN 'alto'::text
            ELSE 'normal'::text
        END AS status_estoque,
    es.custo_medio,
    es.valor_total_estoque,
    es.ultima_entrada,
    es.ultima_saida,
    es.updated_at
   FROM ((compras.estoque_saldo es
     JOIN lens_catalog.lentes l ON ((es.lente_id = l.id)))
     JOIN core.fornecedores f ON ((l.fornecedor_id = f.id)))
  WHERE ((es.quantidade_disponivel > 0) AND (l.ativo = true))
  ORDER BY es.quantidade_disponivel;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |
| public     | v_filtros_disponiveis        |  SELECT 'tipo_lente'::text AS filtro_nome,
    (lentes.tipo_lente)::text AS valor,
    count(*) AS total,
    min(lentes.preco_venda_sugerido) AS preco_min,
    max(lentes.preco_venda_sugerido) AS preco_max
   FROM lens_catalog.lentes
  WHERE ((lentes.ativo = true) AND (lentes.status = 'ativo'::lens_catalog.status_lente))
  GROUP BY lentes.tipo_lente
UNION ALL
 SELECT 'material'::text AS filtro_nome,
    (lentes.material)::text AS valor,
    count(*) AS total,
    min(lentes.preco_venda_sugerido) AS preco_min,
    max(lentes.preco_venda_sugerido) AS preco_max
   FROM lens_catalog.lentes
  WHERE ((lentes.ativo = true) AND (lentes.status = 'ativo'::lens_catalog.status_lente))
  GROUP BY lentes.material
UNION ALL
 SELECT 'indice_refracao'::text AS filtro_nome,
    (lentes.indice_refracao)::text AS valor,
    count(*) AS total,
    min(lentes.preco_venda_sugerido) AS preco_min,
    max(lentes.preco_venda_sugerido) AS preco_max
   FROM lens_catalog.lentes
  WHERE ((lentes.ativo = true) AND (lentes.status = 'ativo'::lens_catalog.status_lente))
  GROUP BY lentes.indice_refracao
UNION ALL
 SELECT 'categoria'::text AS filtro_nome,
    (lentes.categoria)::text AS valor,
    count(*) AS total,
    min(lentes.preco_venda_sugerido) AS preco_min,
    max(lentes.preco_venda_sugerido) AS preco_max
   FROM lens_catalog.lentes
  WHERE ((lentes.ativo = true) AND (lentes.status = 'ativo'::lens_catalog.status_lente))
  GROUP BY lentes.categoria
UNION ALL
 SELECT 'marca'::text AS filtro_nome,
    m.nome AS valor,
    count(*) AS total,
    min(l.preco_venda_sugerido) AS preco_min,
    max(l.preco_venda_sugerido) AS preco_max
   FROM (lens_catalog.lentes l
     JOIN lens_catalog.marcas m ON ((l.marca_id = m.id)))
  WHERE ((l.ativo = true) AND (l.status = 'ativo'::lens_catalog.status_lente))
  GROUP BY m.nome
UNION ALL
 SELECT 'fornecedor'::text AS filtro_nome,
    f.nome AS valor,
    count(*) AS total,
    min(l.preco_venda_sugerido) AS preco_min,
    max(l.preco_venda_sugerido) AS preco_max
   FROM (lens_catalog.lentes l
     JOIN core.fornecedores f ON ((l.fornecedor_id = f.id)))
  WHERE ((l.ativo = true) AND (l.status = 'ativo'::lens_catalog.status_lente))
  GROUP BY f.nome
  ORDER BY 1, 3 DESC;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
| public     | v_filtros_grupos_canonicos   |  SELECT filtro_categoria,
    filtro_valor,
    count(*) AS total_grupos,
    min(preco_minimo) AS preco_min,
    max(preco_maximo) AS preco_max,
    (avg(preco_medio))::numeric(10,2) AS preco_medio_geral,
    sum(total_lentes) AS total_lentes_agregado
   FROM ( SELECT 'tipo_lente'::text AS filtro_categoria,
            (grupos_canonicos.tipo_lente)::text AS filtro_valor,
            grupos_canonicos.preco_minimo,
            grupos_canonicos.preco_maximo,
            grupos_canonicos.preco_medio,
            grupos_canonicos.total_lentes
           FROM lens_catalog.grupos_canonicos
          WHERE (grupos_canonicos.total_lentes > 0)
        UNION ALL
         SELECT 'material'::text AS filtro_categoria,
            (grupos_canonicos.material)::text AS filtro_valor,
            grupos_canonicos.preco_minimo,
            grupos_canonicos.preco_maximo,
            grupos_canonicos.preco_medio,
            grupos_canonicos.total_lentes
           FROM lens_catalog.grupos_canonicos
          WHERE (grupos_canonicos.total_lentes > 0)
        UNION ALL
         SELECT 'indice_refracao'::text AS filtro_categoria,
            (grupos_canonicos.indice_refracao)::text AS filtro_valor,
            grupos_canonicos.preco_minimo,
            grupos_canonicos.preco_maximo,
            grupos_canonicos.preco_medio,
            grupos_canonicos.total_lentes
           FROM lens_catalog.grupos_canonicos
          WHERE (grupos_canonicos.total_lentes > 0)
        UNION ALL
         SELECT 'categoria'::text AS filtro_categoria,
            (grupos_canonicos.categoria_predominante)::text AS filtro_valor,
            grupos_canonicos.preco_minimo,
            grupos_canonicos.preco_maximo,
            grupos_canonicos.preco_medio,
            grupos_canonicos.total_lentes
           FROM lens_catalog.grupos_canonicos
          WHERE (grupos_canonicos.total_lentes > 0)
        UNION ALL
         SELECT 'is_premium'::text AS filtro_categoria,
                CASE
                    WHEN grupos_canonicos.is_premium THEN 'premium'::text
                    ELSE 'generico'::text
                END AS filtro_valor,
            grupos_canonicos.preco_minimo,
            grupos_canonicos.preco_maximo,
            grupos_canonicos.preco_medio,
            grupos_canonicos.total_lentes
           FROM lens_catalog.grupos_canonicos
          WHERE (grupos_canonicos.total_lentes > 0)
        UNION ALL
         SELECT 'antirreflexo'::text AS filtro_categoria,
                CASE
                    WHEN grupos_canonicos.tem_antirreflexo THEN 'sim'::text
                    ELSE 'nao'::text
                END AS filtro_valor,
            grupos_canonicos.preco_minimo,
            grupos_canonicos.preco_maximo,
            grupos_canonicos.preco_medio,
            grupos_canonicos.total_lentes
           FROM lens_catalog.grupos_canonicos
          WHERE (grupos_canonicos.total_lentes > 0)
        UNION ALL
         SELECT 'blue_light'::text AS filtro_categoria,
                CASE
                    WHEN grupos_canonicos.tem_blue_light THEN 'sim'::text
                    ELSE 'nao'::text
                END AS filtro_valor,
            grupos_canonicos.preco_minimo,
            grupos_canonicos.preco_maximo,
            grupos_canonicos.preco_medio,
            grupos_canonicos.total_lentes
           FROM lens_catalog.grupos_canonicos
          WHERE (grupos_canonicos.total_lentes > 0)
        UNION ALL
         SELECT 'fotossensiveis'::text AS filtro_categoria,
            (grupos_canonicos.tratamento_foto)::text AS filtro_valor,
            grupos_canonicos.preco_minimo,
            grupos_canonicos.preco_maximo,
            grupos_canonicos.preco_medio,
            grupos_canonicos.total_lentes
           FROM lens_catalog.grupos_canonicos
          WHERE ((grupos_canonicos.total_lentes > 0) AND (grupos_canonicos.tratamento_foto IS NOT NULL) AND ((grupos_canonicos.tratamento_foto)::text <> 'nenhum'::text))) filtros_agregados
  GROUP BY filtro_categoria, filtro_valor
  ORDER BY filtro_categoria, (count(*)) DESC;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |
| public     | v_fornecedores_catalogo      |  SELECT id,
    nome,
    razao_social,
    prazo_visao_simples,
    prazo_multifocal,
    prazo_surfacada,
    prazo_free_form,
    ( SELECT count(*) AS count
           FROM lens_catalog.lentes
          WHERE ((lentes.fornecedor_id = f.id) AND (lentes.ativo = true))) AS total_lentes,
    ( SELECT count(DISTINCT lentes.marca_id) AS count
           FROM lens_catalog.lentes
          WHERE ((lentes.fornecedor_id = f.id) AND (lentes.ativo = true))) AS total_marcas,
    ( SELECT min(lentes.preco_venda_sugerido) AS min
           FROM lens_catalog.lentes
          WHERE ((lentes.fornecedor_id = f.id) AND (lentes.ativo = true))) AS preco_minimo,
    ( SELECT max(lentes.preco_venda_sugerido) AS max
           FROM lens_catalog.lentes
          WHERE ((lentes.fornecedor_id = f.id) AND (lentes.ativo = true))) AS preco_maximo,
    ( SELECT avg(lentes.preco_venda_sugerido) AS avg
           FROM lens_catalog.lentes
          WHERE ((lentes.fornecedor_id = f.id) AND (lentes.ativo = true))) AS preco_medio,
    ((frete_config -> 'contato'::text) ->> 'email'::text) AS email_contato,
    ((frete_config -> 'contato'::text) ->> 'telefone'::text) AS telefone_contato,
    jsonb_build_object('tipo', (frete_config ->> 'tipo'::text), 'frete_gratis_acima', (frete_config ->> 'frete_gratis_acima'::text), 'taxa_fixa', (frete_config ->> 'taxa_fixa'::text)) AS config_frete,
        CASE
            WHEN (prazo_visao_simples <= 3) THEN 'express'::text
            WHEN (prazo_visao_simples <= 7) THEN 'normal'::text
            ELSE 'economico'::text
        END AS badge_prazo,
    ativo,
    created_at
   FROM core.fornecedores f
  WHERE ((ativo = true) AND (deleted_at IS NULL))
  ORDER BY prazo_visao_simples, nome;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |
| public     | v_fornecedores_por_lente     |  SELECT l.id AS lente_id,
    l.nome_lente AS lente_nome,
    l.slug AS lente_slug,
    l.tipo_lente,
    l.material,
    l.indice_refracao,
    f.id AS fornecedor_id,
    f.nome AS fornecedor_nome,
    f.razao_social AS fornecedor_razao_social,
    f.cnpj,
    l.preco_custo,
    COALESCE(l.lead_time_dias,
        CASE l.tipo_lente
            WHEN 'visao_simples'::lens_catalog.tipo_lente THEN f.prazo_visao_simples
            WHEN 'multifocal'::lens_catalog.tipo_lente THEN f.prazo_multifocal
            WHEN 'bifocal'::lens_catalog.tipo_lente THEN f.prazo_multifocal
            WHEN 'leitura'::lens_catalog.tipo_lente THEN f.prazo_visao_simples
            WHEN 'ocupacional'::lens_catalog.tipo_lente THEN f.prazo_multifocal
            ELSE 10
        END) AS prazo_entrega_dias,
    m.nome AS marca_nome,
    m.is_premium AS marca_premium,
    l.ativo AS lente_ativa,
    f.ativo AS fornecedor_ativo,
    row_number() OVER (PARTITION BY l.id ORDER BY COALESCE(l.lead_time_dias,
        CASE l.tipo_lente
            WHEN 'visao_simples'::lens_catalog.tipo_lente THEN f.prazo_visao_simples
            WHEN 'multifocal'::lens_catalog.tipo_lente THEN f.prazo_multifocal
            WHEN 'bifocal'::lens_catalog.tipo_lente THEN f.prazo_multifocal
            WHEN 'leitura'::lens_catalog.tipo_lente THEN f.prazo_visao_simples
            WHEN 'ocupacional'::lens_catalog.tipo_lente THEN f.prazo_multifocal
            ELSE 10
        END), l.preco_custo) AS ranking_fornecedor
   FROM ((lens_catalog.lentes l
     JOIN core.fornecedores f ON ((f.id = l.fornecedor_id)))
     LEFT JOIN lens_catalog.marcas m ON ((m.id = l.marca_id)))
  WHERE ((l.ativo = true) AND (f.ativo = true))
  ORDER BY l.nome_lente, COALESCE(l.lead_time_dias,
        CASE l.tipo_lente
            WHEN 'visao_simples'::lens_catalog.tipo_lente THEN f.prazo_visao_simples
            WHEN 'multifocal'::lens_catalog.tipo_lente THEN f.prazo_multifocal
            WHEN 'bifocal'::lens_catalog.tipo_lente THEN f.prazo_multifocal
            WHEN 'leitura'::lens_catalog.tipo_lente THEN f.prazo_visao_simples
            WHEN 'ocupacional'::lens_catalog.tipo_lente THEN f.prazo_multifocal
            ELSE 10
        END);                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |
| public     | v_grupos_canonicos           |  SELECT id,
    slug,
    nome_grupo,
    tipo_lente,
    material,
    indice_refracao,
    categoria_predominante,
    grau_esferico_min,
    grau_esferico_max,
    grau_cilindrico_min,
    grau_cilindrico_max,
    adicao_min,
    adicao_max,
    descricao_ranges,
    tratamento_antirreflexo,
    tratamento_antirrisco,
    tratamento_uv,
    tratamento_blue_light,
    tratamento_fotossensiveis,
    preco_minimo,
    preco_maximo,
    preco_medio,
    total_lentes,
    total_marcas,
    peso,
    is_premium
   FROM lens_catalog.grupos_canonicos gc
  WHERE ((ativo = true) AND (is_premium = false))
  ORDER BY preco_medio;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                |
| public     | v_grupos_canonicos_completos |  SELECT id,
    nome_grupo,
    tipo_lente,
    material,
    indice_refracao,
    preco_medio,
    ( SELECT jsonb_agg(jsonb_build_object('id', l.id, 'nome', f.nome, 'prazo_visao_simples', COALESCE(f.prazo_visao_simples, 0), 'prazo_multifocal', COALESCE(f.prazo_multifocal, 2))) AS jsonb_agg
           FROM (lens_catalog.lentes l
             JOIN core.fornecedores f ON ((l.fornecedor_id = f.id)))
          WHERE (l.grupo_canonico_id = gc.id)) AS fornecedores_disponiveis,
    ( SELECT count(*) AS count
           FROM lens_catalog.lentes l
          WHERE (l.grupo_canonico_id = gc.id)) AS total_lentes,
    false AS is_premium
   FROM lens_catalog.grupos_canonicos gc;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
| public     | v_grupos_com_lentes          |  SELECT id AS grupo_id,
    slug AS grupo_slug,
    nome_grupo,
    tipo_lente,
    material,
    indice_refracao,
    preco_medio,
    preco_minimo,
    preco_maximo,
    ( SELECT jsonb_agg(jsonb_build_object('id', l.id, 'slug', l.slug, 'nome', l.nome_canonizado, 'fornecedor_id', f.id, 'fornecedor_nome', f.nome, 'marca', m.nome, 'preco', l.preco_venda_sugerido, 'prazo_dias', f.prazo_visao_simples, 'estoque', COALESCE(es.quantidade_disponivel, 0), 'tratamentos', jsonb_build_object('ar', l.tratamento_antirreflexo, 'antirrisco', l.tratamento_antirrisco, 'uv', l.tratamento_uv, 'blue_light', l.tratamento_blue_light, 'foto', l.tratamento_fotossensiveis)) ORDER BY l.preco_venda_sugerido) AS jsonb_agg
           FROM (((lens_catalog.lentes l
             JOIN core.fornecedores f ON ((l.fornecedor_id = f.id)))
             LEFT JOIN lens_catalog.marcas m ON ((l.marca_id = m.id)))
             LEFT JOIN compras.estoque_saldo es ON ((l.id = es.lente_id)))
          WHERE ((l.grupo_canonico_id = gc.id) AND (l.ativo = true) AND (l.status = 'ativo'::lens_catalog.status_lente))) AS lentes
   FROM lens_catalog.grupos_canonicos gc
  WHERE (EXISTS ( SELECT 1
           FROM lens_catalog.lentes l
          WHERE ((l.grupo_canonico_id = gc.id) AND (l.ativo = true))))
  ORDER BY is_premium DESC, preco_medio;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
| public     | v_grupos_melhor_margem       |  WITH margem_calculada AS (
         SELECT gc.id AS grupo_id,
            gc.slug AS grupo_slug,
            gc.nome_grupo,
            gc.tipo_lente,
            gc.material,
            gc.indice_refracao,
            gc.tratamento_antirreflexo,
            gc.tratamento_antirrisco,
            gc.tratamento_uv,
            gc.tratamento_blue_light,
            gc.tratamento_fotossensiveis,
            gc.preco_minimo,
            gc.preco_medio,
            gc.preco_maximo,
            avg(l.preco_custo) AS custo_medio,
            min(l.preco_custo) AS custo_minimo,
            max(l.preco_custo) AS custo_maximo,
                CASE
                    WHEN (avg(l.preco_custo) > (0)::numeric) THEN ((((gc.preco_medio - avg(l.preco_custo)) / avg(l.preco_custo)) * (100)::numeric))::numeric(8,2)
                    ELSE (0)::numeric
                END AS margem_percentual,
            ((gc.preco_medio - avg(l.preco_custo)))::numeric(10,2) AS lucro_unitario,
                CASE
                    WHEN (avg(l.preco_custo) > (0)::numeric) THEN ((gc.preco_medio / avg(l.preco_custo)))::numeric(6,2)
                    ELSE NULL::numeric
                END AS markup,
            gc.total_lentes,
            gc.is_premium,
            count(DISTINCT l.marca_id) AS total_marcas,
            count(DISTINCT l.fornecedor_id) AS total_fornecedores
           FROM (lens_catalog.grupos_canonicos gc
             JOIN lens_catalog.lentes l ON (((l.grupo_canonico_id = gc.id) AND (l.ativo = true))))
          GROUP BY gc.id, gc.slug, gc.nome_grupo, gc.tipo_lente, gc.material, gc.indice_refracao, gc.tratamento_antirreflexo, gc.tratamento_antirrisco, gc.tratamento_uv, gc.tratamento_blue_light, gc.tratamento_fotossensiveis, gc.preco_minimo, gc.preco_medio, gc.preco_maximo, gc.total_lentes, gc.is_premium
        )
 SELECT grupo_id,
    grupo_slug,
    nome_grupo,
    tipo_lente,
    material,
    indice_refracao,
    tratamento_antirreflexo,
    tratamento_antirrisco,
    tratamento_uv,
    tratamento_blue_light,
    tratamento_fotossensiveis,
    preco_minimo,
    preco_medio,
    preco_maximo,
    custo_medio,
    custo_minimo,
    custo_maximo,
    margem_percentual,
    lucro_unitario,
    markup,
    total_lentes,
    is_premium,
    total_marcas,
    total_fornecedores,
    row_number() OVER (ORDER BY margem_percentual DESC) AS ranking_margem,
    row_number() OVER (PARTITION BY tipo_lente ORDER BY margem_percentual DESC) AS ranking_por_tipo,
        CASE
            WHEN (margem_percentual >= (400)::numeric) THEN 'Excelente'::text
            WHEN (margem_percentual >= (350)::numeric) THEN 'Ã“tima'::text
            WHEN (margem_percentual >= (300)::numeric) THEN 'Boa'::text
            ELSE 'Regular'::text
        END AS classificacao_margem,
        CASE
            WHEN (markup >= 4.0) THEN true
            ELSE false
        END AS acima_markup_padrao
   FROM margem_calculada
  ORDER BY margem_percentual DESC;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
| public     | v_grupos_por_faixa_preco     |  SELECT id AS grupo_id,
    slug AS grupo_slug,
    nome_grupo,
    tipo_lente,
    material,
    indice_refracao,
    tratamento_antirreflexo,
    tratamento_antirrisco,
    tratamento_uv,
    tratamento_blue_light,
    tratamento_fotossensiveis,
    preco_minimo,
    preco_medio,
    preco_maximo,
        CASE
            WHEN (preco_medio < (150)::numeric) THEN '< R$150'::text
            WHEN ((preco_medio >= (150)::numeric) AND (preco_medio < (300)::numeric)) THEN 'R$150-300'::text
            WHEN ((preco_medio >= (300)::numeric) AND (preco_medio < (500)::numeric)) THEN 'R$300-500'::text
            WHEN ((preco_medio >= (500)::numeric) AND (preco_medio < (800)::numeric)) THEN 'R$500-800'::text
            ELSE 'R$800+'::text
        END AS faixa_preco,
        CASE
            WHEN (preco_medio < (150)::numeric) THEN 1
            WHEN ((preco_medio >= (150)::numeric) AND (preco_medio < (300)::numeric)) THEN 2
            WHEN ((preco_medio >= (300)::numeric) AND (preco_medio < (500)::numeric)) THEN 3
            WHEN ((preco_medio >= (500)::numeric) AND (preco_medio < (800)::numeric)) THEN 4
            ELSE 5
        END AS faixa_ordem,
        CASE
            WHEN (preco_medio < (150)::numeric) THEN 'R$150-300'::text
            WHEN ((preco_medio >= (150)::numeric) AND (preco_medio < (300)::numeric)) THEN 'R$300-500'::text
            WHEN ((preco_medio >= (300)::numeric) AND (preco_medio < (500)::numeric)) THEN 'R$500-800'::text
            WHEN ((preco_medio >= (500)::numeric) AND (preco_medio < (800)::numeric)) THEN 'R$800+'::text
            ELSE NULL::text
        END AS proxima_faixa,
        CASE
            WHEN (preco_medio < (150)::numeric) THEN 'Entrada'::text
            WHEN ((preco_medio >= (150)::numeric) AND (preco_medio < (300)::numeric)) THEN 'BÃ¡sico'::text
            WHEN ((preco_medio >= (300)::numeric) AND (preco_medio < (500)::numeric)) THEN 'IntermediÃ¡rio'::text
            WHEN ((preco_medio >= (500)::numeric) AND (preco_medio < (800)::numeric)) THEN 'Premium'::text
            ELSE 'Super Premium'::text
        END AS descricao_faixa,
    total_lentes,
    is_premium,
    ( SELECT count(DISTINCT lentes.marca_id) AS count
           FROM lens_catalog.lentes
          WHERE ((lentes.grupo_canonico_id = gc.id) AND (lentes.ativo = true))) AS total_marcas,
    ( SELECT count(DISTINCT lentes.fornecedor_id) AS count
           FROM lens_catalog.lentes
          WHERE ((lentes.grupo_canonico_id = gc.id) AND (lentes.ativo = true))) AS total_fornecedores
   FROM lens_catalog.grupos_canonicos gc
  ORDER BY preco_medio;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |
| public     | v_grupos_por_receita_cliente |  SELECT gc.id AS grupo_id,
    gc.slug AS grupo_slug,
    gc.nome_grupo,
    gc.tipo_lente,
    gc.material,
    gc.indice_refracao,
    min(l.grau_esferico_min) AS grau_esferico_min,
    max(l.grau_esferico_max) AS grau_esferico_max,
    min(l.grau_cilindrico_min) AS grau_cilindrico_min,
    max(l.grau_cilindrico_max) AS grau_cilindrico_max,
    min(l.adicao_min) AS adicao_min,
    max(l.adicao_max) AS adicao_max,
    gc.tratamento_antirreflexo,
    gc.tratamento_antirrisco,
    gc.tratamento_uv,
    gc.tratamento_blue_light,
    gc.tratamento_fotossensiveis,
    gc.preco_minimo,
    gc.preco_medio,
    gc.preco_maximo,
    avg(l.preco_custo) AS custo_medio,
        CASE
            WHEN (avg(l.preco_custo) > (0)::numeric) THEN ((gc.preco_medio / avg(l.preco_custo)))::numeric(5,2)
            ELSE NULL::numeric
        END AS margem_media,
        CASE
            WHEN (gc.preco_medio < (150)::numeric) THEN 'economica'::text
            WHEN ((gc.preco_medio >= (150)::numeric) AND (gc.preco_medio <= (400)::numeric)) THEN 'intermediaria'::text
            ELSE 'premium'::text
        END AS categoria_sugerida,
    gc.total_lentes,
    count(DISTINCT l.fornecedor_id) AS total_fornecedores,
    count(DISTINCT l.marca_id) AS total_marcas,
    gc.is_premium,
    (avg(
        CASE gc.tipo_lente
            WHEN 'visao_simples'::lens_catalog.tipo_lente THEN COALESCE(f.prazo_visao_simples, 7)
            WHEN 'multifocal'::lens_catalog.tipo_lente THEN COALESCE(f.prazo_multifocal, 10)
            WHEN 'bifocal'::lens_catalog.tipo_lente THEN COALESCE(f.prazo_multifocal, 10)
            WHEN 'leitura'::lens_catalog.tipo_lente THEN COALESCE(f.prazo_visao_simples, 7)
            WHEN 'ocupacional'::lens_catalog.tipo_lente THEN COALESCE(f.prazo_multifocal, 10)
            ELSE 10
        END))::integer AS prazo_medio_dias
   FROM ((lens_catalog.grupos_canonicos gc
     JOIN lens_catalog.lentes l ON (((l.grupo_canonico_id = gc.id) AND (l.ativo = true))))
     LEFT JOIN core.fornecedores f ON ((f.id = l.fornecedor_id)))
  GROUP BY gc.id, gc.slug, gc.nome_grupo, gc.tipo_lente, gc.material, gc.indice_refracao, gc.tratamento_antirreflexo, gc.tratamento_antirrisco, gc.tratamento_uv, gc.tratamento_blue_light, gc.tratamento_fotossensiveis, gc.preco_minimo, gc.preco_medio, gc.preco_maximo, gc.total_lentes, gc.is_premium
  ORDER BY gc.preco_medio;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |
| public     | v_grupos_premium             |  SELECT id,
    slug,
    nome_grupo,
    tipo_lente,
    material,
    indice_refracao,
    categoria_predominante,
    grau_esferico_min,
    grau_esferico_max,
    grau_cilindrico_min,
    grau_cilindrico_max,
    adicao_min,
    adicao_max,
    descricao_ranges,
    tratamento_antirreflexo,
    tratamento_antirrisco,
    tratamento_uv,
    tratamento_blue_light,
    tratamento_fotossensiveis,
    preco_minimo,
    preco_maximo,
    preco_medio,
    total_lentes,
    total_marcas,
    peso,
    is_premium,
    COALESCE(( SELECT jsonb_agg(DISTINCT jsonb_build_object('marca_id', m.id, 'marca_nome', m.nome, 'marca_slug', m.slug, 'is_premium', m.is_premium)) AS jsonb_agg
           FROM (lens_catalog.lentes l
             JOIN lens_catalog.marcas m ON ((m.id = l.marca_id)))
          WHERE ((l.grupo_canonico_id = gc.id) AND (l.ativo = true) AND (m.ativo = true))), '[]'::jsonb) AS marcas_disponiveis,
    COALESCE(( SELECT string_agg(DISTINCT (m.nome)::text, ', '::text ORDER BY (m.nome)::text) AS string_agg
           FROM (lens_catalog.lentes l
             JOIN lens_catalog.marcas m ON ((m.id = l.marca_id)))
          WHERE ((l.grupo_canonico_id = gc.id) AND (l.ativo = true) AND (m.ativo = true))), ''::text) AS marcas_nomes
   FROM lens_catalog.grupos_canonicos gc
  WHERE ((ativo = true) AND (is_premium = true))
  ORDER BY preco_medio;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
| public     | v_lentes_busca               |  SELECT l.id,
    l.slug,
    l.nome_canonizado AS nome,
    f.nome AS fornecedor,
    m.nome AS marca,
    l.tipo_lente,
    l.material,
    l.indice_refracao,
    l.categoria,
    l.preco_venda_sugerido AS preco,
    l.tratamento_antirreflexo AS tem_ar,
    l.tratamento_blue_light AS tem_blue,
    l.tratamento_fotossensiveis AS tratamento_foto,
    gc.nome_grupo,
    l.peso,
    ((((((((((l.nome_canonizado || ' '::text) || f.nome) || ' '::text) || (COALESCE(m.nome, ''::character varying))::text) || ' '::text) || (l.tipo_lente)::text) || ' '::text) || (l.material)::text) || ' '::text) || (l.indice_refracao)::text) AS search_text
   FROM (((lens_catalog.lentes l
     JOIN core.fornecedores f ON ((l.fornecedor_id = f.id)))
     LEFT JOIN lens_catalog.marcas m ON ((l.marca_id = m.id)))
     LEFT JOIN lens_catalog.grupos_canonicos gc ON ((l.grupo_canonico_id = gc.id)))
  WHERE ((l.ativo = true) AND (l.status = 'ativo'::lens_catalog.status_lente) AND (l.deleted_at IS NULL));                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           |
| public     | v_lentes_catalogo            |  SELECT l.id,
    l.slug,
    l.nome_lente,
    l.nome_canonizado,
    f.id AS fornecedor_id,
    f.nome AS fornecedor_nome,
    f.prazo_visao_simples,
    f.prazo_multifocal,
    f.prazo_surfacada,
    f.prazo_free_form,
    m.id AS marca_id,
    m.nome AS marca_nome,
    m.slug AS marca_slug,
    m.is_premium AS marca_premium,
    gc.id AS grupo_id,
    gc.nome_grupo,
    gc.slug AS grupo_slug,
    l.tipo_lente,
    l.material,
    l.indice_refracao,
    l.categoria,
    l.tratamento_antirreflexo,
    l.tratamento_antirrisco,
    l.tratamento_uv,
    l.tratamento_blue_light,
    l.tratamento_fotossensiveis,
    l.diametro_mm,
    l.curva_base,
    l.espessura_centro_mm,
    l.grau_esferico_min,
    l.grau_esferico_max,
    l.grau_cilindrico_min,
    l.grau_cilindrico_max,
    l.adicao_min,
    l.adicao_max,
    l.preco_custo,
    l.preco_venda_sugerido,
    l.margem_lucro,
    COALESCE(es.quantidade_disponivel, 0) AS estoque_disponivel,
    COALESCE(es.quantidade_reservada, 0) AS estoque_reservado,
    l.status,
    l.ativo,
    l.peso,
    l.metadata,
    l.created_at,
    l.updated_at
   FROM ((((lens_catalog.lentes l
     JOIN core.fornecedores f ON ((l.fornecedor_id = f.id)))
     LEFT JOIN lens_catalog.marcas m ON ((l.marca_id = m.id)))
     LEFT JOIN lens_catalog.grupos_canonicos gc ON ((l.grupo_canonico_id = gc.id)))
     LEFT JOIN compras.estoque_saldo es ON ((l.id = es.lente_id)))
  WHERE ((l.ativo = true) AND (l.deleted_at IS NULL))
  ORDER BY l.peso DESC, l.preco_venda_sugerido;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
| public     | v_lentes_cotacao_compra      |  SELECT l.id AS lente_id,
    l.slug AS lente_slug,
    l.nome_lente AS lente_nome,
    l.nome_canonizado,
    l.tipo_lente,
    l.material,
    l.indice_refracao,
    l.fornecedor_id,
    f.nome AS fornecedor_nome,
    l.marca_id,
    m.nome AS marca_nome,
    l.preco_custo,
    COALESCE(l.lead_time_dias,
        CASE l.tipo_lente
            WHEN 'visao_simples'::lens_catalog.tipo_lente THEN f.prazo_visao_simples
            WHEN 'multifocal'::lens_catalog.tipo_lente THEN f.prazo_multifocal
            WHEN 'bifocal'::lens_catalog.tipo_lente THEN f.prazo_multifocal
            WHEN 'leitura'::lens_catalog.tipo_lente THEN f.prazo_visao_simples
            WHEN 'ocupacional'::lens_catalog.tipo_lente THEN f.prazo_multifocal
            ELSE 10
        END) AS prazo_dias,
    l.ativo,
    l.categoria,
    l.grupo_canonico_id
   FROM ((lens_catalog.lentes l
     JOIN core.fornecedores f ON ((f.id = l.fornecedor_id)))
     LEFT JOIN lens_catalog.marcas m ON ((m.id = l.marca_id)))
  WHERE ((l.ativo = true) AND (f.ativo = true))
  ORDER BY l.nome_lente;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
| public     | v_pedidos_pendentes          |  SELECT p.id,
    p.numero_pedido,
    f.nome AS fornecedor_nome,
    p.status,
    p.data_pedido,
    p.data_previsao_entrega,
    p.valor_total,
        CASE
            WHEN (p.data_previsao_entrega IS NOT NULL) THEN (EXTRACT(day FROM (p.data_previsao_entrega - now())))::integer
            ELSE NULL::integer
        END AS dias_ate_entrega,
        CASE
            WHEN ((p.status = 'enviado_fornecedor'::compras.status_pedido) AND (p.data_previsao_entrega < now())) THEN 'atrasado'::text
            WHEN (p.status = 'enviado_fornecedor'::compras.status_pedido) THEN 'em_transito'::text
            WHEN (p.status = ANY (ARRAY['confirmado'::compras.status_pedido, 'em_producao'::compras.status_pedido])) THEN 'processando'::text
            ELSE 'pendente'::text
        END AS status_visual,
    ( SELECT count(*) AS count
           FROM compras.pedido_itens
          WHERE (pedido_itens.pedido_id = p.id)) AS total_itens,
    ( SELECT sum(pedido_itens.quantidade) AS sum
           FROM compras.pedido_itens
          WHERE (pedido_itens.pedido_id = p.id)) AS total_quantidade,
    p.codigo_rastreio,
    p.created_at
   FROM (compras.pedidos p
     JOIN core.fornecedores f ON ((p.fornecedor_id = f.id)))
  WHERE ((p.status <> ALL (ARRAY['recebido'::compras.status_pedido, 'cancelado'::compras.status_pedido])) AND (p.deleted_at IS NULL))
  ORDER BY p.data_previsao_entrega, p.created_at DESC;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |
| public     | v_sugestoes_upgrade          |  WITH grupos_base AS (
         SELECT gc.id,
            gc.nome_grupo,
            gc.tipo_lente,
            gc.material,
            gc.indice_refracao,
            gc.preco_medio,
            gc.tratamento_antirreflexo,
            gc.tratamento_antirrisco,
            gc.tratamento_uv,
            gc.tratamento_blue_light,
            gc.tratamento_fotossensiveis,
            ((((
                CASE
                    WHEN gc.tratamento_antirreflexo THEN 1
                    ELSE 0
                END +
                CASE
                    WHEN gc.tratamento_antirrisco THEN 1
                    ELSE 0
                END) +
                CASE
                    WHEN gc.tratamento_uv THEN 1
                    ELSE 0
                END) +
                CASE
                    WHEN gc.tratamento_blue_light THEN 1
                    ELSE 0
                END) +
                CASE
                    WHEN (gc.tratamento_fotossensiveis <> 'nenhum'::text) THEN 1
                    ELSE 0
                END) AS total_tratamentos
           FROM lens_catalog.grupos_canonicos gc
        )
 SELECT gb.id AS grupo_base_id,
    gb.nome_grupo AS grupo_base_nome,
    gb.preco_medio AS preco_base,
    gb.total_tratamentos AS tratamentos_base,
    gu.id AS grupo_upgrade_id,
    gu.nome_grupo AS grupo_upgrade_nome,
    gu.preco_medio AS preco_upgrade,
    gu.total_tratamentos AS tratamentos_upgrade,
    ((gu.preco_medio - gb.preco_medio))::numeric(10,2) AS diferenca_preco,
    ((((gu.preco_medio - gb.preco_medio) / gb.preco_medio) * (100)::numeric))::numeric(5,2) AS diferenca_percentual,
    array_remove(ARRAY[
        CASE
            WHEN (gu.tratamento_antirreflexo AND (NOT gb.tratamento_antirreflexo)) THEN 'Antirreflexo'::text
            ELSE NULL::text
        END,
        CASE
            WHEN (gu.tratamento_antirrisco AND (NOT gb.tratamento_antirrisco)) THEN 'Antirrisco'::text
            ELSE NULL::text
        END,
        CASE
            WHEN (gu.tratamento_uv AND (NOT gb.tratamento_uv)) THEN 'ProteÃ§Ã£o UV'::text
            ELSE NULL::text
        END,
        CASE
            WHEN (gu.tratamento_blue_light AND (NOT gb.tratamento_blue_light)) THEN 'Filtro Luz Azul'::text
            ELSE NULL::text
        END,
        CASE
            WHEN ((gu.tratamento_fotossensiveis <> 'nenhum'::text) AND (gb.tratamento_fotossensiveis = 'nenhum'::text)) THEN (('FotossensÃ­vel ('::text || gu.tratamento_fotossensiveis) || ')'::text)
            ELSE NULL::text
        END], NULL::text) AS tratamentos_adicionais,
        CASE
            WHEN (gu.tratamento_blue_light AND (NOT gb.tratamento_blue_light)) THEN 'ProteÃ§Ã£o contra luz azul de telas + maior conforto visual'::text
            WHEN (gu.tratamento_antirreflexo AND (NOT gb.tratamento_antirreflexo)) THEN 'VisÃ£o mais nÃ­tida e sem reflexos + estÃ©tica melhor'::text
            WHEN ((gu.tratamento_fotossensiveis <> 'nenhum'::text) AND (gb.tratamento_fotossensiveis = 'nenhum'::text)) THEN 'AdaptaÃ§Ã£o automÃ¡tica Ã  luminosidade + proteÃ§Ã£o solar'::text
            ELSE 'ProteÃ§Ã£o e durabilidade superiores'::text
        END AS beneficios,
    gb.tipo_lente,
    gb.material,
    gb.indice_refracao,
    (gu.total_tratamentos - gb.total_tratamentos) AS tratamentos_extras_count
   FROM (grupos_base gb
     JOIN grupos_base gu ON (((gu.tipo_lente = gb.tipo_lente) AND (gu.material = gb.material) AND (gu.indice_refracao = gb.indice_refracao) AND (gu.total_tratamentos > gb.total_tratamentos) AND (gu.preco_medio > gb.preco_medio) AND (gu.preco_medio <= (gb.preco_medio * (2)::numeric)) AND (gu.id <> gb.id))))
  ORDER BY gb.preco_medio, (((gu.preco_medio - gb.preco_medio))::numeric(10,2));                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
| public     | vw_bi_lentes_lucratividade   |  SELECT COALESCE(m.nome, 'Indefinido'::character varying) AS marca,
    COALESCE((l.categoria)::text, 'Geral'::text) AS categoria,
    count(*) AS qtd_produtos,
    (avg(l.custo_base))::numeric(10,2) AS custo_medio,
    (avg(l.preco_tabela))::numeric(10,2) AS preco_medio
   FROM (lens_catalog.lentes l
     LEFT JOIN lens_catalog.marcas m ON ((l.marca_id = m.id)))
  WHERE (l.custo_base > (0)::numeric)
  GROUP BY m.nome, l.categoria;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |
| public     | vw_canonicas_genericas       |  SELECT lc.id,
    lc.nome_canonico,
    lc.descricao,
    lc.tipo_lente,
    lc.material,
    lc.indice_refracao,
    lc.categoria,
    lc.ar,
    lc.blue,
    lc.fotossensivel,
    lc.polarizado,
    lc.esferico_min,
    lc.esferico_max,
    lc.cilindrico_min,
    lc.cilindrico_max,
    lc.adicao_min,
    lc.adicao_max,
    lc.total_lentes,
    lc.preco_minimo,
    lc.preco_maximo,
    lc.preco_medio,
    count(l.id) AS lentes_ativas,
    count(DISTINCT l.marca_id) AS total_marcas,
    array_agg(DISTINCT m.nome ORDER BY m.nome) FILTER (WHERE (m.nome IS NOT NULL)) AS marcas_disponiveis,
    lc.ativo,
    lc.created_at,
    lc.updated_at
   FROM ((lens_catalog.lentes_canonicas lc
     LEFT JOIN lens_catalog.lentes l ON (((l.lente_canonica_id = lc.id) AND (l.status = 'ativo'::lens_catalog.status_lente))))
     LEFT JOIN lens_catalog.marcas m ON ((l.marca_id = m.id)))
  WHERE (lc.ativo = true)
  GROUP BY lc.id, lc.nome_canonico, lc.descricao, lc.tipo_lente, lc.material, lc.indice_refracao, lc.categoria, lc.ar, lc.blue, lc.fotossensivel, lc.polarizado, lc.esferico_min, lc.esferico_max, lc.cilindrico_min, lc.cilindrico_max, lc.adicao_min, lc.adicao_max, lc.total_lentes, lc.preco_minimo, lc.preco_maximo, lc.preco_medio, lc.ativo, lc.created_at, lc.updated_at
  ORDER BY lc.nome_canonico;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |
| public     | vw_canonicas_premium         |  SELECT pc.id,
    pc.marca_id,
    pc.linha_produto,
    pc.nome_canonico,
    pc.descricao,
    pc.tipo_lente,
    pc.material,
    pc.indice_refracao,
    pc.categoria,
    m.nome AS marca_nome,
    m.slug AS marca_slug,
    m.is_premium AS marca_premium,
    pc.ar,
    pc.blue,
    pc.fotossensivel,
    pc.polarizado,
    pc.esferico_min,
    pc.esferico_max,
    pc.cilindrico_min,
    pc.cilindrico_max,
    pc.adicao_min,
    pc.adicao_max,
    pc.total_lentes,
    pc.preco_minimo,
    pc.preco_maximo,
    pc.preco_medio,
    count(l.id) AS lentes_ativas,
    pc.ativo,
    pc.created_at,
    pc.updated_at
   FROM ((lens_catalog.premium_canonicas pc
     LEFT JOIN lens_catalog.marcas m ON ((pc.marca_id = m.id)))
     LEFT JOIN lens_catalog.lentes l ON (((l.premium_canonica_id = pc.id) AND (l.status = 'ativo'::lens_catalog.status_lente))))
  WHERE (pc.ativo = true)
  GROUP BY pc.id, pc.marca_id, pc.linha_produto, pc.nome_canonico, pc.descricao, pc.tipo_lente, pc.material, pc.indice_refracao, pc.categoria, m.nome, m.slug, m.is_premium, pc.ar, pc.blue, pc.fotossensivel, pc.polarizado, pc.esferico_min, pc.esferico_max, pc.cilindrico_min, pc.cilindrico_max, pc.adicao_min, pc.adicao_max, pc.total_lentes, pc.preco_minimo, pc.preco_maximo, pc.preco_medio, pc.ativo, pc.created_at, pc.updated_at
  ORDER BY m.nome, pc.nome_canonico;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |
| public     | vw_detalhes_premium          |  SELECT pc.id AS canonica_id,
    pc.nome_canonico,
    pc.linha_produto AS canonica_linha,
    pc.tipo_lente AS canonica_tipo_lente,
    pc.material AS canonica_material,
    pc.indice_refracao AS canonica_indice,
    l.id AS lente_id,
    l.sku_fornecedor,
    l.codigo_original,
    l.nome_comercial,
    l.linha_produto,
    l.categoria,
    l.material,
    l.indice_refracao,
    m.id AS marca_id,
    m.nome AS marca_nome,
    m.slug AS marca_slug,
    m.is_premium AS marca_premium,
    l.ar,
    l.antirrisco,
    l.hidrofobico,
    l."antiembaÃ§ante",
    l.blue,
    l.uv400,
    l.fotossensivel,
    l.polarizado,
    l.digital,
    l.free_form,
    l.indoor,
    l.drive,
    l.esferico_min,
    l.esferico_max,
    l.cilindrico_min,
    l.cilindrico_max,
    l.adicao_min,
    l.adicao_max,
    l.diametro,
    l.espessura_central,
    l.custo_base,
    l.preco_tabela,
    l.preco_fabricante,
    l.disponivel,
    l.prazo_entrega,
    l.obs_prazo,
    l.destaque,
    l.novidade,
    l.descricao_curta,
    l.beneficios
   FROM ((lens_catalog.premium_canonicas pc
     JOIN lens_catalog.lentes l ON ((l.premium_canonica_id = pc.id)))
     JOIN lens_catalog.marcas m ON ((l.marca_id = m.id)))
  WHERE ((pc.ativo = true) AND (l.status = 'ativo'::lens_catalog.status_lente) AND (l.disponivel = true))
  ORDER BY pc.nome_canonico, m.nome, l.preco_tabela;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                |
| public     | vw_lentes_catalogo           |  SELECT l.id,
    l.marca_id,
    l.fornecedor_id,
    l.lente_canonica_id,
    l.premium_canonica_id,
    l.sku_fornecedor,
    l.codigo_original,
    l.nome_comercial,
    m.nome AS marca_nome,
    m.slug AS marca_slug,
    m.is_premium AS marca_premium,
    l.tipo_lente,
    l.categoria,
    l.material,
    l.indice_refracao,
    l.linha_produto,
    l.diametro,
    l.espessura_central,
    l.peso_aproximado,
    l.esferico_min,
    l.esferico_max,
    l.cilindrico_min,
    l.cilindrico_max,
    l.adicao_min,
    l.adicao_max,
    l.dnp_min,
    l.dnp_max,
    l.ar,
    l.antirrisco,
    l.hidrofobico,
    l."antiembaÃ§ante",
    l.blue,
    l.uv400,
    l.fotossensivel,
    l.polarizado,
    l.digital,
    l.free_form,
    l.indoor,
    l.drive,
    l.custo_base,
    l.preco_fabricante,
    l.preco_tabela,
    l.prazo_entrega,
    l.obs_prazo,
    l.peso_frete,
    l.exige_receita_especial,
    l.descricao_curta,
    l.descricao_completa,
    l.beneficios,
    l.indicacoes,
    l.contraindicacoes,
    l.observacoes,
    l.status,
    l.disponivel,
    l.destaque,
    l.novidade,
    l.data_lancamento,
    l.data_descontinuacao,
    l.created_at,
    l.updated_at
   FROM (lens_catalog.lentes l
     LEFT JOIN lens_catalog.marcas m ON ((l.marca_id = m.id)))
  WHERE (l.status = 'ativo'::lens_catalog.status_lente)
  ORDER BY l.created_at DESC;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |
| public     | vw_stats_catalogo            |  SELECT ( SELECT count(*) AS count
           FROM lens_catalog.lentes
          WHERE ((lentes.ativo = true) AND (lentes.deleted_at IS NULL))) AS total_lentes,
    ( SELECT count(*) AS count
           FROM lens_catalog.lentes
          WHERE ((lentes.ativo = true) AND (lentes.deleted_at IS NULL) AND (lentes.grupo_canonico_id IS NOT NULL))) AS lentes_genericas,
    ( SELECT count(*) AS count
           FROM lens_catalog.lentes
          WHERE ((lentes.ativo = true) AND (lentes.deleted_at IS NULL) AND (lentes.categoria = 'economica'::lens_catalog.categoria_lente))) AS lentes_economicas,
    ( SELECT count(*) AS count
           FROM lens_catalog.lentes
          WHERE ((lentes.ativo = true) AND (lentes.deleted_at IS NULL) AND (lentes.categoria = 'intermediaria'::lens_catalog.categoria_lente))) AS lentes_intermediarias,
    ( SELECT count(*) AS count
           FROM lens_catalog.lentes
          WHERE ((lentes.ativo = true) AND (lentes.deleted_at IS NULL) AND (lentes.categoria = 'premium'::lens_catalog.categoria_lente))) AS lentes_premium,
    ( SELECT count(*) AS count
           FROM lens_catalog.lentes
          WHERE ((lentes.ativo = true) AND (lentes.deleted_at IS NULL) AND (lentes.categoria = 'super_premium'::lens_catalog.categoria_lente))) AS lentes_super_premium,
    ( SELECT count(*) AS count
           FROM lens_catalog.grupos_canonicos
          WHERE (grupos_canonicos.ativo = true)) AS grupos_genericos,
    ( SELECT count(*) AS count
           FROM lens_catalog.grupos_canonicos
          WHERE ((grupos_canonicos.ativo = true) AND (grupos_canonicos.is_premium = false))) AS grupos_standard,
    ( SELECT count(*) AS count
           FROM lens_catalog.grupos_canonicos
          WHERE ((grupos_canonicos.ativo = true) AND (grupos_canonicos.is_premium = true))) AS grupos_premium,
    ( SELECT count(*) AS count
           FROM lens_catalog.marcas
          WHERE (marcas.ativo = true)) AS total_marcas,
    ( SELECT count(*) AS count
           FROM lens_catalog.marcas
          WHERE ((marcas.ativo = true) AND (marcas.is_premium = false))) AS marcas_standard,
    ( SELECT count(*) AS count
           FROM lens_catalog.marcas
          WHERE ((marcas.ativo = true) AND (marcas.is_premium = true))) AS marcas_premium,
    ( SELECT count(*) AS count
           FROM core.fornecedores
          WHERE (fornecedores.ativo = true)) AS total_fornecedores,
    ( SELECT count(*) AS count
           FROM lens_catalog.lentes
          WHERE ((lentes.ativo = true) AND (lentes.deleted_at IS NULL) AND (lentes.tratamento_antirreflexo = true))) AS total_com_ar,
    ( SELECT count(*) AS count
           FROM lens_catalog.lentes
          WHERE ((lentes.ativo = true) AND (lentes.deleted_at IS NULL) AND (lentes.tratamento_blue_light = true))) AS total_com_blue,
    ( SELECT count(*) AS count
           FROM lens_catalog.lentes
          WHERE ((lentes.ativo = true) AND (lentes.deleted_at IS NULL) AND (lentes.tratamento_fotossensiveis IS NOT NULL) AND (lentes.tratamento_fotossensiveis <> 'nenhum'::lens_catalog.tratamento_foto))) AS total_fotossensiveis,
    ( SELECT count(*) AS count
           FROM lens_catalog.lentes
          WHERE ((lentes.ativo = true) AND (lentes.deleted_at IS NULL) AND (lentes.tratamento_uv = true))) AS total_uv400,
    ( SELECT count(*) AS count
           FROM lens_catalog.lentes
          WHERE ((lentes.ativo = true) AND (lentes.deleted_at IS NULL) AND (lentes.tratamento_antirrisco = true))) AS total_antirrisco,
    ( SELECT count(*) AS count
           FROM lens_catalog.lentes
          WHERE ((lentes.ativo = true) AND (lentes.deleted_at IS NULL) AND (lentes.tratamento_fotossensiveis = 'transitions'::lens_catalog.tratamento_foto))) AS total_transitions,
    ( SELECT count(*) AS count
           FROM lens_catalog.lentes
          WHERE ((lentes.ativo = true) AND (lentes.deleted_at IS NULL) AND (lentes.tratamento_fotossensiveis = 'fotocromÃ¡tico'::lens_catalog.tratamento_foto))) AS total_fotocromatico,
    ( SELECT count(*) AS count
           FROM lens_catalog.lentes
          WHERE ((lentes.ativo = true) AND (lentes.deleted_at IS NULL) AND (lentes.tratamento_fotossensiveis = 'polarizado'::lens_catalog.tratamento_foto))) AS total_polarizado,
    ( SELECT count(*) AS count
           FROM lens_catalog.lentes
          WHERE ((lentes.ativo = true) AND (lentes.deleted_at IS NULL) AND (lentes.tipo_lente = 'visao_simples'::lens_catalog.tipo_lente))) AS total_visao_simples,
    ( SELECT count(*) AS count
           FROM lens_catalog.lentes
          WHERE ((lentes.ativo = true) AND (lentes.deleted_at IS NULL) AND (lentes.tipo_lente = 'multifocal'::lens_catalog.tipo_lente))) AS total_multifocal,
    ( SELECT count(*) AS count
           FROM lens_catalog.lentes
          WHERE ((lentes.ativo = true) AND (lentes.deleted_at IS NULL) AND (lentes.tipo_lente = 'bifocal'::lens_catalog.tipo_lente))) AS total_bifocal,
    ( SELECT count(*) AS count
           FROM lens_catalog.lentes
          WHERE ((lentes.ativo = true) AND (lentes.deleted_at IS NULL) AND (lentes.tipo_lente = 'leitura'::lens_catalog.tipo_lente))) AS total_leitura,
    ( SELECT count(*) AS count
           FROM lens_catalog.lentes
          WHERE ((lentes.ativo = true) AND (lentes.deleted_at IS NULL) AND (lentes.tipo_lente = 'ocupacional'::lens_catalog.tipo_lente))) AS total_ocupacional,
    ( SELECT count(*) AS count
           FROM lens_catalog.lentes
          WHERE ((lentes.ativo = true) AND (lentes.deleted_at IS NULL) AND (lentes.material = 'CR39'::lens_catalog.material_lente))) AS total_cr39,
    ( SELECT count(*) AS count
           FROM lens_catalog.lentes
          WHERE ((lentes.ativo = true) AND (lentes.deleted_at IS NULL) AND (lentes.material = 'POLICARBONATO'::lens_catalog.material_lente))) AS total_policarbonato,
    ( SELECT count(*) AS count
           FROM lens_catalog.lentes
          WHERE ((lentes.ativo = true) AND (lentes.deleted_at IS NULL) AND (lentes.material = 'TRIVEX'::lens_catalog.material_lente))) AS total_trivex,
    ( SELECT count(*) AS count
           FROM lens_catalog.lentes
          WHERE ((lentes.ativo = true) AND (lentes.deleted_at IS NULL) AND (lentes.material = 'HIGH_INDEX'::lens_catalog.material_lente))) AS total_high_index,
    ( SELECT count(*) AS count
           FROM lens_catalog.lentes
          WHERE ((lentes.ativo = true) AND (lentes.deleted_at IS NULL) AND (lentes.material = 'VIDRO'::lens_catalog.material_lente))) AS total_vidro,
    ( SELECT count(*) AS count
           FROM lens_catalog.lentes
          WHERE ((lentes.ativo = true) AND (lentes.deleted_at IS NULL) AND (lentes.material = 'ACRILICO'::lens_catalog.material_lente))) AS total_acrilico,
    ( SELECT count(*) AS count
           FROM lens_catalog.lentes
          WHERE ((lentes.ativo = true) AND (lentes.deleted_at IS NULL) AND (lentes.indice_refracao = '1.50'::lens_catalog.indice_refracao))) AS total_indice_150,
    ( SELECT count(*) AS count
           FROM lens_catalog.lentes
          WHERE ((lentes.ativo = true) AND (lentes.deleted_at IS NULL) AND (lentes.indice_refracao = '1.56'::lens_catalog.indice_refracao))) AS total_indice_156,
    ( SELECT count(*) AS count
           FROM lens_catalog.lentes
          WHERE ((lentes.ativo = true) AND (lentes.deleted_at IS NULL) AND (lentes.indice_refracao = '1.59'::lens_catalog.indice_refracao))) AS total_indice_159,
    ( SELECT count(*) AS count
           FROM lens_catalog.lentes
          WHERE ((lentes.ativo = true) AND (lentes.deleted_at IS NULL) AND (lentes.indice_refracao = '1.61'::lens_catalog.indice_refracao))) AS total_indice_161,
    ( SELECT count(*) AS count
           FROM lens_catalog.lentes
          WHERE ((lentes.ativo = true) AND (lentes.deleted_at IS NULL) AND (lentes.indice_refracao = '1.67'::lens_catalog.indice_refracao))) AS total_indice_167,
    ( SELECT count(*) AS count
           FROM lens_catalog.lentes
          WHERE ((lentes.ativo = true) AND (lentes.deleted_at IS NULL) AND (lentes.indice_refracao = '1.74'::lens_catalog.indice_refracao))) AS total_indice_174,
    ( SELECT count(*) AS count
           FROM lens_catalog.lentes
          WHERE ((lentes.ativo = true) AND (lentes.deleted_at IS NULL) AND (lentes.indice_refracao = '1.90'::lens_catalog.indice_refracao))) AS total_indice_190,
    ( SELECT min(lentes.preco_venda_sugerido) AS min
           FROM lens_catalog.lentes
          WHERE ((lentes.ativo = true) AND (lentes.deleted_at IS NULL))) AS preco_minimo_catalogo,
    ( SELECT max(lentes.preco_venda_sugerido) AS max
           FROM lens_catalog.lentes
          WHERE ((lentes.ativo = true) AND (lentes.deleted_at IS NULL))) AS preco_maximo_catalogo,
    ( SELECT round(avg(lentes.preco_venda_sugerido), 2) AS round
           FROM lens_catalog.lentes
          WHERE ((lentes.ativo = true) AND (lentes.deleted_at IS NULL))) AS preco_medio_catalogo,
    ( SELECT percentile_cont((0.5)::double precision) WITHIN GROUP (ORDER BY ((lentes.preco_venda_sugerido)::double precision)) AS percentile_cont
           FROM lens_catalog.lentes
          WHERE ((lentes.ativo = true) AND (lentes.deleted_at IS NULL))) AS preco_mediano_catalogo,
    ( SELECT count(*) AS count
           FROM lens_catalog.lentes
          WHERE ((lentes.ativo = true) AND (lentes.deleted_at IS NULL) AND (lentes.preco_venda_sugerido < (500)::numeric))) AS faixa_economica,
    ( SELECT count(*) AS count
           FROM lens_catalog.lentes
          WHERE ((lentes.ativo = true) AND (lentes.deleted_at IS NULL) AND (lentes.preco_venda_sugerido >= (500)::numeric) AND (lentes.preco_venda_sugerido < (1500)::numeric))) AS faixa_intermediaria,
    ( SELECT count(*) AS count
           FROM lens_catalog.lentes
          WHERE ((lentes.ativo = true) AND (lentes.deleted_at IS NULL) AND (lentes.preco_venda_sugerido >= (1500)::numeric) AND (lentes.preco_venda_sugerido < (3000)::numeric))) AS faixa_premium,
    ( SELECT count(*) AS count
           FROM lens_catalog.lentes
          WHERE ((lentes.ativo = true) AND (lentes.deleted_at IS NULL) AND (lentes.preco_venda_sugerido >= (3000)::numeric))) AS faixa_ultra_premium; |

---

## 2ï¸âƒ£ Estrutura da view `v_grupos_canonicos`

```sql
SELECT
    column_name,
    data_type,
    is_nullable
FROM information_schema.columns
WHERE table_schema = 'public'
  AND table_name = 'v_grupos_canonicos'
ORDER BY ordinal_position;
```

**O que busco**: Nomes EXATOS de todas as colunas disponÃ­veis
| column_name               | data_type    | is_nullable |
| ------------------------- | ------------ | ----------- |
| id                        | uuid         | YES         |
| slug                      | text         | YES         |
| nome_grupo                | text         | YES         |
| tipo_lente                | USER-DEFINED | YES         |
| material                  | USER-DEFINED | YES         |
| indice_refracao           | USER-DEFINED | YES         |
| categoria_predominante    | USER-DEFINED | YES         |
| grau_esferico_min         | numeric      | YES         |
| grau_esferico_max         | numeric      | YES         |
| grau_cilindrico_min       | numeric      | YES         |
| grau_cilindrico_max       | numeric      | YES         |
| adicao_min                | numeric      | YES         |
| adicao_max                | numeric      | YES         |
| descricao_ranges          | text         | YES         |
| tratamento_antirreflexo   | boolean      | YES         |
| tratamento_antirrisco     | boolean      | YES         |
| tratamento_uv             | boolean      | YES         |
| tratamento_blue_light     | boolean      | YES         |
| tratamento_fotossensiveis | text         | YES         |
| preco_minimo              | numeric      | YES         |
| preco_maximo              | numeric      | YES         |
| preco_medio               | numeric      | YES         |
| total_lentes              | integer      | YES         |
| total_marcas              | integer      | YES         |
| peso                      | integer      | YES         |
| is_premium                | boolean      | YES         |

---

## 3ï¸âƒ£ Exemplo de dados reais da view `v_grupos_canonicos`

```sql
SELECT *
FROM v_grupos_canonicos
LIMIT 5;
```

**O que busco**: Ver os dados reais para entender estrutura e valores
| id                                   | slug                                                                       | nome_grupo                                                            | tipo_lente    | material      | indice_refracao | categoria_predominante | grau_esferico_min | grau_esferico_max | grau_cilindrico_min | grau_cilindrico_max | adicao_min | adicao_max | descricao_ranges                                                         | tratamento_antirreflexo | tratamento_antirrisco | tratamento_uv | tratamento_blue_light | tratamento_fotossensiveis | preco_minimo | preco_maximo | preco_medio | total_lentes | total_marcas | peso | is_premium |
| ------------------------------------ | -------------------------------------------------------------------------- | --------------------------------------------------------------------- | ------------- | ------------- | --------------- | ---------------------- | ----------------- | ----------------- | ------------------- | ------------------- | ---------- | ---------- | ------------------------------------------------------------------------ | ----------------------- | --------------------- | ------------- | --------------------- | ------------------------- | ------------ | ------------ | ----------- | ------------ | ------------ | ---- | ---------- |
| 573729aa-91b7-4f74-b2dc-00e5bcd9ea34 | lente-159-visao-simples-uv-esf-n10-00-6-00-cil-0-00-n2-00-add-000-000      | Lente POLICARBONATO 1.59 Visao Simples +UV [-10.00/6.00 | 0.00/-2.00] | visao_simples | POLICARBONATO | 1.59            | null                   | -10.00            | 6.00              | 0.00                | -2.00               | 0.00       | 0.00       | EsfÃ©rico: -10.00 a 6.00 | CilÃ­ndrico: 0.00 a -2.00 | AdiÃ§Ã£o: 0.00 a 0.00 | false                   | false                 | true          | false                 | nenhum                    | 250.00       | 250.00       | 250.00      | 1            | 1            | 50   | false      |
| 30d581c1-4b46-41a8-b4a5-6653c862ec7a | lente-39-150-visao-simples-uv-esf-n6-00-6-00-cil-0-00-n2-00-add-000-000    | Lente CR39 1.50 Visao Simples +UV [-6.00/6.00 | 0.00/-2.00]           | visao_simples | CR39          | 1.50            | null                   | -6.00             | 6.00              | 0.00                | -2.00               | 0.00       | 0.00       | EsfÃ©rico: -6.00 a 6.00 | CilÃ­ndrico: 0.00 a -2.00 | AdiÃ§Ã£o: 0.00 a 0.00  | false                   | false                 | true          | false                 | nenhum                    | 250.00       | 250.00       | 250.00      | 1            | 1            | 50   | false      |
| 62d675b2-e9b2-47d3-b98f-9ff53b26eca7 | lente-39-156-visao-simples-ar-uv-esf-n8-00-6-00-cil-0-00-n2-00-add-000-000 | Lente CR39 1.56 Visao Simples +AR +UV [-8.00/6.00 | 0.00/-2.00]       | visao_simples | CR39          | 1.56            | null                   | -8.00             | 6.00              | 0.00                | -2.00               | 0.00       | 0.00       | EsfÃ©rico: -8.00 a 6.00 | CilÃ­ndrico: 0.00 a -2.00 | AdiÃ§Ã£o: 0.00 a 0.00  | true                    | false                 | true          | false                 | nenhum                    | 253.91       | 253.91       | 253.91      | 1            | 1            | 50   | false      |
| 928ddd31-a900-4340-8d3f-094e68538524 | lente-39-150-visao-simples-uv-esf-n6-00-6-00-cil-n2-00-2-00-add-000-000    | Lente CR39 1.50 Visao Simples +UV [-6.00/6.00 | -2.00/2.00]           | visao_simples | CR39          | 1.50            | null                   | -6.00             | 6.00              | -2.00               | 2.00                | 0.00       | 0.00       | EsfÃ©rico: -6.00 a 6.00 | CilÃ­ndrico: -2.00 a 2.00 | AdiÃ§Ã£o: 0.00 a 0.00  | false                   | false                 | true          | false                 | nenhum                    | 255.87       | 255.87       | 255.87      | 1            | 1            | 50   | false      |
| 14a2d496-3947-4b9e-9ff2-aff781d7cee3 | lente-39-156-visao-simples-ar-uv-esf-n8-00-6-00-cil-n2-00-0-00             | Lente CR39 1.56 Visao Simples +AR +UV [-8.00/6.00 | -2.00/0.00]       | visao_simples | CR39          | 1.56            | null                   | -8.00             | 6.00              | -2.00               | 0.00                | null       | null       | EsfÃ©rico: -8.00 a 6.00 | CilÃ­ndrico: -2.00 a 0.00                        | true                    | false                 | true          | false                 | nenhum                    | 261.73       | 261.73       | 261.73      | 1            | 1            | 50   | false      |

---

## 4ï¸âƒ£ Verificar se existe view de fornecedores

```sql
SELECT
    viewname
FROM pg_views
WHERE schemaname = 'public'
  AND viewname ILIKE '%fornecedor%'
ORDER BY viewname;
```
| viewname                 |
| ------------------------ |
| v_fornecedores_catalogo  |
| v_fornecedores_por_lente |

**O que busco**: Views relacionadas a fornecedores/laboratÃ³rios

---

## 5ï¸âƒ£ Verificar views com "lente" no nome

```sql
SELECT
    viewname
FROM pg_views
WHERE schemaname = 'public'
  AND viewname ILIKE '%lente%'
ORDER BY viewname;
```

**O que busco**: Todas as views relacionadas a lentes
| viewname                   |
| -------------------------- |
| v_fornecedores_por_lente   |
| v_grupos_com_lentes        |
| v_lentes_busca             |
| v_lentes_catalogo          |
| v_lentes_cotacao_compra    |
| vw_bi_lentes_lucratividade |
| vw_lentes_catalogo         |

---

## 6ï¸âƒ£ Se existir `v_grupos_por_receita_cliente`, ver estrutura

```sql
SELECT
    column_name,
    data_type,
    is_nullable
FROM information_schema.columns
WHERE table_schema = 'public'
  AND table_name = 'v_grupos_por_receita_cliente'
ORDER BY ordinal_position;
```

**O que busco**: Estrutura dessa view especÃ­fica que vimos no cÃ³digo
| column_name               | data_type    | is_nullable |
| ------------------------- | ------------ | ----------- |
| grupo_id                  | uuid         | YES         |
| grupo_slug                | text         | YES         |
| nome_grupo                | text         | YES         |
| tipo_lente                | USER-DEFINED | YES         |
| material                  | USER-DEFINED | YES         |
| indice_refracao           | USER-DEFINED | YES         |
| grau_esferico_min         | numeric      | YES         |
| grau_esferico_max         | numeric      | YES         |
| grau_cilindrico_min       | numeric      | YES         |
| grau_cilindrico_max       | numeric      | YES         |
| adicao_min                | numeric      | YES         |
| adicao_max                | numeric      | YES         |
| tratamento_antirreflexo   | boolean      | YES         |
| tratamento_antirrisco     | boolean      | YES         |
| tratamento_uv             | boolean      | YES         |
| tratamento_blue_light     | boolean      | YES         |
| tratamento_fotossensiveis | text         | YES         |
| preco_minimo              | numeric      | YES         |
| preco_medio               | numeric      | YES         |
| preco_maximo              | numeric      | YES         |
| custo_medio               | numeric      | YES         |
| margem_media              | numeric      | YES         |
| categoria_sugerida        | text         | YES         |
| total_lentes              | integer      | YES         |
| total_fornecedores        | bigint       | YES         |
| total_marcas              | bigint       | YES         |
| is_premium                | boolean      | YES         |
| prazo_medio_dias          | integer      | YES         |

---

## 7ï¸âƒ£ Listar todas as TABELAS pÃºblicas (se houver)

```sql
SELECT
    tablename
FROM pg_tables
WHERE schemaname = 'public'
ORDER BY tablename;
```

**O que busco**: Verificar se hÃ¡ tabelas pÃºblicas acessÃ­veis alÃ©m das views
Success. No rows returned



---

## ðŸ“ Como executar

1. Acesse: https://supabase.com/dashboard/project/ahcikwsoxhmqqteertkx/sql/new
2. Cole cada query acima
3. Clique em "Run"
4. Copie os resultados (pode tirar screenshot ou copiar o JSON)
5. Me envie todos os resultados

---

## ðŸŽ¯ O que vou descobrir com isso

Com essas respostas, vou poder:

- âœ… Corrigir os nomes exatos das colunas
- âœ… Remover filtros que nÃ£o funcionam
- âœ… Usar as views corretas
- âœ… Criar queries que realmente funcionam
- âœ… Fazer o wizard funcionar 100%

---

**Ordem de prioridade** (se nÃ£o puder executar todas):

1. Query #2 (estrutura v_grupos_canonicos) - **CRÃTICA**
2. Query #3 (exemplo de dados) - **CRÃTICA**
3. Query #1 (listar views) - IMPORTANTE
4. Query #5 (views com "lente") - IMPORTANTE
5. Queries #4, #6, #7 - Opcionais
