// ============================================
// INVESTIGA√á√ÉO COMPLETA DOS DADOS DISPON√çVEIS
// Para criar o Dashboard Centro de Comando
// ============================================

const { createClient } = require('@supabase/supabase-js')
const fs = require('fs')

// Ler .env.local manualmente
function carregarEnv() {
  try {
    const envContent = fs.readFileSync('.env.local', 'utf8')
    const envVars = {}
    
    envContent.split('\n').forEach(line => {
      if (line.trim() && !line.startsWith('#')) {
        const [key, ...valueParts] = line.split('=')
        envVars[key.trim()] = valueParts.join('=').trim()
      }
    })
    
    return envVars
  } catch (error) {
    console.error('‚ùå Erro ao ler .env.local:', error.message)
    return {}
  }
}

async function investigarDadosCompletos() {
  console.log('üîç INVESTIGA√á√ÉO COMPLETA DOS DADOS')
  console.log('Para criar Dashboard Centro de Comando')
  console.log('='.repeat(50))
  
  const env = carregarEnv()
  const supabaseUrl = env.NEXT_PUBLIC_SUPABASE_URL
  const supabaseServiceRoleKey = env.SUPABASE_SERVICE_ROLE_KEY
  
  const supabase = createClient(supabaseUrl, supabaseServiceRoleKey, {
    auth: {
      persistSession: false,
      autoRefreshToken: false,
    },
  })

  const log = (message) => {
    console.log(message)
    fs.appendFileSync('investigacao-dashboard.log', message + '\n')
  }

  // Limpar log anterior
  if (fs.existsSync('investigacao-dashboard.log')) {
    fs.unlinkSync('investigacao-dashboard.log')
  }

  try {
    log('\nüìä 1. PEDIDOS - Dados principais')
    log('-'.repeat(40))
    
    // Investigar pedidos
    const { data: pedidos, error: pedidosError } = await supabase
      .from('pedidos')
      .select('*')
      .order('created_at', { ascending: false })
      .limit(5)
    
    if (pedidosError) {
      log(`‚ùå Erro pedidos: ${pedidosError.message}`)
    } else {
      log(`‚úÖ Total pedidos: ${pedidos.length} (amostra)`)
      log(`   Campos dispon√≠veis: ${Object.keys(pedidos[0] || {}).length}`)
      log(`   Status encontrados: ${[...new Set(pedidos.map(p => p.status))].join(', ')}`)
      
      // An√°lise de status
      const statusCount = {}
      pedidos.forEach(p => {
        statusCount[p.status] = (statusCount[p.status] || 0) + 1
      })
      log(`   Distribui√ß√£o status (amostra): ${JSON.stringify(statusCount)}`)
    }

    log('\nüè™ 2. LOJAS - Pontos de venda')
    log('-'.repeat(40))
    
    const { data: lojas, error: lojasError } = await supabase
      .from('lojas')
      .select('*')
    
    if (!lojasError && lojas) {
      log(`‚úÖ Total lojas: ${lojas.length}`)
      const lojasAtivas = lojas.filter(l => l.ativo)
      log(`   Lojas ativas: ${lojasAtivas.length}`)
      log(`   Nomes: ${lojasAtivas.map(l => l.nome).join(', ')}`)
    }

    log('\nüî¨ 3. LABORAT√ìRIOS - Parceiros')
    log('-'.repeat(40))
    
    const { data: labs, error: labsError } = await supabase
      .from('laboratorios')
      .select('*')
    
    if (!labsError && labs) {
      log(`‚úÖ Total laborat√≥rios: ${labs.length}`)
      const labsAtivos = labs.filter(l => l.ativo)
      log(`   Labs ativos: ${labsAtivos.length}`)
      log(`   Nomes: ${labsAtivos.map(l => l.nome).join(', ')}`)
    }

    log('\nüëì 4. CLASSES DE LENTE - Produtos')
    log('-'.repeat(40))
    
    const { data: classes, error: classesError } = await supabase
      .from('classes_lente')
      .select('*')
    
    if (!classesError && classes) {
      log(`‚úÖ Total classes: ${classes.length}`)
      const classesAtivas = classes.filter(c => c.ativa)
      log(`   Classes ativas: ${classesAtivas.length}`)
      log(`   Nomes: ${classesAtivas.map(c => c.nome).join(', ')}`)
    }

    log('\nüîî 5. ALERTAS - Notifica√ß√µes')
    log('-'.repeat(40))
    
    const { data: alertas, error: alertasError } = await supabase
      .from('alertas')
      .select('*')
      .order('created_at', { ascending: false })
      .limit(10)
    
    if (!alertasError && alertas) {
      log(`‚úÖ Alertas encontrados: ${alertas.length}`)
      const alertasNaoLidos = alertas.filter(a => !a.lido)
      log(`   N√£o lidos: ${alertasNaoLidos.length}`)
      log(`   Tipos: ${[...new Set(alertas.map(a => a.tipo))].join(', ')}`)
    }

    log('\nüë• 6. USU√ÅRIOS - Time')
    log('-'.repeat(40))
    
    const { data: usuarios, error: usuariosError } = await supabase
      .from('usuarios')
      .select('id, email, nome, role, ativo')
    
    if (!usuariosError && usuarios) {
      log(`‚úÖ Total usu√°rios: ${usuarios.length}`)
      const usuariosAtivos = usuarios.filter(u => u.ativo)
      log(`   Usu√°rios ativos: ${usuariosAtivos.length}`)
      log(`   Roles: ${[...new Set(usuarios.map(u => u.role))].join(', ')}`)
    }

    log('\nüìÖ 7. TIMELINE - Hist√≥rico')
    log('-'.repeat(40))
    
    const { data: timeline, error: timelineError } = await supabase
      .from('pedidos_timeline')
      .select('*')
      .order('created_at', { ascending: false })
      .limit(10)
    
    if (!timelineError && timeline) {
      log(`‚úÖ Eventos timeline: ${timeline.length}`)
      log(`   Status mais comuns: ${[...new Set(timeline.map(t => t.status_novo))].join(', ')}`)
    }

    log('\nüíä 8. TRATAMENTOS - Servi√ßos adicionais')
    log('-'.repeat(40))
    
    const { data: tratamentos, error: tratamentosError } = await supabase
      .from('tratamentos')
      .select('*')
    
    if (!tratamentosError && tratamentos) {
      log(`‚úÖ Total tratamentos: ${tratamentos.length}`)
      const tratamentosAtivos = tratamentos.filter(t => t.ativo)
      log(`   Tratamentos ativos: ${tratamentosAtivos.length}`)
    }

    log('\nüßë‚Äçüíº 9. COLABORADORES - Vendedores')
    log('-'.repeat(40))
    
    const { data: colaboradores, error: colaboradoresError } = await supabase
      .from('colaboradores')
      .select('*')
    
    if (!colaboradoresError && colaboradores) {
      log(`‚úÖ Total colaboradores: ${colaboradores.length}`)
    }

    log('\nüìã 10. VIEWS DISPON√çVEIS')
    log('-'.repeat(40))
    
    // Testar views importantes
    const views = [
      'v_pedidos_kanban',
      'v_kpis_dashboard',
      'v_dashboard_resumo',
      'v_lead_time_comparativo',
      'v_pedido_timeline_completo'
    ]

    for (const viewName of views) {
      try {
        const { data, error } = await supabase
          .from(viewName)
          .select('*')
          .limit(1)
        
        if (error) {
          log(`‚ùå ${viewName}: ${error.message}`)
        } else {
          log(`‚úÖ ${viewName}: Dispon√≠vel (${data ? Object.keys(data[0] || {}).length : 0} campos)`)
        }
      } catch (e) {
        log(`‚ùå ${viewName}: Erro ao testar`)
      }
    }

    log('\nüí∞ 11. AN√ÅLISE FINANCEIRA')
    log('-'.repeat(40))
    
    // Buscar dados financeiros dos pedidos
    const { data: pedidosFinanceiros, error: financeiroError } = await supabase
      .from('pedidos')
      .select('valor_pedido, custo_lentes, status, forma_pagamento, data_pagamento')
      .not('valor_pedido', 'is', null)
    
    if (!financeiroError && pedidosFinanceiros) {
      const valorTotal = pedidosFinanceiros.reduce((sum, p) => sum + (p.valor_pedido || 0), 0)
      const custoTotal = pedidosFinanceiros.reduce((sum, p) => sum + (p.custo_lentes || 0), 0)
      const pedidosPagos = pedidosFinanceiros.filter(p => p.data_pagamento).length
      
      log(`‚úÖ An√°lise financeira:`)
      log(`   Valor total em pedidos: R$ ${valorTotal.toFixed(2)}`)
      log(`   Custo total lentes: R$ ${custoTotal.toFixed(2)}`)
      log(`   Margem bruta: R$ ${(valorTotal - custoTotal).toFixed(2)}`)
      log(`   Pedidos pagos: ${pedidosPagos}/${pedidosFinanceiros.length}`)
      
      const formasPagamento = {}
      pedidosFinanceiros.forEach(p => {
        if (p.forma_pagamento) {
          formasPagamento[p.forma_pagamento] = (formasPagamento[p.forma_pagamento] || 0) + 1
        }
      })
      log(`   Formas de pagamento: ${JSON.stringify(formasPagamento)}`)
    }

    log('\n‚è±Ô∏è 12. AN√ÅLISE TEMPORAL')
    log('-'.repeat(40))
    
    // An√°lise de datas e SLAs
    const { data: pedidosTempo, error: tempoError } = await supabase
      .from('pedidos')
      .select('data_pedido, data_prevista_pronto, data_entregue, status, lead_time_total_horas')
    
    if (!tempoError && pedidosTempo) {
      const hoje = new Date()
      const pedidosAtrasados = pedidosTempo.filter(p => {
        return p.data_prevista_pronto && 
               new Date(p.data_prevista_pronto) < hoje &&
               !['ENTREGUE', 'CANCELADO'].includes(p.status)
      }).length
      
      const pedidosEntregues = pedidosTempo.filter(p => p.status === 'ENTREGUE').length
      const comLeadTime = pedidosTempo.filter(p => p.lead_time_total_horas).length
      
      log(`‚úÖ An√°lise temporal:`)
      log(`   Pedidos atrasados: ${pedidosAtrasados}`)
      log(`   Pedidos entregues: ${pedidosEntregues}`)
      log(`   Com lead time calculado: ${comLeadTime}`)
    }

    log('\nüéØ RESUMO PARA DASHBOARD CENTRO DE COMANDO')
    log('='.repeat(50))
    log('‚úÖ DADOS DISPON√çVEIS:')
    log('   - Pedidos com status completo')
    log('   - Lojas e laborat√≥rios ativos')
    log('   - Classes de lente e tratamentos')
    log('   - Sistema de alertas')
    log('   - Timeline de mudan√ßas')
    log('   - Dados financeiros completos')
    log('   - An√°lise temporal e SLAs')
    log('   - Usu√°rios e permiss√µes')
    log('')
    log('üöÄ PR√ìXIMOS PASSOS:')
    log('   1. Criar KPIs em tempo real')
    log('   2. Implementar alertas cr√≠ticos')
    log('   3. Dashboard de performance por loja/lab')
    log('   4. An√°lise financeira detalhada')
    log('   5. Monitoramento de SLA')
    log('   6. Previs√µes e tend√™ncias')

  } catch (error) {
    log(`‚ùå Erro geral: ${error.message}`)
  }
}

investigarDadosCompletos()
  .then(() => {
    console.log('\n‚úÖ INVESTIGA√á√ÉO CONCLU√çDA!')
    console.log('üìã Verifique o arquivo investigacao-dashboard.log para detalhes completos')
  })
  .catch(error => {
    console.error('‚ùå Erro na investiga√ß√£o:', error)
  })