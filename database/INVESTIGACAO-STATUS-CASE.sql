-- ============================================================================
-- INVESTIGAÇÃO: Por que o app funciona com status diferentes?
-- ============================================================================

-- 1. Testar se PostgreSQL ENUMs são case-sensitive
SELECT 
  'Case Sensitivity Test' as teste,
  'pendente'::status_pedido = 'PENDENTE'::status_pedido as sao_iguais,
  'pendente'::text = 'PENDENTE'::text as text_iguais;

-- Resultado esperado: sao_iguais = false (ENUMs são case-sensitive!)

-- 2. Ver todos os pedidos e seus status REAIS (exatamente como estão)
SELECT 
  id,
  status,
  status::text as status_como_texto,
  LENGTH(status::text) as tamanho,
  ASCII(SUBSTRING(status::text, 1, 1)) as primeiro_char_ascii,
  loja_nome,
  laboratorio_nome,
  created_at
FROM v_pedidos_kanban
ORDER BY created_at DESC
LIMIT 20;

| id                                   | status       | status_como_texto | tamanho | primeiro_char_ascii | loja_nome | laboratorio_nome      | created_at                    |
| ------------------------------------ | ------------ | ----------------- | ------- | ------------------- | --------- | --------------------- | ----------------------------- |
| d747b999-694c-4ad8-a9dc-519fb4d51579 | AG_PAGAMENTO | AG_PAGAMENTO      | 12      | 65                  | Suzano    | null                  | 2026-01-17 14:50:07.612543+00 |
| 18ebd8aa-7245-4355-9ffe-87188ab91575 | CANCELADO    | CANCELADO         | 9       | 67                  | Suzano    | null                  | 2026-01-16 22:54:39.568965+00 |
| e73ccccb-9b6b-4205-9241-d039b750dffe | CANCELADO    | CANCELADO         | 9       | 67                  | Suzano    | Braslentes            | 2026-01-15 00:18:11.60548+00  |
| b9374462-ac98-4b4a-984d-8fe65aaa9194 | AG_PAGAMENTO | AG_PAGAMENTO      | 12      | 65                  | Suzano    | Braslentes            | 2026-01-15 00:15:22.434113+00 |
| aeb9d187-491a-47db-afb1-828dcb760089 | PRODUCAO     | PRODUCAO          | 8       | 80                  | Suzano    | Brascor               | 2026-01-15 00:01:30.489966+00 |
| e9457472-1ba7-40fb-aac8-d19c60aeb6e7 | AG_PAGAMENTO | AG_PAGAMENTO      | 12      | 65                  | Suzano    | Brascor               | 2026-01-14 23:59:29.436838+00 |
| 6c75d926-452c-4745-a3d1-bd97020cd82b | PRODUCAO     | PRODUCAO          | 8       | 80                  | Suzano    | Brascor               | 2026-01-14 23:55:55.198887+00 |
| 78c44a99-8f71-4c69-adf1-b1d228e9aa12 | PRODUCAO     | PRODUCAO          | 8       | 80                  | Suzano    | Brascor               | 2026-01-14 23:50:11.873222+00 |
| 1fbfa297-a1f1-48ac-a6c2-129a4b1f97bf | PRODUCAO     | PRODUCAO          | 8       | 80                  | Suzano    | Brascor               | 2026-01-14 23:46:56.06861+00  |
| 1d6cc18e-6e6b-48d8-a30b-ad924b10fb87 | PRODUCAO     | PRODUCAO          | 8       | 80                  | Suzano    | Brascor               | 2026-01-14 23:45:03.630593+00 |
| 6d5c0a69-1baa-475a-86ad-a2f04b2a48f9 | PRONTO       | PRONTO            | 6       | 80                  | Suzano    | Style                 | 2026-01-14 23:41:50.611151+00 |
| 11cd698f-db07-429f-89aa-7fe40b4e263d | CHEGOU       | CHEGOU            | 6       | 67                  | Suzano    | Braslentes            | 2026-01-14 17:37:19.173572+00 |
| d50ba831-e23c-4780-85c1-55c03cf1d2b3 | PRODUCAO     | PRODUCAO          | 8       | 80                  | Suzano    | Style                 | 2026-01-13 20:06:45.720055+00 |
| 6c042a43-c816-4555-a998-3f776badd662 | PRODUCAO     | PRODUCAO          | 8       | 80                  | Suzano    | Style                 | 2026-01-13 20:01:47.567076+00 |
| 1512d395-ccdb-415c-8379-e9f2077c9413 | AG_PAGAMENTO | AG_PAGAMENTO      | 12      | 65                  | Suzano    | Douglas - Laboratório | 2026-01-13 13:49:29.941332+00 |
| 3acaace0-78b4-4d5d-a567-812f43534c5e | AG_PAGAMENTO | AG_PAGAMENTO      | 12      | 65                  | Suzano    | Douglas - Laboratório | 2026-01-13 13:47:51.477024+00 |
| 026a4b95-440e-41e0-8434-bce90c809087 | CHEGOU       | CHEGOU            | 6       | 67                  | Suzano    | 2K                    | 2026-01-13 13:42:43.946377+00 |
| 36329608-c08a-426c-8a58-845078c8ea23 | CHEGOU       | CHEGOU            | 6       | 67                  | Suzano    | 2K                    | 2026-01-13 13:40:22.605682+00 |
| 63d71878-01d7-4055-b886-c9851dcda119 | CHEGOU       | CHEGOU            | 6       | 67                  | Suzano    | 2K                    | 2026-01-13 13:38:48.806587+00 |
| fb650ea1-670f-4194-91f5-982710d15333 | AG_PAGAMENTO | AG_PAGAMENTO      | 12      | 65                  | Suzano    | Douglas - Laboratório | 2026-01-13 13:37:16.733474+00 |



-- 3. Contar pedidos por status (agrupamento exato)
SELECT 
  status,
  status::text as status_texto,
  COUNT(*) as quantidade,
  ARRAY_AGG(id ORDER BY created_at DESC) as ids_pedidos
FROM pedidos
GROUP BY status, status::text
ORDER BY quantidade DESC;

| status       | status_texto | quantidade | ids_pedidos                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |
| ------------ | ------------ | ---------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| ENTREGUE     | ENTREGUE     | 494        | ["5ed4aea0-6113-4e3b-bff0-c6a47cfc87fa","75a2ee96-f2a5-4b21-b808-d786e630b400","0039c138-7b2b-4613-9fe3-4632657701ff","3a54b740-9894-4727-b9e3-dde53f7b8b63","a6fcc921-2a40-4e35-a4f8-fd9da926548e","4d0706fa-193a-4184-970d-a7eae37f84a0","caa87967-9f11-4720-87f1-68976d08c9aa","0453fff9-66ce-43ee-b116-57ed4ee18692","bd898c70-550a-44e5-a519-b7c1f81deb2e","5085ad97-9e8f-41dd-b1d5-51ba3f974768","f129dda4-201f-45c2-b65f-d1cee2a2cf87","b4d6ced9-faa3-47ef-97be-40bce68a1c74","fc4f426a-6370-4c8b-b202-fe8fb4755006","f6300ea7-b3c3-40c1-bbc4-fbb668f2ac22","af6f2351-c979-4f3e-aea5-41698478fdad","ff43a35c-f256-4d4f-8fd3-89c9bbc41b07","1adb1a8d-986c-4359-b78c-c39802cde359","065e3593-0a4c-410e-9221-e1e8bf338dcb","0f05ee36-d309-4648-87a0-3a9ac82fe47c","57452b24-b64c-4d27-b92f-3086e043af30","9752f02d-dfbd-43ec-ac67-d80025f57f34","084f24df-aa58-46d7-97ef-8a48fae35d10","b1dbfe25-dbd1-4ae6-b55b-a3c19d475e75","b14f1adf-5160-4f59-bf75-80357f2634bf","dc64ae6a-f30f-48c8-b0ae-eed659447874","ae4b3c40-9b47-401c-93b8-f22aa913a2e9","7a7d7f88-6586-499d-855e-ef800a0bd815","eaa1995c-8dc2-430e-81e8-645572e23fbc","d63f3f46-7972-4d5c-a8ce-0c25dea01436","69900161-544b-4dbb-8982-d9d30628ed26","5434476f-431f-4740-bbd2-876b35060d69","7ffa53cf-5b99-4e42-936d-bc8d04a551c9","513d201b-f730-46d9-a3ad-1e5f88c8c858","4f4552c8-2c3f-43f7-9118-a72de1f75b8a","06a927cf-0200-4ec8-abb2-44953444fb83","779e2395-9107-42a3-af4d-3256624f51a9","9db94563-c870-44ec-9284-36728158545b","c6d7e924-9868-4b32-9459-820a1618e4a8","3e4792f6-0d6d-4805-a83d-a9b0a32fd742","bb41d443-7973-4829-9412-0b8d48cee8b7","96b67f98-fbc3-4be1-8647-cde682cafb02","08b9716a-f37c-43af-819a-78bf46810205","a5c029c2-448f-408c-af99-e576575e2544","4ba4a350-377f-42c3-a5d8-f465bc573e53","162c8719-eb75-4c18-8040-9d7222e42596","3cf8ed20-e70b-4d5f-8296-32753bd6bd04","8255aba8-ddfb-4100-bfec-276424102c4b","c7a0006f-78a6-4751-b510-080e7b57e0ea","228aad16-fcb5-4fce-a05d-0de491439eeb","464d1aab-e2fe-45e7-baec-0bdeb442f073","77656127-4b1e-4751-9673-81e48d9fa37b","37e074de-4cbb-4d1b-8cfc-7a3e5d366dda","95fc221f-0a7d-489a-abd5-d13435e9b704","c1ff20f0-fa5e-4585-9963-f8345f311c83","b4515e91-b516-4fc3-b639-8f905df7c5f0","74228b61-7a4e-44b9-83f8-bd3ef22e5896","9cc9bd8b-a9ed-4225-8ce9-0c653be57ebb","3fc3ff5e-b514-4255-816a-4dcdb250d8d9","6fe99fcf-9aef-4347-a86c-38f872df1bfc","54740965-ad3f-4cab-9d7a-409ff05831e4","bc50ceab-bc32-4147-8d22-7f9ebf5ff4f2","de115132-da6f-4b1d-b90c-3d802089cb67","0e2a44fa-3a1f-4824-b7f5-5ef9fb8c6b27","a8cddc31-7b23-419d-acd2-0ac9b1f7c23f","75257ad5-c4f1-4b23-bd12-8366338b215b","00893623-99bb-4808-a88a-bbd91157af8b","5e018529-60bb-46f4-98a1-a2c7f5a5e8b8","ba631254-86c1-43eb-abb0-07f4ac3a423e","2bfa0bb3-eb30-491b-a2f7-6fd85de428d6","cf3d20f5-6620-4e60-b915-72649630527d","531fcc0a-e456-4615-a045-8bc4b9ae5343","c312acbe-780b-455d-9977-e39458ef8f4e","89e697bb-c2e4-4f44-b847-2e0431e23fac","5deb4f59-3ebb-4f7e-97c9-41e0ba8ac766","eb7ed4d8-0a31-4f45-9d8d-35734846f7b4","8a55775e-c203-4ae7-a477-de9b875e7557","32cf2284-2de7-409c-8ac6-01cf7e18fc54","bea88e42-b4f4-42c0-a855-8a69664bafea","954e38ac-9bd8-4b2e-82bf-6859496eac41","78b69b5c-2cbe-4ae8-a637-c3a8b4c4fef1","420f98dc-2e4d-4bd8-aa3f-8ec3f324f8fd","97aa4b8c-57b9-4bd6-8939-856160903053","55bc9815-2251-45fa-8afd-94a5afb7d44e","93b959ec-d1f5-47d9-b695-e44d67bfee6f","f2a9e5ec-fdba-4263-9dac-354f93d62946","9ae812dc-1251-4f2e-8d14-032ce2b1ee72","f729a21c-2581-4df9-babb-a68e085b3cf1","c233cff3-91cb-442c-a521-1dc4f2b22f89","bb5a5e83-0459-4cfa-b647-af2c8b760ff5","c78c37aa-c6b6-4efb-b79d-b6166c642aa7","78aa78df-4609-4c68-8d62-fe183f301c23","9d57804c-8b09-4170-b6dd-362dc6c36379","11948185-8824-45e7-8f2b-a479b0520dbc","52afb5f8-b8a8-4509-8c3a-8db471139aa4","3f2dbf24-5ca1-4bc3-bab4-2e286c718aba","0deff3f2-210f-4cab-8a50-511f624e9ebb","296c177a-27f6-4f34-8290-fbc7946f1537","ad5fea89-4770-4c68-8ea3-8663a4664f93","41aff255-bc90-43a5-963f-60c9432bea88","ed101a54-0c10-4029-87c8-2e4691891e69","96bfb4fa-417d-4307-9be7-3a2a9a1bfa08","f3fcecb8-a83f-404c-8559-bbebc1a92462","b22e0e77-7da5-4bb8-b3b9-3d9997f3b25e","4536124b-2359-413a-a39d-26202492b790","9e80bfd9-3dfe-48dc-b3e7-2074db68a1e8","814b09a4-5134-46f2-bd4b-a1981e85d0b9","92896c32-402c-4c12-8b17-9d653c70c0ed","fb14953f-ca91-4dd8-81e7-3ed7ea2a9684","875c3607-c21a-4a79-be3d-b62fdc7663f2","0a7dd4dd-296d-46a4-8979-12327a374368","0dc49d0c-0423-4b99-8a34-faead512c912","aeb4a2b7-18f0-4a5f-81aa-24c2f411bac0","0784ab61-1c7e-44e6-9c1d-748bac060b83","ea28a1c5-76a5-4730-96d5-43f3bb840ea6","9f6343ec-ab54-4bef-abeb-8ddf007c5bb8","a0a999d6-4898-43e9-b044-d9aeabc7e6d7","3018701c-a399-4c0a-bfa3-047728fbecf6","7a08ad48-2ad7-43a5-9158-fcc8de5e0e20","4bf389d6-6de1-47e1-8dee-f581b324f534","047bc3f4-3d2b-4d3d-a462-0da38ff3814e","bd393b6f-2119-4ef5-ada6-64b6df41a1f7","60a3ba52-c97d-4b2d-a03a-b2d7c975baf2","48a37334-d324-481f-a326-00d293cbc26b","fae9ce3a-e571-44eb-90e9-3d36d93f7dcf","da42ace1-d74e-4fc0-ab1e-b3f887df780d","34ca7483-3428-490f-93be-2add0ac9457d","de335647-00c4-4bbd-9db2-eb0932db4a9c","9d11e310-5996-40b6-9340-26a43a9b91ff","f2162750-6c3c-418d-812a-4554b0c1d1e2","a0bccce4-6f33-4976-a346-dccf2bf987cf","963f2349-ba1f-499d-83ed-7283701d30e2","290c87e0-c3d7-425f-805d-b9b4b6efcaaa","51b76552-817d-4584-b797-3bf52cfa2b26","80b03c00-1e87-4021-a63e-2421a0977634","30e30af9-e930-4ce6-ae7e-89d721d39aee","d8121cf8-1730-460e-a95f-b6292ac67161","15f9618e-38e6-4211-bd74-b91c3981679d","ebc2445f-781c-4d5c-b875-4e3d8724651d","adebbbdf-2fce-4fde-8265-81f5e1efbdfe","2c0069d2-3b9b-48aa-a6e2-1a5c31a164cb","f7d0a693-41ec-4989-927a-857ece80a2ec","aab08c9d-2a07-4421-945c-93078ddc77b9","e73ddab9-e0d1-4c21-8143-8ce660b5d996","ae147834-d99d-43f7-9366-78ae29cca957","3c82c33e-f614-4220-9dc9-b6c836a15ff5","95b861c1-7d0b-4559-99c7-525b42ec1638","787c6f9f-cc90-4ca2-9756-bf139c229898","b94a9963-2a8a-44ca-9b84-5d7a947a3af5","f10a4e67-e2b9-4427-a098-59fb2b222026","9edc95cf-2be3-47e6-bdfa-6876f3f4523e","cc1685d3-1df0-4755-a949-99014fe6729c","8ec49fa1-e06b-40de-8cde-b4a844c1ff66","f78c386d-9f26-4120-b618-fec2129961e3","72db3534-c9cc-4128-82c6-abb8b161d4c7","f35f9168-eb04-4923-92cd-748332358ebd","a441ec16-a2b7-4fa1-81cf-f52c0bc9f21f","861e8ee9-2589-45b0-9af6-fb1171322024","d0caa958-ea2a-4312-9827-04db2e40ee75","b2f15a9a-0a02-491e-9ece-5f41cbf3e4fa","265241e0-dbf0-4f5b-92b7-39be6da84890","f09462aa-733d-486a-be4c-6f8fc10f0024","c8de7e15-4718-49b0-af35-146e3fd86323","24aa25f6-2b87-4966-b685-728c554e5fac","bbc68cbb-4805-49d0-97d7-5f245342221e","51f712e5-d9b6-46cf-b728-42bca34f9b71","79395218-51d8-46b3-832a-539a0503a7a5","17a89bad-64de-4023-a8fa-abc767c6f7e2","f10e79c3-6600-4325-bd48-28aa46005dcc","595424ff-023d-40a5-b15f-0c7bbf5a5b03","5217b6df-a3c7-4b81-a8d5-dadbbc4fa678","4528d5a9-81f6-4d22-91fb-e78c68cc4913","b3f5211b-e577-4333-8ddf-95d4882047e0","cf4d5436-e1b6-4362-9dfc-490cb2ddfc93","c305a8ce-1a58-4a51-bc9d-616d37838c3b","167b28a5-b3d8-495e-a237-455911cf7d4f","ebc99bf9-b44a-4e3f-9442-f24620e721fa","617a8e0c-8c7e-45fa-b360-4c84a5b33bbf","4024820b-54b2-4646-bb82-b5f3524d8d68","d2c2e427-e2b9-4841-a6e6-13e5f9917cee","6200be0c-e6ba-4986-b0d5-e72226836757","e6a19b61-8977-4d76-964f-25aec075defa","7326c74a-8a69-4034-893a-ab028f69cab2","07994b4d-2336-463d-9fb3-4ef4e018d827","31ebbbbd-05ce-40ce-bc57-afb2b416733c","0fa1ce05-07b3-435f-ba36-f76dfc97d481","eed5a3f0-c9e8-4ef1-a5d7-3a5bf0ee5ad7","6077454a-d706-46a1-9f9c-91e091703e49","c0e89b6f-3cdb-43d5-bb9b-6c961b2e8f24","3c0d6990-3aca-4354-9abc-15894e1b9f2f","1176feca-64f3-4be0-a96a-4525608789ad","0b2e771a-0f55-46d8-acba-100d28db823c","6202c1b3-8681-47bc-bb94-57b0bd707b80","85f718d6-33f0-4286-ae41-8e89a6bfb937","96e70545-03c4-4192-8aee-27543803cf6b","34b9c6b3-b2b9-4d46-b53a-c744330fdb09","77e0f699-eb41-49d3-a83a-8e8d03acab74","42f19ddb-c8a2-409d-8709-86b2e91a3d36","e9ed4ad3-1f21-4b2b-ba27-4fb72578029b","271f02f4-e072-4628-9c55-b00f28625b06","9598847a-4881-47de-ab5d-3ada485a89d0","0eaefe3b-3cee-46ae-963b-5737f6360398","60414f73-672c-49c7-8907-e205d5522486","47159a96-1783-4613-956d-4828a21a4164","76f389a4-c116-4b87-9f8d-64dca8393e7c","5c6e8aa4-a61b-49c1-a3ef-d75c89164616","dd67ef3e-df49-4c5f-85eb-72fd71895560","3c52ef0c-a22b-4038-835b-014cb9e8d8e9","271fa691-76b0-4231-8bfd-32c540f81a96","25e3f570-22be-4e1c-ac49-c08bf79165ae","3458c90f-3fa2-4928-a3dd-5acaae6eea34","6d07c097-7d23-4e57-aa8e-9053d001aee4","bb7deef9-1e40-44d6-a1f1-73bfddd3504d","eb209c6c-ddf3-4fb3-ab2a-34d1c7dfd428","4c4e38bf-515a-4417-9a60-2da10d36cf57","cfa604c7-4fcd-43b6-9939-55ccc498c2ff","2fff3d1f-f10f-4ef6-b2ee-3a44f030a369","002da505-ca75-408c-9dfc-714eea6e29f4","1febf1cc-5c4d-4a1a-a107-8d06a9057df2","b7805a51-35aa-42c7-b15f-258a3ac60809","2a009518-0457-4a05-94c6-19eafe260ee6","2ddf6230-6f74-4b7a-97e9-35e7e036de85","a1e8595c-3e85-483a-8f4f-65fbf76c8515","2e9e7bde-34ba-43e9-a6c5-8d997a38a537","65e566d5-783b-4799-8215-29b38334e6e6","e249bfac-140f-4423-a51f-f2c82e5cb54e","104d8703-2af7-4dd1-ba97-a45968b569c9","5895cf22-ef5a-43bd-928c-77e6807e0d7e","dc98c818-8ace-43f6-9491-435661105641","96831228-071a-42e7-b465-1a5484103ef4","ac551fcc-623d-4507-a278-640a9e4c4bcf","bed23bb1-a8f4-4a0e-aee1-be93d021306a","0fe6c7dd-4fcc-46aa-9e01-1c4c4ca5a0e1","bad62ced-af27-41e2-aff8-3205d4da966f","7f9c7857-8432-4ca6-a829-82a09d75fd13","a0ef240d-ad54-43cb-954d-c9ee121b10f2","94bcc96f-97ef-4019-84a4-82d301f963ee","1f9234a2-ad02-49b9-bd92-789111c8cebd","11f29a04-e061-4b68-9963-0db68e73476f","7fbdc640-38ab-4c14-b265-a54cdba68f1f","637414f5-cf10-437b-a85b-6e16e08cad5c","dabec4ad-51b9-40bb-9932-78f718b693ca","311d7075-3f88-4261-ae7f-bb1a629843a9","f79af183-e0b8-4944-b226-2a2763f18592","b435e305-b469-4c4f-bdb9-4258b9279b9d","c9efb60f-f8c7-43c0-8c88-a9d72509d488","12726ac4-a023-44be-8362-cbdc50999825","2a50c46b-4b55-4487-920b-6ccae1b9cb64","98d8d3e9-c3d3-4ca5-a09f-fe1287ef560c","f4e9e5a0-d5f6-4531-ac48-1d905a0da32d","48257062-9ec1-4e38-acf2-f27405002098","27bfa5f6-929a-4793-81ba-3fa38e1c1f90","47b28b93-84cc-4fc2-bc18-f920e3b8648b","46d08563-8eb6-4805-9044-f17884898793","9294005c-c000-4889-b5f3-09d60c0eec8f","deb55c96-3ade-423f-85e6-ff285d8c3ea1","99ef6b09-5963-47ec-aec1-d01c4e12a6b5","e79aa22a-e8de-4324-a32e-4a6dc3d0a603","99601028-4d67-4c06-94be-26239df4fce7","07c2379f-f195-4551-ac0f-8dfaac1dc43e","53d0bd4d-f072-4795-9b46-f1da1dddd861","edcf6a17-6054-4941-98c8-675141b461f1","4f819984-811c-4433-8ea6-8ddb99bb3aaa","7aa062b5-3318-45a2-a8db-568788f1462a","d511693a-67a3-4f57-9a3e-a85e42b9fb36","e4ebe0c2-0ce8-46e9-b9d0-fb8b30ffe2f8","fb5152e4-08c9-4282-b6aa-937e7392fee6","37d4bc69-201f-43c3-9687-18dc887b769c","634c45d1-8ea2-4276-8850-87f7659158a8","a3d9a07d-6b5d-4204-af60-46ee5953a5f8","70cc8bbc-b80f-4dba-8dea-a5256abb9205","e3ffe77d-7427-403b-9081-218e28e8cd27","ccfa7765-0956-4769-9f16-01aa6e30a1de","bdd7e87a-4b93-45d5-b5dd-200794ea2fcb","b4a00697-bb6c-4662-af8b-ca95624d5602","f5aee3a4-71e0-4c65-9e75-632dc5463ccf","143c2847-5c96-48cf-9f4c-be552bc5729a","e602f0e2-05ca-48b1-b28b-a3f3aa481131","5a057b69-a05e-42bc-84c2-777418f5fe97","b1c8bca4-863a-46d6-8fa0-c9eb310fa945","835b9c3b-1cfb-479a-b33c-8f24fa1386b5","3156530a-f2b2-4c0a-b474-ba287e3c4128","32ed6c77-d074-401a-9689-89841c9cd9b5","cb98759b-440c-4bd3-a475-b65c78a59f5d","0b66028b-72dc-4991-93f0-156e3edd860b","7d1d302b-5a1e-451b-a89b-fe7e8f0365bb","22895914-a16c-4a96-a226-c956ce6e08bf","e9732804-a1a8-43df-94c6-c75bd0a7ce82","51b41ddb-2650-408f-9354-ad5e5026a84f","de61c7bf-c9c2-41c9-af18-4306e8bf1d65","7bca14c4-0e42-4128-9d7b-d39aa1c5adb4","6f32a536-2971-43e1-94fe-e3b19f8b94e7","5702a36e-b3d5-47be-813d-d6e4bb82f6e4","ab83eb4d-5890-44c9-8500-b79a13c19d7e","3f9914fe-576e-436d-b843-6bc73104ea9a","8c7e25d8-6b98-4530-b637-e376ce684afd","9d149193-02bd-4b34-ba4b-5e92151de04e","258f8d57-e5a9-451b-b5e6-6dd34fd16cc8","92b5d84d-e73b-49c5-869d-a40c0edabe22","6a3b2556-c8c9-48cc-8616-76cddc14bbb1","beaacd9a-91e3-45b7-b688-69a9e565db15","0dbdcd89-9801-4fac-ac00-79d4692b34d3","3bfcf249-fe2a-4af5-8b93-e6ad5f24b2f3","76e3462c-1a0d-43a6-8a8a-522ec032b147","2ffa5ea8-31e9-4925-8a78-3872e39c7427","67bbb860-6a14-40e9-abde-d9cf690ed14f","71172d4c-9aeb-4cb3-a1bd-63cad591d790","f2efa29d-f2c0-4373-8367-2c325735879e","0ce509f0-5861-43be-ad83-a719c43aac37","936eefe4-a5ec-4b6d-a49b-589bc2aebbe8","0ec99a45-b807-4b29-ae67-0f0dce1fc727","fd55ce14-7e4d-482f-96d2-2d1dae170c52","d83dd4d1-96e2-41e4-9570-6972d95de695","cfbf0c0c-ad34-4e0e-92d6-931e182a267d","c8ef9373-617b-4810-b487-835d51b79cb8","40fcb90b-587b-4686-ae62-244b4014f706","83363f5c-b1a0-4b00-98e5-2f575c750221","e89a68b4-2e69-4651-b187-b3f4a6f41381","86a46dfa-af9f-4b7a-ae30-378cdea373da","29a37726-8024-472d-99ff-86c116922baa","420f3747-2ae7-4b0c-a1f4-02bb6ea7b5f0","3984b515-020e-45cf-af2f-41261a215b1e","94ce93e9-b874-40c5-923a-09da3a370c11","f538b405-2de6-472c-b95c-e02182ad74fe","1dd17974-90a1-41e6-ad38-f18a18acc900","425c71fe-a619-4446-9b08-1b05cac5d698","f3e6f19f-4fef-49e3-950e-7323242bf9a0","7d5ea393-ecb8-4b49-985f-ba43f0a08ba3","37b6421d-9aa0-42fb-a40f-8bf94ddc92c2","286cfb95-0a71-4037-a524-6053b486fbad","469ad4f0-34ac-48df-bb0a-8147d1c154e5","7d7959f9-65c4-4f5a-990b-bd56f4c55d78","b1d5cbde-a4fc-4645-9917-f4ffc1cebd74","053f3146-963f-415c-9c41-7c248c1878d9","e293ef4d-54d5-45f6-aad7-c1791ac32387","1e3997d7-570e-485a-93b4-2df03a9313d1","07a2f681-a3d8-4599-a815-42b0868f421d","7bc59a0a-2c0a-470c-b671-befb25795f9b","bcfc3678-bd5b-4b5a-b0ea-5b39eaa04a8c","f61d3a83-46b2-4fe2-9db0-6d0d2d628c29","ef80d45f-6ba3-4f18-970f-b36a62d5f3db","6c524ec8-4bd2-4563-93aa-67b6cfaa8e94","33689104-af4f-48d3-9cb2-39720daf81e2","01056a76-4bbe-44e0-a957-8bad6278d2e0","e5c9e786-428c-4849-8045-ff840c987002","e06ff687-669e-498f-92aa-deecf09c345b","fe377eae-2d31-46b1-844e-fb436e8d24e3","f8b0329e-1845-4ffd-a4fa-017cce83dbc8","c87c1200-1217-4a7b-9ea8-66cc7ee097fb","4187eb11-0ece-4972-901e-fc5dc12bb404","21df5bcb-dfa0-4984-b0e8-20413dcbe9af","142bd433-510c-49cc-95b3-3ed19dbd95d5","fe49a170-c4f4-49d9-a33b-fa1257d82acb","7cf3ea81-23f9-473f-877d-ef99cb2e2fd9","be58f929-b4e8-46c6-9ae5-0b12e25de8bb","c7c1f5ad-0357-4999-9bea-e2362df412d0","7375f8c3-6559-43d1-87f5-845d079bf2cf","4cb8f73c-92e3-4932-b3c8-c1117e128c1b","61c15eb9-e126-49fc-b639-f1afeee8c103","a7f8e779-6643-485c-8c1f-55f69c255154","5964c691-1595-4ae6-b7c4-f831b1126b3d","6b0610e0-118b-44ae-8e57-b3f742582fdf","689af944-8c1f-482a-83c4-b2b9a174f1d3","9f2d9a77-c0f3-449f-b1ba-a54ce5f05eec","1985647c-3c72-4b5d-abc2-89b19071b2e9","5a5058a4-c01e-480d-b6d7-588bd8f5b446","03c400ad-cd7e-4fb5-9d6b-d97b6db0f153","32647d6d-8a90-42e3-8cf9-c2dd4e77eb74","fcbef31b-7be6-4bae-a00f-8afe0887264c","8eabba7f-de63-49c0-97af-82cc64ee232d","f3e91adb-c550-45e4-84d8-15d5a7cac9b4","e2ffec01-7a66-46a2-9b25-921a54dbc6bb","f9040b17-e05f-4b22-b749-5ed8b9752216","f0eceec3-8d0b-41a0-8a9a-d8bcf6adf9b9","21bbf2f3-298e-4a0f-a659-3a50ee52b2cf","2c7568f3-be23-4263-84fa-61e3f6e18a7e","79eb9703-e9ab-4546-94ff-be9e6fe017ae","5ce9314b-7799-4693-87e5-b6660bef10a6","3379acd7-c511-4bba-b86f-fca79abdf9f5","f877833c-fbd7-4300-889c-28ca866e5ba3","8a99ef18-0e87-4523-8a02-9a6b9dbcf2e4","a1028ed7-4893-4014-b2ea-1661cd654a36","fd5169aa-43dd-4ee1-95fb-afb5cfe7a9c1","a07cc903-6fce-4fcc-8af1-5ad8d0b8e6bd","04aa1897-839c-49a0-9020-5320dcbc25e0","e0bee6a3-c1fc-4b44-9520-c340863e8972","0a003b99-2a28-43bd-a6c6-4310a22a9764","3cb11076-4608-460c-82cc-c2f0dadb1ae9","f8a523da-d02a-4c01-a999-55f3ae63067d","3b3edbe7-3adf-4731-ae06-f602db42c02a","ee534231-78b5-4728-b72f-ebe8dc1296df","cbea918d-36bb-4765-b532-da5af49c1ea6","305542fe-6617-4275-8287-d8e24cd6ec2f","a82bd30b-35c1-449a-ab06-8dfd4f4d7d8e","a7323704-1200-4722-9326-eb448df64c7a","e709b78f-18c7-4f75-850c-6e40303a615e","a93ca515-b6a7-4d32-89cd-cf415ea6cf63","59d7646c-5040-4feb-9267-bbb15b291dd3","68c30f4e-13f7-421f-b85f-0d683a5a0f02","7fb0d3aa-b810-4ad5-b9e8-9f90e7043e7b","373fbc70-4090-4416-8698-75b327392a36","a42e12b0-a4c8-4bd9-aa93-dbb4e63d732d","2d25e070-033e-4efc-87a7-4696bf32ecb7","f7fb4b47-9cfc-4d98-bf2a-62b115fbf221","4ea7e0a5-4e6e-4943-a98e-5621b061dbea","a0f565b9-4ea9-4dec-8495-c91626753569","d3c2bf97-ab2e-4f7d-b95a-f6c3bc932a45","86a57fb8-504d-4a0f-bb69-3be73db439e3","0ed06719-a88b-4c0a-98c6-271c17492dea","64cb8749-be67-4aca-94c0-bdd5341e9a21","6e183044-d47c-4eb4-94c1-b77a14be9327","722623f4-d118-4c92-814f-03c200786585","55c13f34-dc87-4570-a53e-8dd4102c1270","0cb5653f-4584-4048-b336-ccbfe2a34ceb","647ca2e5-cad4-47fa-badc-c2511540dce8","3f61fa77-f7bf-44bb-92ad-0b2dcef075bd","7603043b-7d7d-482b-981d-b39a3368b174","e554301c-7d53-4d81-abdf-4ccf18da1ae2","c2b6fda1-48fb-4d50-8a58-9bf91faac488","1755c321-6a57-4121-a622-ed79ba39ee76","0fd6f7c9-1305-4eeb-aa68-7ffe2c8e8451","7f43e312-ff64-423e-9379-6681512c90b1","afeddfff-deaa-47bd-965b-91cc51e50c26","7c864157-d3cb-4bd7-900d-7100fe854218","50a411a9-166a-432c-b835-e6519101edbc","47cb439f-3bea-4561-8580-84383ed9bedc","fbade44a-0dd9-45e5-9fca-826a7906a6ba","f1fdbf3c-15ec-4eb9-b44c-98dc241da7a3","b3bb9bab-7454-43e9-8847-4d60a3a0f783","e9143b9d-c786-43a3-9940-1e70678f2773","65a55569-3738-4f18-93c8-5ae64a8611f3","b4e09f50-dea3-4d32-afe3-6437747bb6d5","2c537cfa-1809-49f5-8392-0b639516d67a","ff7027b8-cfc7-4320-81d7-e8b6e9f83f44","1cddefe2-f82f-43f9-96ce-cae96acefb9d","ff6228f0-89b3-411f-a5c5-06f157ab1321","db3526b7-c80d-49a3-99be-11a0f31f06fc","60ba6a13-617c-439a-9193-f186c736e135","5b7c237d-e50a-4da6-acd7-3e4d032c8d2e","b4b6e852-bbc3-44fa-b70c-56f4885a7802","f1a4bf02-31e3-43e6-a7ce-a8614df662b5","f17f417c-1961-4f22-8cab-640fd92de787","fa307aa4-8fad-4789-b43c-53858081052a","b7af699a-a0f9-4a86-a5d7-233deb6f1b7e","4a01b74e-4d86-4983-8f50-e74a984c56b0","93b9e5d6-0e2a-4260-87fd-e29fb72504fd","a2d80135-1ae7-4c8f-81de-0e40ffa9cdc1","a4ab5c9e-fed4-42d9-aaef-480d256ca3b5","e14d3ed0-3649-4497-87fc-13fec038b282","fc8359fa-63e3-4ad7-913d-74566b5010b4","e1e0fa3b-7f50-402d-95b7-e7293ae14616","2e522179-1605-40d6-b140-28dc55853d0c","b992578e-39d1-43cd-adba-770419ad09f6","0635d170-35ab-44ce-9b8f-6b290184bcdb","fa451cdb-ded9-48cf-91bd-af64b461093d","d8074a0a-5c68-41ca-9cd7-d95f71028cff","1241a96f-9a7c-4dd9-9e27-32bfd5d7b347","b017554a-ea14-422f-aefe-60cd37f3fdf8","b21197da-4051-4599-a340-600d166f0c99","2c5eabea-eb86-4ea5-8525-b5f5e53f8b0a","044ca752-d0ff-470b-9edb-39b83e9a1a34","9f30a17a-6229-4614-862e-3f20faeb8fba","f7fd0392-77e6-4f4c-97bd-db6a3bfb5faf","52d9303a-a111-4b00-80b3-214923559c91","d7f4868d-9bd1-4130-9e27-8afe3a4f85a6","13ac80e2-7237-4012-b448-06c04574b2f1","001cdb2c-0019-4c81-bc03-b3f8e5532072","f28f900b-6484-4239-804c-c1b5aa8ec52d","bbbebc9e-a179-4f5b-a808-dab0bd9c9a10","cfd080ed-56a5-4704-9a1e-a9712bb3e60f","510b0d65-7f4d-462a-ab84-879b4aad1cbf","70b83528-e550-4759-bf16-69d792b613e1","0c0d8f01-c3ee-4e62-bd69-e8bf24bd9919","b453a8f6-5b10-4156-bc2f-2cc1d7be4155","0c224398-ec51-4652-9aa9-56fba7271816","aaeaaace-5ec8-4479-a5f4-e778c4cbfd86","9ffda0d6-7b7d-439f-93cc-4dc5419a17aa","d1267146-195b-4517-aa97-cb1631ceb9e4","738a0caf-f725-42f9-8f65-310f6a0b02af","5e7129aa-d21b-4113-88d5-c796ffc81f23","bc7c04db-82d1-42ac-8e11-33d33f873dc2","42f27465-fecf-46cd-8f8c-9fc8ef92cb59","68003234-d959-4dbd-9c9f-53955a042fbb","2b8063d0-26e1-4c5b-80c2-c55f24bede9b","c22d3597-17d3-454b-9e8d-0efeb48da9c9","344eb79a-82f5-47c7-8341-81ec2cc5e68c","115e59b5-120e-4304-988f-f70e4e993e7c","b772715b-b3f7-4af7-b9ce-92c1f4590ff2","f25b9de0-5cac-481d-ba11-50c7b528e800","fdd50d40-189a-4426-85a7-b134b0156a06","0613a574-d019-40e2-9671-359b25f1e19c","624ca5b8-1554-4812-8c1b-73d07fcf4d68","6adfa937-e72b-4fbf-a172-05886d3d8b75","f0cfb380-5039-45b3-a25c-624a77d9b19b","c99b4b8b-c9f5-46c6-9ccd-46cbea6eeb60"] |
| CHEGOU       | CHEGOU       | 44         | ["11cd698f-db07-429f-89aa-7fe40b4e263d","026a4b95-440e-41e0-8434-bce90c809087","36329608-c08a-426c-8a58-845078c8ea23","63d71878-01d7-4055-b886-c9851dcda119","bfebe7de-f824-452f-94ea-f83dbb779e1b","36f612db-54e2-4d4c-a7de-63bd1787aad9","c9a83a82-e42a-4034-bdac-e81f8febe8d8","c73a98c3-c5b0-4479-a206-299608c9a1db","542c0e60-4812-4daa-b2c2-fb2232ccbf03","f5a96aaf-8120-4c8d-bc83-20171bec84a7","683660d7-25f5-4075-9e01-f20d89b4c294","48aa41a4-1d80-4b35-99ee-559ef013ce43","6c97383a-e103-42ac-9e2a-59631d0c605e","f84f851d-ae4a-4542-a5af-7c5d718f5cd3","c36e1374-76a0-418b-a5f8-f8baff1a0ea9","3363e27f-bb2f-4f39-bf80-ec3216785613","137a7b61-4651-4b66-8a75-03963ff20100","718bceee-c56e-48b5-b12e-e79b77bb191c","8859f85b-6641-4b78-a70b-c930752ff81c","97045835-c11e-4f8e-a7ee-cb1952bc16cd","0645acec-3ef7-453c-bb2e-ce84f0dc4d3c","e9e9edd0-81fa-4a51-b22f-82d988e9c20f","094aee10-f22a-4a8c-af46-6a7da3b38305","bba4a724-80ad-4ed9-ad2e-f9c5636304ca","ba737945-e2a4-48ac-b3bd-6e5b20f4bc09","d4d95b38-4e30-4723-8396-a9b2d78d9974","245ced2e-d8f3-47b6-a0da-742f3a0bae12","b0b1589d-693e-48f9-99c6-50fde3555513","3fc36efa-f56d-4a96-8340-f3ee1d87bf0b","69c22883-8313-4600-9589-3b19a6372ecb","b6d801e8-e5cc-4b29-b9f3-688555c85453","6a7463af-21ed-4f2c-8453-51a1d226548e","291cbdc2-d701-4c1a-9333-de21038b8036","1ae9f3d3-cfd1-4ee2-814c-1ae1fd982a2e","bbd3fc50-1fe3-4b8e-83bd-ef09f48ad7b2","209d91dc-fe1c-42f9-a4ed-c097facb3ec2","557943b2-c234-447f-a654-d0786769a363","88c4d063-ee01-4b7d-8403-5a22331c5d45","69749e8b-7129-47b2-9c1b-aafbfcebf87d","4737bf19-a5ad-4df5-a7e3-00ba292966f4","f538e055-00f3-4ab5-a91a-aac9ea598ee5","f1f8e925-b175-4eeb-aa20-1215447c98ca","b4630636-7cbe-4c28-9c0d-16d73c1fb0a6","069e36b5-dba4-4fdf-abb3-82f9e3d2ae1a"]                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |
| CANCELADO    | CANCELADO    | 41         | ["18ebd8aa-7245-4355-9ffe-87188ab91575","e73ccccb-9b6b-4205-9241-d039b750dffe","4aed3301-8917-4ce5-81c3-9dc6d78adc7c","4ebd9fc3-7bc6-4011-a4af-904f4fc495da","badbc8a0-98e4-48a4-acaa-b751d756e7d7","e6ac648d-2ac2-4d18-929d-b97b3427de9e","b33b58a3-5ab2-4084-a2ba-c1fc504ecb85","8b59aea5-4361-4507-9cd7-775435a3a678","452bf272-ca55-4b3f-b6cd-32c8db7931a3","bfdfe55a-2dff-4838-93e7-cedaeb933555","e1f37378-46f2-453a-be49-e827498b9536","3d0b033a-a37a-413a-9319-0e286d7c14cc","7157c9b5-8e6e-484f-8c57-f3f2668eebff","bca0c89e-323d-426f-81b7-3441eb62f31c","313292bf-8980-4b7a-9c2e-b6965d940006","3c5f977f-bfc8-47aa-994a-4ac52b458ffa","61817441-30e0-435e-b332-02eb5241ef6e","828585d2-f019-4ac9-a90a-9a7e6ac802b4","1ff98de4-ab27-41c3-ae49-94e4ea99885b","c0544f59-51c5-445e-956e-963dfb6fdeb8","7a11b8e8-a474-42d2-97fa-dca0e33b6baa","55472a8d-4037-4977-b2bd-266e3ad813c6","b8bd3026-65ca-4926-aea3-f6ffffb78f5a","401deaf2-cdf4-43c2-bdf1-f95a2a206b68","9128d5d8-d939-4ffb-8bdf-50ce52680c7c","3c044658-75d9-4733-8476-411966857cc7","55cdcb12-47da-4f2d-9e55-966bcec26d23","732e5e52-8adc-45cf-a05e-c806598031c2","5502573b-a973-406c-894b-dfd2a8ea8e01","813054c9-397b-4b72-a064-e14157610d4d","50a27016-2640-4b4d-a698-93c568f31ec6","825cf2a9-a411-4e55-9e40-af85da46ebf3","72af2fb2-e7c1-4ab1-9122-19e3e53c4644","f268e693-1813-476b-9c85-3fd9b9c725ee","8a202b0a-80b4-4bc7-af4b-d0e893920503","e447ffd0-6e56-4480-ae75-b6ff360aaed4","a89610cd-3264-4d6e-8569-7ab5794934ae","1e3417ca-46da-4835-add0-35f4e708f9eb","fba5c0c2-7e29-4cbb-82aa-72ad9fbee9a2","560379b7-95b5-4d70-b7a8-ff72d3196fcc","32620040-7a32-454e-9b79-7225fa8c00c1"]                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |
| PRODUCAO     | PRODUCAO     | 29         | ["aeb9d187-491a-47db-afb1-828dcb760089","6c75d926-452c-4745-a3d1-bd97020cd82b","78c44a99-8f71-4c69-adf1-b1d228e9aa12","1fbfa297-a1f1-48ac-a6c2-129a4b1f97bf","1d6cc18e-6e6b-48d8-a30b-ad924b10fb87","d50ba831-e23c-4780-85c1-55c03cf1d2b3","6c042a43-c816-4555-a998-3f776badd662","3dedea00-4b82-4df0-aa92-e7a731e43bab","24b55d6a-2938-4ca5-a55b-313cb891d0da","9b99fe5b-2009-4e12-ada9-941ddbc0803b","d12459a9-4495-4d51-af6b-3793c016bf77","d4622412-2d7c-4e45-9a56-48d5d077733d","6ea130a7-315e-4ef7-ac36-c53cd0f69471","bc5c0c78-cb20-4222-b790-369aacbc0104","d7e07c74-b2eb-4e32-860f-cc7ec854dcf2","0b08471d-fcb8-4546-ad9d-c81d8f4ffa27","f9f7797e-604f-4ae4-8a9d-932a6faafb74","1815b013-6c3e-4417-94d0-373a3513184c","4ccfe03f-eb8f-4b9d-83cc-c9cc5c9cf8f2","e4a74dfc-c1a2-4b0c-bdf0-39a3c307a9bf","3b88e229-1a64-4bdf-be0a-962df4cdd1fc","d7c6ea22-21b0-4108-b961-851b7819cd5f","33dd07b2-c3ef-4845-8351-e21ee78dd359","3e124cf7-77c8-41fb-b13e-e3a7ac3c1247","ebd0c4cb-35e7-47be-8bd6-db227ae9666e","86605cc1-849a-41bc-a4b5-5c86f4b2e044","a6d4847d-1f1f-47d0-a619-59e46801e8b3","3f63121e-534b-4287-ae6b-f09f18947273","5fe4efa1-423e-4d0e-8e25-238bbf1c1385"]                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
| ENVIADO      | ENVIADO      | 19         | ["c194179b-8e6d-488f-a388-29242b54095c","988a106e-5ba1-406a-991f-7be35dced4b4","493d9300-5bd7-48b9-ae12-8d7b9dc174d7","4eba0375-bb43-4fa1-8e46-956ae357717d","0df4535e-e39c-4b1c-9a83-4985158cf0ba","3e7a4185-bcc6-4bf8-8945-49bed640771b","f8690f7a-e09e-48a4-af3f-abef417e180d","75dd6131-9ba5-4d10-bcdc-57f52a89be91","6a1be3ee-a0d2-408a-aa86-c823d2218635","11de6da3-c1ce-47ce-b8f2-a540026f9458","4fc18d0b-72e2-403a-bc35-9a8df511e599","ff627e2c-b227-4d0a-b10f-4c915e98677e","4651da99-85e9-431f-884c-f707e6ede76d","13214ef2-d410-4581-940b-318b50b1803f","2e7f5bb1-d6d6-4bfe-9733-f152fc3cc584","b3bfc123-174e-41a8-a698-051a64501be8","f3b74358-a11d-4235-8539-aeb80bea404b","980add89-67dd-4bc9-9f23-0147b16d1db5","40c404fd-9257-4ce2-8a73-904972b330f1"]                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |
| AG_PAGAMENTO | AG_PAGAMENTO | 10         | ["d747b999-694c-4ad8-a9dc-519fb4d51579","b9374462-ac98-4b4a-984d-8fe65aaa9194","e9457472-1ba7-40fb-aac8-d19c60aeb6e7","1512d395-ccdb-415c-8379-e9f2077c9413","3acaace0-78b4-4d5d-a567-812f43534c5e","fb650ea1-670f-4194-91f5-982710d15333","74f9f01a-5644-489d-8f6c-f37e640a0cbe","30b73620-1724-4303-90b2-2b63b6b6f488","a309317e-1121-497f-91d3-57117e0ca4ed","6e776b62-2f3d-47cb-86ac-dbaf86b54c1c"]                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
| PRONTO       | PRONTO       | 2          | ["6d5c0a69-1baa-475a-86ad-a2f04b2a48f9","73b8f5a3-3b7c-4644-806d-8d7585a41412"]                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |



-- 4. Testar query EXATA que o Kanban usa
SELECT COUNT(*) as total_kanban
FROM v_pedidos_kanban
WHERE status NOT IN ('ENTREGUE', 'CANCELADO');
-- Se retornar 0, o problema é o case!

| total_kanban |
| ------------ |
| 104          |


-- 5. Testar query com minúsculas
SELECT COUNT(*) as total_minusculas
FROM v_pedidos_kanban
WHERE status NOT IN ('entregue', 'cancelado');

| total_minusculas |
| ---------------- |
| 639              |


-- Se retornar >0, confirma que banco usa minúsculas

-- 6. Ver ENUM exato com hexadecimal (para detectar espaços/chars especiais)
SELECT 
  enumlabel,
  enumsortorder,
  LENGTH(enumlabel) as tamanho,
  encode(enumlabel::bytea, 'hex') as hex_value,
  UPPER(enumlabel) as versao_maiuscula
FROM pg_enum
WHERE enumtypid = 'status_pedido'::regtype
ORDER BY enumsortorder;


| enumlabel | enumsortorder | tamanho | hex_value        | versao_maiuscula |
| --------- | ------------- | ------- | ---------------- | ---------------- |
| pendente  | 1             | 8       | 70656e64656e7465 | PENDENTE         |
| pago      | 2             | 4       | 7061676f         | PAGO             |
| producao  | 3             | 8       | 70726f647563616f | PRODUCAO         |
| pronto    | 4             | 6       | 70726f6e746f     | PRONTO           |
| enviado   | 5             | 7       | 656e766961646f   | ENVIADO          |
| entregue  | 6             | 8       | 656e747265677565 | ENTREGUE         |
| MONTAGEM  | 7             | 8       | 4d4f4e544147454d | MONTAGEM         |



-- 7. Verificar se há alguma função/trigger convertendo valores
SELECT 
  routine_name,
  routine_definition
FROM information_schema.routines
WHERE routine_definition ILIKE '%status%'
  AND routine_schema = 'public'
  AND routine_type = 'FUNCTION';


| routine_name                    | routine_definition                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
| ------------------------------- | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| simular_evolucao_pedidos        | 
DECLARE
  pedido RECORD;
  data_evento DATE;
  contador INT := 0;
BEGIN
  -- Para cada pedido, simular evolução realista de status
  FOR pedido IN 
    SELECT id, data_pedido, status, prioridade, laboratorio_id, classe_lente_id
    FROM pedidos 
    ORDER BY data_pedido
  LOOP
    data_evento := pedido.data_pedido;
    
    -- Simular evolução de status com datas realistas
    IF pedido.status IN ('PAGO', 'PRODUCAO', 'PRONTO', 'ENVIADO', 'CHEGOU', 'ENTREGUE') THEN
      -- Atualizar data_pagamento
      UPDATE pedidos 
      SET data_pagamento = data_evento + INTERVAL '1 day'
      WHERE id = pedido.id AND data_pagamento IS NULL;
      
      data_evento := data_evento + INTERVAL '1 day';
    END IF;
    
    IF pedido.status IN ('PRODUCAO', 'PRONTO', 'ENVIADO', 'CHEGOU', 'ENTREGUE') THEN
      -- Simular início de produção
      UPDATE pedidos 
      SET data_inicio_producao = data_evento + INTERVAL '2 days'
      WHERE id = pedido.id AND data_inicio_producao IS NULL;
      
      data_evento := data_evento + INTERVAL '2 days';
    END IF;
    
    IF pedido.status IN ('PRONTO', 'ENVIADO', 'CHEGOU', 'ENTREGUE') THEN
      -- Simular conclusão de produção
      UPDATE pedidos 
      SET data_conclusao_producao = data_evento + 
          CASE pedido.prioridade
            WHEN 'URGENTE' THEN INTERVAL '2 days'
            WHEN 'ALTA' THEN INTERVAL '4 days'
            WHEN 'NORMAL' THEN INTERVAL '6 days'
            ELSE INTERVAL '8 days'
          END
      WHERE id = pedido.id AND data_conclusao_producao IS NULL;
      
      data_evento := data_evento + INTERVAL '4 days'; -- média
    END IF;
    
    IF pedido.status = 'ENTREGUE' THEN
      -- Calcular data de entrega realista
      UPDATE pedidos 
      SET data_entregue = data_evento + 
          CASE 
            WHEN random() < 0.80 THEN INTERVAL '1 day'  -- 80% no prazo
            WHEN random() < 0.95 THEN INTERVAL '3 days' -- 15% com atraso leve
            ELSE INTERVAL '7 days'                      -- 5% com atraso severo
          END
      WHERE id = pedido.id;
    END IF;
    
    contador := contador + 1;
    IF contador % 1000 = 0 THEN
      RAISE NOTICE 'Processados % pedidos para evolução...', contador;
    END IF;
  END LOOP;
  
  RETURN 'Evolução simulada para ' || contador || ' pedidos';
END;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |
| concluir_missao                 | 
DECLARE
  resultado JSONB;
  missao_data RECORD;
  pontos_calculados JSONB;
BEGIN
  -- Atualizar a missão
  UPDATE missoes_diarias 
  SET 
    status = 'concluida',
    concluida_em = NOW(),
    executada_por = p_executada_por,
    qualidade_execucao = p_qualidade,
    observacoes_execucao = p_observacoes,
    evidencia_urls = p_evidencia_urls,
    tempo_total_execucao_segundos = EXTRACT(EPOCH FROM (NOW() - COALESCE(iniciada_em, created_at)))::INT,
    updated_at = NOW()
  WHERE id = p_missao_id
  RETURNING * INTO missao_data;
  
  -- Calcular pontos e badges
  pontos_calculados := calcular_pontos_missao(p_missao_id);
  
  -- Atualizar pontos na missão
  UPDATE missoes_diarias 
  SET 
    pontos_base = (pontos_calculados->>'pontos_final')::INT,
    badges_ganhas = ARRAY(SELECT jsonb_array_elements_text(pontos_calculados->'badges_ganhas')),
    multiplicadores_aplicados = pontos_calculados->'multiplicadores'
  WHERE id = p_missao_id;
  
  -- Atualizar stats do usuário
  INSERT INTO usuario_gamificacao (usuario_id, loja_id, pontos_totais_historico, total_missoes_executadas)
  VALUES (p_executada_por::uuid, missao_data.loja_id, (pontos_calculados->>'pontos_final')::INT, 1)
  ON CONFLICT (usuario_id, loja_id) 
  DO UPDATE SET
    pontos_totais_historico = usuario_gamificacao.pontos_totais_historico + (pontos_calculados->>'pontos_final')::INT,
    pontos_hoje = usuario_gamificacao.pontos_hoje + (pontos_calculados->>'pontos_final')::INT,
    total_missoes_executadas = usuario_gamificacao.total_missoes_executadas + 1,
    data_ultima_atividade = CURRENT_DATE,
    data_ultima_missao_completa = NOW(),
    updated_at = NOW();
  
  -- Registrar evento
  INSERT INTO mission_eventos (missao_id, usuario_id, loja_id, tipo_evento, titulo, descricao, dados_evento)
  VALUES (
    p_missao_id, 
    p_executada_por::uuid, 
    missao_data.loja_id,
    'missao_concluida',
    'Missão Concluída',
    'Missão concluída com qualidade ' || p_qualidade || ' estrelas',
    pontos_calculados
  );
  
  RETURN jsonb_build_object(
    'sucesso', true,
    'pontos_final', pontos_calculados->>'pontos_final',
    'badges_ganhas', pontos_calculados->'badges_ganhas',
    'multiplicadores', pontos_calculados->'multiplicadores'
  );
END;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          |
| criar_pedido_com_permissao      | 
DECLARE
    novo_pedido_id uuid;
    novo_numero integer;
BEGIN
    INSERT INTO pedidos (
        loja_id, laboratorio_id, classe_lente_id,
        status, cliente_nome, numero_pedido_laboratorio, created_by
    ) VALUES (
        p_loja_id, p_laboratorio_id, p_classe_lente_id,
        'REGISTRADO', p_cliente_nome, p_numero_pedido_laboratorio, 'api'
    ) RETURNING pedidos.id, pedidos.numero_sequencial 
    INTO novo_pedido_id, novo_numero;
    
    RETURN QUERY SELECT novo_pedido_id, novo_numero;
END;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |
| testar_trigger_sistema          | 
DECLARE
  pedido_teste_id UUID;
BEGIN
  -- Criar pedido teste
  INSERT INTO pedidos (
    numero_sequencial,
    loja_id,
    laboratorio_id, 
    classe_lente_id,
    status,
    prioridade,
    cliente_nome
  ) VALUES (
    999999, -- número teste
    (SELECT id FROM lojas LIMIT 1),
    (SELECT id FROM laboratorios LIMIT 1),
    (SELECT id FROM classes_lente LIMIT 1),
    'REGISTRADO',
    'NORMAL',
    'TESTE TRIGGER'
  ) RETURNING id INTO pedido_teste_id;
  
  RETURN QUERY SELECT 'PEDIDO_CRIADO', 'OK - ID: ' || pedido_teste_id::TEXT;
  
  -- Testar mudança para PAGO
  UPDATE pedidos 
  SET status = 'PAGO'
  WHERE id = pedido_teste_id;
  
  RETURN QUERY SELECT 'MUDANCA_PAGO', 'OK';
  
  -- Testar mudança para ENTREGUE
  UPDATE pedidos 
  SET status = 'ENTREGUE'
  WHERE id = pedido_teste_id;
  
  RETURN QUERY SELECT 'MUDANCA_ENTREGUE', 'OK';
  
  -- Verificar se campos foram preenchidos
  RETURN QUERY 
  SELECT 'VERIFICACAO_CAMPOS', 
         CASE WHEN data_pagamento IS NOT NULL 
              AND data_entregue IS NOT NULL 
              AND data_prometida IS NOT NULL 
              THEN 'SUCESSO - Todos os campos preenchidos' 
              ELSE 'ERRO - Campos faltando: ' ||
                   CASE WHEN data_pagamento IS NULL THEN 'data_pagamento ' ELSE '' END ||
                   CASE WHEN data_entregue IS NULL THEN 'data_entregue ' ELSE '' END ||
                   CASE WHEN data_prometida IS NULL THEN 'data_prometida ' ELSE '' END
              END
  FROM pedidos 
  WHERE id = pedido_teste_id;
  
  -- Verificar se eventos foram criados
  RETURN QUERY
  SELECT 'VERIFICACAO_EVENTOS', 
         'CRIADOS: ' || COUNT(*)::TEXT || ' eventos'
  FROM pedido_eventos pe
  WHERE pe.pedido_id = pedido_teste_id;
  
  -- Mostrar detalhes dos eventos criados
  RETURN QUERY
  SELECT 'EVENTO_' || ROW_NUMBER() OVER (ORDER BY created_at), 
         titulo || ' (' || status_novo || ')'
  FROM pedido_eventos pe
  WHERE pe.pedido_id = pedido_teste_id
  ORDER BY created_at;
  
  -- Limpar teste
  DELETE FROM pedido_eventos WHERE pedido_id = pedido_teste_id;
  DELETE FROM pedidos WHERE id = pedido_teste_id;
  
  RETURN QUERY SELECT 'LIMPEZA', 'OK - Dados de teste removidos';
END;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |
| trigger_pedido_mudanca          | 
BEGIN
  -- Registrar mudança de status
  IF TG_OP = 'UPDATE' AND OLD.status != NEW.status THEN
    INSERT INTO pedido_eventos (
      pedido_id, tipo, titulo, status_anterior, status_novo, automatico
    ) VALUES (
      NEW.id, 
      'STATUS_CHANGE', 
      'Status: ' || OLD.status || ' → ' || NEW.status,
      OLD.status, 
      NEW.status, 
      true
    );
  END IF;
  
  -- Atualizar timestamp
  NEW.updated_at := NOW();
  
  RETURN NEW;
END;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |
| calcular_pontuacao_diaria       | 
DECLARE
  v_pontos_possiveis INTEGER := 0;
  v_pontos_conquistados INTEGER := 0;
  v_missoes_totais INTEGER := 0;
  v_missoes_completadas INTEGER := 0;
  v_percentual DECIMAL(5,2) := 0;
BEGIN
  -- Buscar dados reais das missões da loja na data
  SELECT 
    COUNT(*) as total,
    COUNT(*) FILTER (WHERE status = 'concluida') as completadas,
    COUNT(*) * 50 as possiveis, -- 50 pontos por missão
    COALESCE(SUM(CASE WHEN status = 'concluida' THEN pontos_total ELSE 0 END), 0) as conquistados
  INTO v_missoes_totais, v_missoes_completadas, v_pontos_possiveis, v_pontos_conquistados
  FROM v_missoes_timeline 
  WHERE loja_id = p_loja_id 
    AND data_missao = p_data;
  
  -- Calcular percentual
  IF v_pontos_possiveis > 0 THEN
    v_percentual := (v_pontos_conquistados::DECIMAL / v_pontos_possiveis::DECIMAL) * 100;
  END IF;
  
  -- Inserir ou atualizar registro
  INSERT INTO pontuacao_diaria (
    loja_id, data, pontos_possiveis, pontos_conquistados, 
    missoes_totais, missoes_completadas, percentual_eficiencia
  ) VALUES (
    p_loja_id, p_data, v_pontos_possiveis, v_pontos_conquistados,
    v_missoes_totais, v_missoes_completadas, v_percentual
  )
  ON CONFLICT (loja_id, data) 
  DO UPDATE SET
    pontos_possiveis = EXCLUDED.pontos_possiveis,
    pontos_conquistados = EXCLUDED.pontos_conquistados,
    missoes_totais = EXCLUDED.missoes_totais,
    missoes_completadas = EXCLUDED.missoes_completadas,
    percentual_eficiencia = EXCLUDED.percentual_eficiencia,
    updated_at = NOW();
  
  -- Retornar resultados
  RETURN QUERY SELECT v_pontos_possiveis, v_pontos_conquistados, v_missoes_totais, v_missoes_completadas, v_percentual;
END;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |
| enviar_para_montagem            | 
DECLARE
  v_data_prevista DATE;
  v_montador_nome TEXT;
  v_montador_tipo TEXT;
BEGIN
  -- Calcular data prevista (+3 dias úteis)
  v_data_prevista := calcular_dias_uteis(CURRENT_DATE, 3);
  
  -- Buscar dados do montador
  SELECT nome, tipo 
  INTO v_montador_nome, v_montador_tipo
  FROM montadores 
  WHERE id = p_montador_id;
  
  -- Atualizar pedido
  UPDATE pedidos SET
    status = 'MONTAGEM',
    montador_id = p_montador_id,
    data_envio_montagem = CURRENT_DATE,
    data_prevista_montagem = v_data_prevista,
    updated_at = NOW(),
    updated_by = p_usuario
  WHERE id = p_pedido_id;
  
  -- Registrar evento na timeline
  INSERT INTO pedido_eventos (
    pedido_id, tipo, titulo, descricao, usuario, automatico
  ) VALUES (
    p_pedido_id, 
    'ENVIO_MONTAGEM', 
    'Enviado para montagem',
    format('Enviado para %s (%s). Prazo: %s', 
           v_montador_nome, 
           v_montador_tipo, 
           v_data_prevista::TEXT
    ),
    p_usuario, 
    false
  );
  
  RETURN TRUE;
END;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |
| iniciar_missao                  | 
BEGIN
  UPDATE missoes_diarias 
  SET 
    status = 'ativa',
    iniciada_em = NOW(),
    executada_por = p_usuario,
    updated_at = NOW()
  WHERE id = p_missao_id AND status = 'pendente';
  
  -- Registrar evento
  INSERT INTO mission_eventos (missao_id, usuario_id, tipo_evento, titulo, automatico)
  VALUES (p_missao_id, p_usuario::uuid, 'missao_iniciada', 'Missão Iniciada', false);
  
  RETURN FOUND;
END;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |
| alterar_status_pedido           | 
DECLARE
  status_atual VARCHAR(20);
BEGIN
  SELECT status INTO status_atual FROM pedidos WHERE id = pedido_uuid;
  
  IF NOT FOUND THEN
    RAISE EXCEPTION 'Pedido não encontrado';
  END IF;
  
  UPDATE pedidos SET
    status = novo_status,
    updated_at = NOW()
  WHERE id = pedido_uuid;
  
  IF observacao IS NOT NULL THEN
    PERFORM registrar_evento(
      pedido_uuid, 'NOTE', 'Observação adicionada',
      observacao, NULL, NULL, usuario
    );
  END IF;
  
  RETURN true;
END;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          |
| marcar_pago                     | 
declare
  v_status pedido_status;
  resultado jsonb;
begin
  -- Verificar estado atual
  select status into v_status from pedidos_lab where id = pedido_id;
  
  if v_status not in ('REGISTRADO', 'AG_PAGAMENTO') then
    return jsonb_build_object(
      'sucesso', false,
      'erro', 'Pedido não está em estado válido para pagamento'
    );
  end if;
  
  -- Atualizar pagamento
  update pedidos_lab
  set data_pagamento = p_data_pagamento,
      forma_pagamento = p_forma_pagamento,
      status = 'PAGO',
      updated_by = p_usuario_id,
      pagamento_atrasado = case 
        when data_limite_pagamento is not null and p_data_pagamento > data_limite_pagamento 
        then true else false end
  where id = pedido_id;

  -- Calcular SLA
  perform calcular_datas_pos_pagamento(pedido_id);

  -- Auto-avançar para produção (configurável)
  update pedidos_lab
  set status = 'PRODUCAO'
  where id = pedido_id and status = 'PAGO';
  
  -- Log específico de pagamento
  insert into pedido_eventos (pedido_id, tipo, descricao, detalhes, usuario_id)
  values (
    pedido_id,
    'PAGAMENTO',
    format('Pagamento registrado: %s', p_forma_pagamento),
    jsonb_build_object(
      'data_pagamento', p_data_pagamento,
      'forma_pagamento', p_forma_pagamento,
      'atrasado', (select pagamento_atrasado from pedidos_lab where id = pedido_id)
    ),
    p_usuario_id
  );
  
  return jsonb_build_object(
    'sucesso', true,
    'novo_status', 'PRODUCAO',
    'data_prevista_pronto', (select data_prevista_pronto from pedidos_lab where id = pedido_id)
  );
end                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |
| trigger_auto_enviar_montagem    | 
BEGIN
  -- Se montador_id foi preenchido pela primeira vez (de NULL para valor)
  IF NEW.montador_id IS NOT NULL 
     AND (OLD.montador_id IS NULL OR OLD.montador_id IS DISTINCT FROM NEW.montador_id) 
     AND NEW.data_envio_montagem IS NULL THEN
    
    -- Preencher data de envio automaticamente
    NEW.data_envio_montagem := CURRENT_DATE;
    
    -- Calcular data prevista (+3 dias corridos, simplificado)
    NEW.data_prevista_montagem := CURRENT_DATE + INTERVAL '3 days';
    
    -- Atualizar status se ainda não estiver em montagem
    IF NEW.status NOT IN ('MONTAGEM', 'ENVIADO', 'CHEGOU', 'ENTREGUE') THEN
      NEW.status := 'ENVIADO';
    END IF;
  END IF;
  
  RETURN NEW;
END;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
| executar_renovacao_diaria       | 
DECLARE
  v_data_hoje DATE;
  v_data_ontem DATE;
  v_lojas_processadas INTEGER := 0;
  v_missoes_limpas INTEGER := 0;
  v_pontuacoes_calculadas INTEGER := 0;
  v_loja_id UUID;
  v_renovacao_id UUID;
BEGIN
  -- Obter datas no fuso brasileiro
  v_data_hoje := brasil_today();
  v_data_ontem := v_data_hoje - INTERVAL '1 day';
  
  -- Verificar se já foi processado hoje
  IF EXISTS (SELECT 1 FROM renovacao_diaria WHERE data_renovacao = v_data_hoje) THEN
    RETURN QUERY SELECT 
      'JA_PROCESSADO'::TEXT,
      0::INTEGER,
      0::INTEGER, 
      0::INTEGER,
      'Renovação já executada hoje'::TEXT;
    RETURN;
  END IF;
  
  -- Iniciar processo de renovação
  INSERT INTO renovacao_diaria (
    data_renovacao, 
    hora_renovacao, 
    status
  ) VALUES (
    v_data_hoje, 
    brasil_now(), 
    'PROCESSANDO'
  ) RETURNING id INTO v_renovacao_id;
  
  BEGIN
    -- PASSO 1: Calcular pontuação de ontem para todas as lojas
    FOR v_loja_id IN 
      SELECT DISTINCT loja_id FROM v_missoes_timeline 
      WHERE data_missao = v_data_ontem
    LOOP
      -- Calcular e salvar pontuação de ontem
      PERFORM calcular_pontuacao_diaria(v_loja_id, v_data_ontem);
      v_pontuacoes_calculadas := v_pontuacoes_calculadas + 1;
    END LOOP;
    
    -- PASSO 2: Atualizar estatísticas de gamificação
    UPDATE lojas_gamificacao 
    SET 
      -- Calcular streak baseado na pontuação de ontem
      streak_dias = CASE 
        WHEN EXISTS (
          SELECT 1 FROM pontuacao_diaria 
          WHERE loja_id = lojas_gamificacao.loja_id 
            AND data = v_data_ontem 
            AND missoes_completadas > 0
        ) THEN streak_dias + 1
        ELSE 0
      END,
      -- Atualizar maior streak se necessário
      maior_streak = GREATEST(
        maior_streak,
        CASE 
          WHEN EXISTS (
            SELECT 1 FROM pontuacao_diaria 
            WHERE loja_id = lojas_gamificacao.loja_id 
              AND data = v_data_ontem 
              AND missoes_completadas > 0
          ) THEN streak_dias + 1
          ELSE streak_dias
        END
      ),
      -- Atualizar liga baseada na performance do mês
      liga_atual = (
        SELECT CASE 
          WHEN AVG(percentual_eficiencia) >= 100 THEN 'DIAMANTE'
          WHEN AVG(percentual_eficiencia) >= 80 THEN 'OURO'
          WHEN AVG(percentual_eficiencia) >= 60 THEN 'PRATA'
          ELSE 'BRONZE'
        END
        FROM pontuacao_diaria 
        WHERE loja_id = lojas_gamificacao.loja_id
          AND data >= DATE_TRUNC('month', v_data_hoje)::DATE
          AND data < v_data_hoje
      ),
      ultima_atividade = brasil_now(),
      updated_at = brasil_now();
    
    GET DIAGNOSTICS v_lojas_processadas = ROW_COUNT;
    
    -- PASSO 3: Limpeza de missões antigas (opcional - manter histórico)
    -- Por enquanto, vamos apenas marcar como "processadas" sem deletar
    -- para manter o histórico completo
    
    -- PASSO 4: Preparar missões do dia atual
    -- (As missões são criadas dinamicamente pelo sistema principal)
    
    -- Finalizar com sucesso
    UPDATE renovacao_diaria 
    SET 
      status = 'CONCLUIDO',
      total_lojas_processadas = v_lojas_processadas,
      total_missoes_limpas = v_missoes_limpas,
      total_pontuacoes_calculadas = v_pontuacoes_calculadas
    WHERE id = v_renovacao_id;
    
    RETURN QUERY SELECT 
      'SUCESSO'::TEXT,
      v_lojas_processadas,
      v_missoes_limpas,
      v_pontuacoes_calculadas,
      FORMAT('Renovação concluída: %s lojas, %s pontuações calculadas', 
             v_lojas_processadas, v_pontuacoes_calculadas)::TEXT;
    
  EXCEPTION WHEN OTHERS THEN
    -- Em caso de erro, registrar e reverter
    UPDATE renovacao_diaria 
    SET 
      status = 'ERRO',
      detalhes_erro = SQLERRM
    WHERE id = v_renovacao_id;
    
    RETURN QUERY SELECT 
      'ERRO'::TEXT,
      0::INTEGER,
      0::INTEGER,
      0::INTEGER,
      SQLERRM::TEXT;
  END;
  
END;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   |
| deve_executar_renovacao         | 
DECLARE
  v_hora_atual TIME;
  v_data_hoje DATE;
BEGIN
  v_hora_atual := (brasil_now())::TIME;
  v_data_hoje := brasil_today();
  
  -- Verificar se é após 20:00 e ainda não foi processado hoje
  RETURN (
    v_hora_atual >= '20:00:00'::TIME 
    AND NOT EXISTS (
      SELECT 1 FROM renovacao_diaria 
      WHERE data_renovacao = v_data_hoje 
        AND status = 'CONCLUIDO'
    )
  );
END;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
| cron_renovacao_diaria           | 
DECLARE
  v_resultado RECORD;
BEGIN
  -- Verificar se deve executar
  IF NOT deve_executar_renovacao() THEN
    RETURN 'Renovação não necessária no momento';
  END IF;
  
  -- Executar renovação
  SELECT * INTO v_resultado FROM executar_renovacao_diaria() LIMIT 1;
  
  RETURN FORMAT('Status: %s | Lojas: %s | Pontuações: %s | %s', 
                v_resultado.status, 
                v_resultado.lojas_processadas,
                v_resultado.pontuacoes_calculadas,
                v_resultado.detalhes);
END;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |
| status_ultima_renovacao         | 
BEGIN
  RETURN QUERY
  SELECT 
    r.data_renovacao,
    r.hora_renovacao,
    r.status,
    r.total_lojas_processadas,
    r.total_pontuacoes_calculadas,
    CASE 
      WHEN r.status = 'CONCLUIDO' THEN 
        (SELECT created_at FROM renovacao_diaria WHERE id = r.id) - r.hora_renovacao
      ELSE NULL
    END as tempo_execucao
  FROM renovacao_diaria r
  ORDER BY r.data_renovacao DESC
  LIMIT 1;
END;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |
| proxima_renovacao               | 
DECLARE
  v_hoje DATE;
  v_proxima_renovacao TIMESTAMP WITH TIME ZONE;
BEGIN
  v_hoje := brasil_today();
  
  -- Se já passou das 20h hoje e não foi processado, é agora
  IF (brasil_now())::TIME >= '20:00:00'::TIME 
     AND NOT EXISTS (SELECT 1 FROM renovacao_diaria WHERE data_renovacao = v_hoje AND status = 'CONCLUIDO') THEN
    v_proxima_renovacao := v_hoje + TIME '20:00:00';
  ELSE
    -- Senão, é amanhã às 20h
    v_proxima_renovacao := (v_hoje + INTERVAL '1 day') + TIME '20:00:00';
  END IF;
  
  RETURN QUERY SELECT
    v_proxima_renovacao::DATE,
    v_proxima_renovacao,
    deve_executar_renovacao(),
    CASE 
      WHEN deve_executar_renovacao() THEN INTERVAL '0'
      ELSE v_proxima_renovacao - brasil_now()
    END;
END;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           |
| auto_entregar_pedido            | 
BEGIN
    -- Quando pedido chega na loja, após X dias automaticamente marca como entregue
    -- Isso tira do Kanban automaticamente
    IF NEW.status = 'CHEGOU' AND OLD.status != 'CHEGOU' THEN
        -- Agendar entrega automática em 7 dias (pode ser configurável)
        INSERT INTO sistema_config (chave, valor, descricao) VALUES
        ('auto_entrega_dias', '7', 'Dias para marcar automaticamente como entregue após chegada')
        ON CONFLICT (chave) DO NOTHING;
    END IF;
    
    RETURN NEW;
END;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
| concluir_missao_simples         | 
DECLARE
  resultado JSONB;
  missao_data RECORD;
  pontos_ganhos INT := 0;
BEGIN
  -- Buscar dados da missão COM o nome do template
  SELECT md.*, mt.pontos_base, mt.nome as missao_nome
  INTO missao_data
  FROM missoes_diarias md
  JOIN missao_templates mt ON md.template_id = mt.id
  WHERE md.id = p_missao_id;
  
  IF NOT FOUND THEN
    RETURN jsonb_build_object('sucesso', false, 'erro', 'Missão não encontrada');
  END IF;
  
  -- Calcular pontos simples
  pontos_ganhos := missao_data.pontos_base;
  IF p_qualidade = 5 THEN
    pontos_ganhos := pontos_ganhos * 1.5; -- Bonus qualidade perfeita
  END IF;
  
  -- Atualizar a missão
  UPDATE missoes_diarias 
  SET 
    status = 'concluida',
    concluida_em = NOW(),
    executada_por = p_executada_por,
    qualidade_execucao = p_qualidade,
    observacoes_execucao = p_observacoes,
    pontos_base = pontos_ganhos,
    updated_at = NOW()
  WHERE id = p_missao_id;
  
  -- Atualizar gamificação
  INSERT INTO usuario_gamificacao (usuario_id, loja_id, pontos_totais_historico, total_missoes_executadas, data_ultima_atividade)
  VALUES (p_executada_por::uuid, missao_data.loja_id, pontos_ganhos, 1, CURRENT_DATE)
  ON CONFLICT (usuario_id, loja_id) 
  DO UPDATE SET
    pontos_totais_historico = usuario_gamificacao.pontos_totais_historico + pontos_ganhos,
    total_missoes_executadas = usuario_gamificacao.total_missoes_executadas + 1,
    data_ultima_atividade = CURRENT_DATE,
    updated_at = NOW();
  
  -- Registrar evento
  INSERT INTO mission_eventos (missao_id, usuario_id, loja_id, tipo_evento, titulo, descricao)
  VALUES (
    p_missao_id, 
    p_executada_por::uuid, 
    missao_data.loja_id,
    'missao_concluida',
    'Missão Concluída',
    'Missão concluída com ' || p_qualidade || ' estrelas'
  );
  
  RETURN jsonb_build_object(
    'sucesso', true,
    'pontos_ganhos', pontos_ganhos,
    'missao', missao_data.missao_nome  -- Usando o campo correto
  );
END;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           |
| gerar_missoes_com_configuracoes | 
DECLARE
  r RECORD;
  v_missoes_criadas INTEGER := 0;
  v_lojas_processadas INTEGER := 0;
  v_dia_semana TEXT;
  v_horario_limite TIMESTAMP WITH TIME ZONE;
BEGIN
  -- Determinar dia da semana
  v_dia_semana := CASE EXTRACT(dow FROM p_data)
    WHEN 1 THEN 'seg'
    WHEN 2 THEN 'ter' 
    WHEN 3 THEN 'qua'
    WHEN 4 THEN 'qui'
    WHEN 5 THEN 'sex'
    WHEN 6 THEN 'sab'
    WHEN 0 THEN 'dom'
  END;
  
  -- Processar cada loja
  FOR r IN 
    SELECT DISTINCT l.id as loja_id, lch.* 
    FROM lojas l
    JOIN loja_configuracoes_horario lch ON l.id = lch.loja_id
    WHERE l.ativo = true
  LOOP
    -- Verificar se a loja trabalha neste dia
    IF (
      (v_dia_semana = 'seg' AND r.segunda_ativa) OR
      (v_dia_semana = 'ter' AND r.terca_ativa) OR
      (v_dia_semana = 'qua' AND r.quarta_ativa) OR
      (v_dia_semana = 'qui' AND r.quinta_ativa) OR
      (v_dia_semana = 'sex' AND r.sexta_ativa) OR
      (v_dia_semana = 'sab' AND r.sabado_ativa) OR
      (v_dia_semana = 'dom' AND r.domingo_ativa)
    ) THEN
      
      -- Criar missões baseadas nas ações customizadas da loja
      INSERT INTO missoes_diarias (
        loja_id,
        template_id,
        data_missao,
        data_vencimento,
        pontos_total,
        status,
        eh_obrigatoria,
        criada_automaticamente
      )
      SELECT 
        r.loja_id,
        ac.template_id,
        p_data,
        -- Calcular vencimento baseado na configuração
        (p_data + COALESCE(ac.horario_especifico, r.hora_limite_missoes, '17:00'::TIME))::TIMESTAMP WITH TIME ZONE,
        COALESCE(ac.pontos_customizados, mt.pontos_base),
        'pendente',
        ac.obrigatoria,
        true
      FROM loja_acoes_customizadas ac
      JOIN missao_templates mt ON ac.template_id = mt.id
      WHERE ac.loja_id = r.loja_id
        AND ac.ativa = true
        AND v_dia_semana = ANY(ac.dias_semana)
        AND mt.ativo = true
      ON CONFLICT (loja_id, template_id, data_missao) DO NOTHING;
      
      GET DIAGNOSTICS v_missoes_criadas = ROW_COUNT;
      v_lojas_processadas := v_lojas_processadas + 1;
    END IF;
  END LOOP;
  
  RETURN QUERY SELECT v_missoes_criadas, v_lojas_processadas, 
    FORMAT('Criadas %s missões para %s lojas na data %s', 
           v_missoes_criadas, v_lojas_processadas, p_data);
END;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
| log_status_change               | 
begin
  if old.status != new.status then
    insert into pedido_eventos (pedido_id, tipo, descricao, detalhes, usuario_id)
    values (
      new.id,
      'STATUS_CHANGE',
      format('Status alterado de %s para %s', old.status, new.status),
      jsonb_build_object(
        'status_anterior', old.status,
        'status_novo', new.status,
        'timestamp', now()
      ),
      new.updated_by
    );
    
    -- Guardar status anterior
    new.status_anterior := old.status;
  end if;
  return new;
end                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |
| pausar_missao                   | 
BEGIN
  UPDATE missoes_diarias 
  SET 
    status = 'pausada',
    pausada_em = NOW(),
    updated_at = NOW()
  WHERE id = p_missao_id AND status = 'ativa';
  
  -- Registrar evento
  INSERT INTO mission_eventos (missao_id, tipo_evento, titulo, descricao, automatico)
  VALUES (p_missao_id, 'missao_pausada', 'Missão Pausada', p_motivo, false);
  
  RETURN FOUND;
END;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
| atualizar_flags_atraso          | 
DECLARE
  missao_record RECORD;
BEGIN
  SELECT * INTO missao_record
  FROM missoes_diarias 
  WHERE id = p_missao_id;
  
  IF NOT FOUND THEN
    RETURN false;
  END IF;
  
  -- Apenas verificar, NÃO atualizar (para evitar loops)
  IF missao_record.data_vencimento IS NOT NULL AND 
     missao_record.data_vencimento < NOW() AND
     missao_record.status NOT IN ('concluida', 'cancelada') THEN
    RETURN true; -- Precisa atenção, mas não atualizar aqui
  END IF;
  
  RETURN false;
END;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |
| get_metricas_periodo            | 
BEGIN
  RETURN QUERY
  SELECT
    data_inicio::text || ' a ' || data_fim::text as periodo,
    count(*) as total_pedidos,
    count(*) filter (where status = 'CHEGOU') as finalizados,
    round(
      (count(*) filter (where status = 'CHEGOU')::numeric / 
       nullif(count(*), 0)) * 100, 
      1
    ) as taxa_conclusao,
    -- Lead time médio CORRIGIDO
    round(
      avg(case 
        when status = 'CHEGOU' 
          and data_pagamento is not null 
          and updated_at is not null
        then (updated_at::date - data_pagamento)::integer
        end), 
      1
    ) as lead_time_medio,
    coalesce(sum(valor_pedido), 0) as valor_total,
    count(*) filter (
      where status = 'CHEGOU' 
        and coalesce(pagamento_atrasado, false) = false
        and coalesce(producao_atrasada, false) = false
        and coalesce(envio_atrasado, false) = false
    ) as pedidos_no_prazo,
    count(*) filter (
      where coalesce(pagamento_atrasado, false) = true
        or coalesce(producao_atrasada, false) = true  
        or coalesce(envio_atrasado, false) = true
    ) as pedidos_atrasados
  FROM pedidos_lab
  WHERE created_at::date >= data_inicio 
    AND created_at::date <= data_fim;
END                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |
| get_timeline_sla_7_dias         | 
DECLARE
  dia_atual DATE := CURRENT_DATE;
  i INTEGER;
BEGIN
  FOR i IN 0..6 LOOP
    RETURN QUERY
    SELECT 
      CASE EXTRACT(DOW FROM (dia_atual + i))
        WHEN 0 THEN 'DOM'
        WHEN 1 THEN 'SEG'
        WHEN 2 THEN 'TER'
        WHEN 3 THEN 'QUA'
        WHEN 4 THEN 'QUI'
        WHEN 5 THEN 'SEX'
        WHEN 6 THEN 'SAB'
      END as dia,
      (dia_atual + i) as data,
      COUNT(*) FILTER (WHERE p.data_sla_laboratorio = (dia_atual + i))::INTEGER as sla_vencendo,
      COUNT(*) FILTER (WHERE p.data_prometida = (dia_atual + i))::INTEGER as promessas_vencendo,
      CASE 
        WHEN COUNT(*) FILTER (WHERE p.data_sla_laboratorio = (dia_atual + i)) > 10 THEN 'pico'
        WHEN COUNT(*) FILTER (WHERE p.data_sla_laboratorio = (dia_atual + i)) > 5 THEN 'atencao'
        WHEN EXTRACT(DOW FROM (dia_atual + i)) IN (0, 6) THEN 'folga'
        ELSE 'ok'
      END as status
    FROM v_pedidos_kanban p
    WHERE p.status NOT IN ('ENTREGUE', 'CANCELADO')
      AND (p_loja_id IS NULL OR p.loja_id = p_loja_id)
      AND (p.data_sla_laboratorio = (dia_atual + i) OR p.data_prometida = (dia_atual + i));
  END LOOP;
END;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
| inserir_novo_pedido             | 
DECLARE
    resultado json;
    novo_pedido record;
BEGIN
    INSERT INTO pedidos (
        loja_id, laboratorio_id, classe_lente_id,
        status, prioridade, cliente_nome,
        numero_pedido_laboratorio, valor_pedido, observacoes,
        created_by, created_at, updated_at
    ) VALUES (
        p_loja_id, p_laboratorio_id, p_classe_lente_id,
        'REGISTRADO', p_prioridade, p_cliente_nome,
        p_numero_pedido_laboratorio, p_valor_pedido, p_observacoes,
        'api_function', NOW(), NOW()
    ) RETURNING * INTO novo_pedido;
    
    SELECT row_to_json(novo_pedido) INTO resultado;
    RETURN resultado;
EXCEPTION
    WHEN OTHERS THEN
        RAISE NOTICE 'Erro ao inserir pedido: %', SQLERRM;
        RAISE;
END;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
| registrar_evento                | 
DECLARE
  evento_id UUID;
BEGIN
  INSERT INTO pedido_eventos (
    pedido_id, tipo, titulo, descricao, 
    status_anterior, status_novo, usuario, automatico
  ) VALUES (
    pedido_uuid, tipo_evento, titulo_evento, descricao_evento,
    status_ant, status_nov, usuario_evento, true
  ) RETURNING id INTO evento_id;
  
  RETURN evento_id;
END;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
| delegar_missao                  | 
BEGIN
  UPDATE missoes_diarias 
  SET 
    status = 'delegada',
    delegada_para = p_delegar_para,
    motivo_delegacao = p_motivo,
    delegada_em = NOW(),
    updated_at = NOW()
  WHERE id = p_missao_id;
  
  -- Registrar evento
  INSERT INTO mission_eventos (missao_id, usuario_id, tipo_evento, titulo, descricao, dados_evento)
  VALUES (
    p_missao_id, 
    p_delegado_por::uuid, 
    'missao_delegada', 
    'Missão Delegada',
    'Delegada para outro usuário: ' || p_motivo,
    jsonb_build_object('delegada_para', p_delegar_para, 'motivo', p_motivo)
  );
  
  RETURN FOUND;
END;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   |
| verificar_alertas_automaticos   | 
DECLARE
  alertas_criados INT := 0;
  missao_record RECORD;
BEGIN
  -- Alertas para missões críticas paradas há mais de 1 hora
  FOR missao_record IN 
    SELECT 
      m.id,
      m.loja_id,
      m.data_vencimento,
      mt.nome as missao_nome,
      mt.tipo
    FROM missoes_diarias m
    JOIN missao_templates mt ON m.template_id = mt.id
    WHERE m.status = 'pendente' 
    AND mt.tipo = 'critica'
    AND m.data_vencimento < NOW() + INTERVAL '1 hour'
    AND NOT EXISTS (
      SELECT 1 FROM alertas 
      WHERE pedido_id = m.id 
      AND tipo = 'urgent_attention' 
      AND lido = false
    )
  LOOP
    INSERT INTO alertas (pedido_id, tipo, titulo, mensagem, destinatario, loja_id)
    VALUES (
      missao_record.id,
      'urgent_attention',
      '🚨 Missão Crítica Urgente',
      'A missão "' || missao_record.missao_nome || '" precisa de atenção imediata!',
      'loja',
      missao_record.loja_id
    );
    
    alertas_criados := alertas_criados + 1;
  END LOOP;
  
  -- Alertas para missões vencidas
  FOR missao_record IN 
    SELECT 
      m.id,
      m.loja_id,
      m.data_vencimento,
      mt.nome as missao_nome
    FROM missoes_diarias m
    JOIN missao_templates mt ON m.template_id = mt.id
    WHERE m.status IN ('pendente', 'ativa')
    AND m.data_vencimento < NOW()
    AND NOT EXISTS (
      SELECT 1 FROM alertas 
      WHERE pedido_id = m.id 
      AND tipo = 'mission_overdue' 
      AND lido = false
    )
  LOOP
    INSERT INTO alertas (pedido_id, tipo, titulo, mensagem, destinatario, loja_id)
    VALUES (
      missao_record.id,
      'mission_overdue',
      '⏰ Missão Vencida',
      'A missão "' || missao_record.missao_nome || '" está atrasada!',
      'loja',
      missao_record.loja_id
    );
    
    alertas_criados := alertas_criados + 1;
  END LOOP;
  
  RETURN alertas_criados;
END;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |
| trigger_pedido_avancado         | 
DECLARE
  evento_titulo TEXT;
  requer_recalculo BOOLEAN := false;
BEGIN
  -- Registrar mudança de status
  IF TG_OP = 'UPDATE' AND OLD.status != NEW.status THEN
    evento_titulo := 'Status: ' || OLD.status || ' → ' || NEW.status;
    
    PERFORM registrar_evento(
      NEW.id, 'STATUS_CHANGE', evento_titulo,
      NULL, OLD.status, NEW.status, NEW.created_by
    );
    
    -- Definir datas baseadas no status
    CASE NEW.status
      WHEN 'PAGO' THEN
        NEW.data_pagamento := COALESCE(NEW.data_pagamento, CURRENT_DATE);
        requer_recalculo := true;
      WHEN 'ENTREGUE' THEN
        NEW.data_entregue := COALESCE(NEW.data_entregue, CURRENT_DATE);
      ELSE
        -- Nenhuma ação especial
    END CASE;
  END IF;
  
  -- Registrar mudança de prioridade
  IF TG_OP = 'UPDATE' AND OLD.prioridade != NEW.prioridade THEN
    PERFORM registrar_evento(
      NEW.id, 'NOTE', 'Prioridade: ' || OLD.prioridade || ' → ' || NEW.prioridade,
      'Mudança de prioridade', NULL, NULL, NEW.created_by
    );
    requer_recalculo := true;
  END IF;
  
  -- Atualizar timestamp
  NEW.updated_at := NOW();
  
  -- Recalcular SLA se necessário
  IF requer_recalculo OR (TG_OP = 'INSERT') THEN
    PERFORM calcular_sla_pedido(NEW.id);
  END IF;
  
  -- Atualizar flags
  PERFORM atualizar_flags_atraso(NEW.id);
  
  RETURN NEW;
END;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                |
| calcular_lead_time              | 
BEGIN
  -- Quando status muda para PRODUCAO, registrar início
  IF NEW.status = 'PRODUCAO' AND OLD.status != 'PRODUCAO' THEN
    NEW.data_inicio_producao = NOW();
  END IF;
  
  -- Quando status muda para PRONTO, calcular lead time de produção
  IF NEW.status = 'PRONTO' AND OLD.status = 'PRODUCAO' THEN
    NEW.data_conclusao_producao = NOW();
    IF NEW.data_inicio_producao IS NOT NULL THEN
      NEW.lead_time_producao_horas = EXTRACT(EPOCH FROM (NOW() - NEW.data_inicio_producao)) / 3600;
    END IF;
  END IF;
  
  -- Quando status muda para ENTREGUE, calcular lead time total
  IF NEW.status = 'ENTREGUE' AND OLD.status != 'ENTREGUE' THEN
    NEW.lead_time_total_horas = EXTRACT(EPOCH FROM (NOW() - NEW.created_at)) / 3600;
  END IF;
  
  RETURN NEW;
END;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
| trigger_verificar_alertas       | 
BEGIN
  -- Atualizar flags se necessário (apenas se a missão existe)
  IF NEW.id IS NOT NULL THEN
    PERFORM atualizar_flags_atraso(NEW.id);
  END IF;
  
  -- Se mudou para status ativo de pendente, verificar alertas
  IF NEW.status = 'ativa' AND (OLD.status IS NULL OR OLD.status = 'pendente') THEN
    PERFORM verificar_alertas_automaticos();
  END IF;
  
  -- Se a missão ficou vencida, marcar flag de atenção
  IF NEW.data_vencimento IS NOT NULL AND NEW.data_vencimento < NOW() THEN
    NEW.requer_atencao = true;
  END IF;
  
  RETURN NEW;
END;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |
| mover_para_historico            | 
BEGIN
    -- Validar se status é de histórico
    IF novo_status NOT IN ('ENTREGUE', 'CANCELADO') THEN
        RAISE EXCEPTION 'Status % não é de histórico', novo_status;
        RETURN FALSE;
    END IF;
    
    -- Atualizar pedido
    UPDATE pedidos 
    SET 
        status = novo_status,
        data_entregue = CASE WHEN novo_status = 'ENTREGUE' THEN CURRENT_DATE ELSE data_entregue END,
        updated_at = NOW()
    WHERE id = pedido_uuid;
    
    -- Registrar evento
    INSERT INTO pedido_eventos (pedido_id, tipo, status_novo, detalhes)
    VALUES (pedido_uuid, 'STATUS_CHANGE', novo_status, 
            jsonb_build_object('origem', 'sistema', 'destino', 'historico'));
    
    RETURN TRUE;
END;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          |
| get_alertas_sla_criticos        | 
BEGIN
  RETURN QUERY
  SELECT 
    p.id as pedido_id,
    p.cliente_nome,
    CASE 
      WHEN COALESCE(data_sla_laboratorio, data_prevista_pronto) < CURRENT_DATE THEN 'SLA_VENCIDO'
      WHEN COALESCE(data_sla_laboratorio, data_prevista_pronto) <= CURRENT_DATE + INTERVAL '2 days' THEN 'SLA_CRITICO'
      WHEN COALESCE(data_prometida, data_prevista_pronto + INTERVAL '2 days') <= CURRENT_DATE + INTERVAL '3 days' THEN 'PROMESSA_RISCO'
      ELSE 'MONITORAMENTO'
    END as tipo_alerta,
    CASE 
      WHEN COALESCE(data_sla_laboratorio, data_prevista_pronto) < CURRENT_DATE THEN 'CRITICA'
      WHEN COALESCE(data_sla_laboratorio, data_prevista_pronto) <= CURRENT_DATE + INTERVAL '2 days' THEN 'ALTA'
      WHEN COALESCE(data_prometida, data_prevista_pronto + INTERVAL '2 days') <= CURRENT_DATE + INTERVAL '3 days' THEN 'MEDIA'
      ELSE 'BAIXA'
    END as severidade,
    EXTRACT(DAY FROM COALESCE(data_sla_laboratorio, data_prevista_pronto) - CURRENT_DATE)::INTEGER as dias_restantes,
    p.status as status_atual,
    CASE 
      WHEN COALESCE(data_sla_laboratorio, data_prevista_pronto) < CURRENT_DATE THEN 'ACELERAR PRODUÇÃO - PRIORIDADE MÁXIMA'
      WHEN COALESCE(data_sla_laboratorio, data_prevista_pronto) <= CURRENT_DATE + INTERVAL '2 days' THEN 'Notificar laboratório - acelerar processo'
      WHEN COALESCE(data_prometida, data_prevista_pronto + INTERVAL '2 days') <= CURRENT_DATE + INTERVAL '3 days' THEN 'Monitorar progresso - comunicar cliente se necessário'
      ELSE 'Continuar monitoramento'
    END as acao_recomendada
  FROM pedidos p
  WHERE p.status IN ('PROCESSANDO', 'EM_PRODUCAO', 'AGUARDANDO_QUALIDADE')
    AND (
      COALESCE(data_sla_laboratorio, data_prevista_pronto) <= CURRENT_DATE + INTERVAL '5 days' OR
      COALESCE(data_prometida, data_prevista_pronto + INTERVAL '2 days') <= CURRENT_DATE + INTERVAL '5 days'
    )
  ORDER BY 
    CASE 
      WHEN COALESCE(data_sla_laboratorio, data_prevista_pronto) < CURRENT_DATE THEN 1
      WHEN COALESCE(data_sla_laboratorio, data_prevista_pronto) <= CURRENT_DATE + INTERVAL '2 days' THEN 2
      ELSE 3
    END,
    COALESCE(data_sla_laboratorio, data_prevista_pronto) ASC
  LIMIT 20;
END;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |
| trigger_criar_evento_timeline   | 
BEGIN
  -- Se status mudou, criar evento
  IF (TG_OP = 'INSERT') OR 
     (TG_OP = 'UPDATE' AND (OLD.status IS NULL OR OLD.status != NEW.status)) THEN
    
    INSERT INTO pedido_eventos (
      pedido_id,
      tipo,
      titulo,
      descricao,
      status_anterior,
      status_novo,
      detalhes,
      usuario,
      automatico,
      created_at
    ) VALUES (
      NEW.id,
      'STATUS_CHANGE',
      CASE 
        WHEN TG_OP = 'INSERT' THEN 'Pedido Criado'
        ELSE 'Status Alterado: ' || COALESCE(OLD.status, 'NULL') || ' → ' || NEW.status
      END,
      CASE 
        WHEN TG_OP = 'INSERT' THEN 'Novo pedido registrado no sistema'
        ELSE 'Status alterado de ' || COALESCE(OLD.status, 'NULL') || ' para ' || NEW.status || ' automaticamente'
      END,
      CASE WHEN TG_OP = 'INSERT' THEN NULL ELSE OLD.status END,
      NEW.status,
      jsonb_build_object(
        'trigger', 'automatico',
        'operacao', TG_OP,
        'numero_sequencial', NEW.numero_sequencial
      ),
      'sistema', -- Campo usuario - sempre 'sistema' para triggers automáticos
      true,
      NOW()
    );
    
  END IF;
  
  RETURN NEW;
END;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |
| cancelar_missao                 | 
BEGIN
  UPDATE missoes_diarias 
  SET 
    status = 'cancelada',
    observacoes_execucao = p_motivo,
    updated_at = NOW()
  WHERE id = p_missao_id;
  
  -- Registrar evento
  INSERT INTO mission_eventos (missao_id, usuario_id, tipo_evento, titulo, descricao)
  VALUES (p_missao_id, p_usuario::uuid, 'missao_cancelada', 'Missão Cancelada', p_motivo);
  
  RETURN FOUND;
END;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                |
| marcar_pagamento                | 
DECLARE
  pedido_atual RECORD;
BEGIN
  SELECT * INTO pedido_atual FROM pedidos WHERE id = pedido_uuid;
  
  IF NOT FOUND THEN
    RAISE EXCEPTION 'Pedido não encontrado';
  END IF;
  
  IF pedido_atual.status NOT IN ('REGISTRADO', 'AG_PAGAMENTO') THEN
    RAISE EXCEPTION 'Pedido não pode receber pagamento neste status';
  END IF;
  
  UPDATE pedidos SET
    status = 'PAGO',
    data_pagamento = data_pag,
    forma_pagamento = forma_pag,
    updated_at = NOW()
  WHERE id = pedido_uuid;
  
  PERFORM registrar_evento(
    pedido_uuid, 'PAYMENT', 'Pagamento confirmado',
    'Forma: ' || forma_pag, pedido_atual.status, 'PAGO', usuario
  );
  
  RETURN true;
END;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
| trigger_registrar_historico     | 
BEGIN
  -- Se mudou o status, registrar no histórico
  IF OLD.status IS DISTINCT FROM NEW.status THEN
    INSERT INTO pedidos_historico (
      pedido_id, 
      status_anterior, 
      status_novo,
      observacao
    ) VALUES (
      NEW.id,
      OLD.status,
      NEW.status,
      'Status alterado automaticamente'
    );
  END IF;
  
  RETURN NEW;
END;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
| criar_pedidos_realistas         | 
DECLARE
  loja_ids UUID[];
  lab_ids UUID[];
  classe_ids UUID[];
  colaborador_ids UUID[];
  data_inicio DATE := '2023-01-01';
  data_fim DATE := CURRENT_DATE;
  total_pedidos INT := 0;
  pedido_id UUID;
  data_atual DATE;
  status_atual TEXT;
  prioridade_atual TEXT;
  valor_atual NUMERIC;
  lab_id UUID;
  classe_id UUID;
  loja_id UUID;
  colaborador_id UUID;
BEGIN
  -- Buscar IDs disponíveis
  SELECT ARRAY_AGG(id) INTO loja_ids FROM lojas WHERE ativo = true;
  SELECT ARRAY_AGG(id) INTO lab_ids FROM laboratorios WHERE ativo = true;
  SELECT ARRAY_AGG(id) INTO classe_ids FROM classes_lente WHERE ativa = true;
  SELECT ARRAY_AGG(id) INTO colaborador_ids FROM colaboradores WHERE ativo = true;
  
  -- Gerar pedidos distribuídos ao longo do tempo
  FOR i IN 1..2500 LOOP
    -- Data aleatória no período
    data_atual := data_inicio + (random() * (data_fim - data_inicio))::INT;
    
    -- Seleções aleatórias
    loja_id := loja_ids[1 + (random() * (array_length(loja_ids, 1) - 1))::INT];
    lab_id := lab_ids[1 + (random() * (array_length(lab_ids, 1) - 1))::INT];
    classe_id := classe_ids[1 + (random() * (array_length(classe_ids, 1) - 1))::INT];
    colaborador_id := colaborador_ids[1 + (random() * (array_length(colaborador_ids, 1) - 1))::INT];
    
    -- Distribuição realista de prioridades
    CASE 
      WHEN random() < 0.70 THEN prioridade_atual := 'NORMAL';
      WHEN random() < 0.90 THEN prioridade_atual := 'ALTA';
      WHEN random() < 0.98 THEN prioridade_atual := 'URGENTE';
      ELSE prioridade_atual := 'BAIXA';
    END CASE;
    
    -- Valor baseado na classe
    valor_atual := CASE 
      WHEN random() < 0.4 THEN 800 + random() * 400    -- Monofocais: 800-1200
      WHEN random() < 0.7 THEN 1200 + random() * 800   -- Multifocais: 1200-2000
      WHEN random() < 0.9 THEN 1500 + random() * 1000  -- Premium: 1500-2500
      ELSE 500 + random() * 300                         -- Básicas: 500-800
    END CASE;
    
    -- Status baseado na idade do pedido
    IF data_atual < CURRENT_DATE - INTERVAL '60 days' THEN
      -- Pedidos antigos: maioria entregue
      CASE 
        WHEN random() < 0.85 THEN status_atual := 'ENTREGUE';
        WHEN random() < 0.92 THEN status_atual := 'CHEGOU';
        WHEN random() < 0.96 THEN status_atual := 'ENVIADO';
        ELSE status_atual := 'CANCELADO';
      END CASE;
    ELSIF data_atual < CURRENT_DATE - INTERVAL '30 days' THEN
      -- Pedidos médios: mix variado
      CASE 
        WHEN random() < 0.60 THEN status_atual := 'ENTREGUE';
        WHEN random() < 0.75 THEN status_atual := 'CHEGOU';
        WHEN random() < 0.85 THEN status_atual := 'ENVIADO';
        WHEN random() < 0.92 THEN status_atual := 'PRONTO';
        ELSE status_atual := 'PRODUCAO';
      END CASE;
    ELSIF data_atual < CURRENT_DATE - INTERVAL '7 days' THEN
      -- Pedidos recentes: em andamento
      CASE 
        WHEN random() < 0.25 THEN status_atual := 'ENTREGUE';
        WHEN random() < 0.40 THEN status_atual := 'CHEGOU';
        WHEN random() < 0.55 THEN status_atual := 'ENVIADO';
        WHEN random() < 0.70 THEN status_atual := 'PRONTO';
        WHEN random() < 0.85 THEN status_atual := 'PRODUCAO';
        ELSE status_atual := 'PAGO';
      END CASE;
    ELSE
      -- Pedidos muito recentes: início do workflow
      CASE 
        WHEN random() < 0.30 THEN status_atual := 'REGISTRADO';
        WHEN random() < 0.55 THEN status_atual := 'AG_PAGAMENTO';
        WHEN random() < 0.75 THEN status_atual := 'PAGO';
        ELSE status_atual := 'PRODUCAO';
      END CASE;
    END IF;
    
    -- Inserir pedido (triggers vão calcular datas automaticamente)
    INSERT INTO pedidos (
      loja_id,
      laboratorio_id,
      classe_lente_id,
      vendedor_id,
      status,
      prioridade,
      data_pedido,
      valor_pedido,
      cliente_nome,
      cliente_telefone,
      observacoes,
      created_at,
      updated_at,
      created_by
    ) VALUES (
      loja_id,
      lab_id,
      classe_id,
      colaborador_id,
      status_atual,
      prioridade_atual,
      data_atual,
      ROUND(valor_atual, 2),
      'Cliente ' || i,
      '11' || LPAD((random() * 100000000)::INT::TEXT, 9, '0'),
      CASE WHEN random() < 0.3 THEN 'Pedido gerado automaticamente' ELSE NULL END,
      data_atual + (random() * INTERVAL '2 hours'), -- Criado no mesmo dia
      data_atual + (random() * INTERVAL '2 hours'),
      'sistema_seed'
    ) RETURNING id INTO pedido_id;
    
    total_pedidos := total_pedidos + 1;
    
    -- Progresso a cada 500 pedidos
    IF total_pedidos % 500 = 0 THEN
      RAISE NOTICE 'Criados % pedidos...', total_pedidos;
    END IF;
  END LOOP;
  
  RETURN 'Criados ' || total_pedidos || ' pedidos realistas de ' || data_inicio || ' até ' || data_fim;
END;
 |
| criar_pedido_simples            | 
DECLARE
  v_pedido_id UUID;
  v_data_prevista DATE;
  v_data_sla_lab DATE;
  v_margem_seguranca INTEGER := 2;
  v_sla_base_dias INTEGER := 5;
BEGIN
  -- Gerar ID para o pedido
  v_pedido_id := gen_random_uuid();
  
  -- Buscar SLA base da classe de lente
  BEGIN
    SELECT sla_base_dias INTO v_sla_base_dias
    FROM classes_lente 
    WHERE id = p_classe_lente_id;
  EXCEPTION
    WHEN OTHERS THEN
      v_sla_base_dias := 5;
  END;
  
  -- Buscar margem de segurança da loja
  BEGIN
    SELECT COALESCE(margem_seguranca_dias, 2) INTO v_margem_seguranca
    FROM lojas 
    WHERE id = p_loja_id;
  EXCEPTION
    WHEN OTHERS THEN
      v_margem_seguranca := 2;
  END;
  
  -- Calcular datas
  v_data_sla_lab := CURRENT_DATE + (v_sla_base_dias || ' days')::INTERVAL;
  
  -- Se não foi informada data prometida, calcular baseada no SLA + margem
  IF p_data_prometida_cliente IS NULL THEN
    v_data_prevista := CURRENT_DATE + ((v_sla_base_dias + v_margem_seguranca) || ' days')::INTERVAL;
  ELSE
    v_data_prevista := p_data_prometida_cliente;
  END IF;
  
  -- Inserir o pedido
  INSERT INTO pedidos (
    id,
    loja_id,
    laboratorio_id,
    classe_lente_id,
    status,
    prioridade,
    cliente_nome,
    cliente_telefone,
    numero_os_fisica,
    numero_pedido_laboratorio,
    valor_pedido,
    custo_lentes,
    eh_garantia,
    observacoes,
    observacoes_garantia,
    data_prevista_pronto,
    data_sla_laboratorio,
    data_prometida,
    montador_id,
    created_by
  ) VALUES (
    v_pedido_id,
    p_loja_id,
    p_laboratorio_id,
    p_classe_lente_id,
    'REGISTRADO',
    p_prioridade,
    p_cliente_nome,
    p_cliente_telefone,
    p_numero_os_fisica,
    p_numero_pedido_laboratorio,
    p_valor_pedido,
    p_custo_lentes,
    p_eh_garantia,
    p_observacoes,
    p_observacoes_garantia,
    v_data_prevista,
    v_data_sla_lab,
    COALESCE(p_data_prometida_cliente, v_data_prevista),
    p_montador_id,
    'sistema_criar_pedido'
  );
  
  -- Inserir tratamentos se houver
  IF p_tratamentos_ids IS NOT NULL AND array_length(p_tratamentos_ids, 1) > 0 THEN
    INSERT INTO pedido_tratamentos (pedido_id, tratamento_id)
    SELECT v_pedido_id, unnest(p_tratamentos_ids);
  END IF;
  
  RETURN v_pedido_id;
END;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
| get_performance_laboratorios    | 
BEGIN
  RETURN QUERY
  SELECT 
    p.laboratorio_id,
    p.laboratorio_nome,
    COUNT(*)::INTEGER as total_pedidos,
    COUNT(*) FILTER (WHERE 
      (p.data_entregue IS NOT NULL AND p.data_entregue <= p.data_sla_laboratorio) OR
      (p.data_entregue IS NULL AND p.data_sla_laboratorio >= CURRENT_DATE)
    )::INTEGER as sla_cumprido,
    COUNT(*) FILTER (WHERE 
      p.data_entregue > p.data_sla_laboratorio OR
      (p.data_entregue IS NULL AND p.data_sla_laboratorio < CURRENT_DATE)
    )::INTEGER as sla_atrasado,
    (COUNT(*) FILTER (WHERE 
      (p.data_entregue IS NOT NULL AND p.data_entregue <= p.data_sla_laboratorio) OR
      (p.data_entregue IS NULL AND p.data_sla_laboratorio >= CURRENT_DATE)
    ) * 100.0 / NULLIF(COUNT(*), 0))::NUMERIC(5,2) as taxa_sla,
    -- Dias médio real (para entregues)
    COALESCE(AVG(
      CASE WHEN p.data_entregue IS NOT NULL 
      THEN (p.data_entregue - p.data_pedido)::INTEGER
      ELSE NULL END
    ), 0)::NUMERIC(3,1) as dias_medio_real,
    -- SLA prometido médio
    COALESCE(AVG(p.sla_padrao_dias), 0)::NUMERIC(3,1) as dias_sla_prometido,
    -- Economia potencial (se entregar antes do SLA)
    (COUNT(*) * 50 * 
     CASE WHEN AVG((COALESCE(p.data_entregue, CURRENT_DATE) - p.data_pedido)::INTEGER) < AVG(p.sla_padrao_dias) 
     THEN 1 ELSE -0.5 END
    )::NUMERIC as economia_potencial,
    -- Tendência baseada na performance
    CASE 
      WHEN (COUNT(*) FILTER (WHERE 
        (p.data_entregue IS NOT NULL AND p.data_entregue <= p.data_sla_laboratorio) OR
        (p.data_entregue IS NULL AND p.data_sla_laboratorio >= CURRENT_DATE)
      ) * 100.0 / NULLIF(COUNT(*), 0)) >= 92 THEN 'up'
      WHEN (COUNT(*) FILTER (WHERE 
        (p.data_entregue IS NOT NULL AND p.data_entregue <= p.data_sla_laboratorio) OR
        (p.data_entregue IS NULL AND p.data_sla_laboratorio >= CURRENT_DATE)
      ) * 100.0 / NULLIF(COUNT(*), 0)) <= 85 THEN 'down'
      ELSE 'stable'
    END as tendencia
  FROM v_pedidos_kanban p
  WHERE 1=1
    AND (p_loja_id IS NULL OR p.loja_id = p_loja_id)
    AND (p_data_inicio IS NULL OR p.data_pedido >= p_data_inicio)
    AND (p_data_fim IS NULL OR p.data_pedido <= p_data_fim)
    AND p.status != 'CANCELADO'
  GROUP BY p.laboratorio_id, p.laboratorio_nome
  HAVING COUNT(*) >= 3  -- Só labs com pelo menos 3 pedidos
  ORDER BY taxa_sla DESC;
END;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |
| get_sla_metricas                | 
BEGIN
  RETURN QUERY
  SELECT 
    COUNT(*)::INTEGER as total_pedidos,
    -- SLA Lab: entregues no prazo OU ainda dentro do prazo
    COUNT(*) FILTER (WHERE 
      (data_entregue IS NOT NULL AND data_entregue <= COALESCE(data_sla_laboratorio, data_prevista_pronto)) OR
      (data_entregue IS NULL AND COALESCE(data_sla_laboratorio, data_prevista_pronto) >= CURRENT_DATE)
    )::INTEGER as sla_lab_cumprido,
    -- Promessas: entregues no prazo OU ainda dentro da promessa  
    COUNT(*) FILTER (WHERE 
      (data_entregue IS NOT NULL AND data_entregue <= COALESCE(data_prometida, data_prevista_pronto + INTERVAL '2 days')) OR
      (data_entregue IS NULL AND COALESCE(data_prometida, data_prevista_pronto + INTERVAL '2 days') >= CURRENT_DATE)
    )::INTEGER as promessas_cumpridas,
    -- Taxa SLA Lab
    (COUNT(*) FILTER (WHERE 
      (data_entregue IS NOT NULL AND data_entregue <= COALESCE(data_sla_laboratorio, data_prevista_pronto)) OR
      (data_entregue IS NULL AND COALESCE(data_sla_laboratorio, data_prevista_pronto) >= CURRENT_DATE)
    ) * 100.0 / NULLIF(COUNT(*), 0))::NUMERIC(5,2) as taxa_sla_lab,
    -- Taxa Promessa Cliente
    (COUNT(*) FILTER (WHERE 
      (data_entregue IS NOT NULL AND data_entregue <= COALESCE(data_prometida, data_prevista_pronto + INTERVAL '2 days')) OR
      (data_entregue IS NULL AND COALESCE(data_prometida, data_prevista_pronto + INTERVAL '2 days') >= CURRENT_DATE)
    ) * 100.0 / NULLIF(COUNT(*), 0))::NUMERIC(5,2) as taxa_promessa_cliente,
    -- Economia estimada
    (COUNT(*) * 75)::NUMERIC as economia_margem,
    -- Custo de atrasos
    (COUNT(*) FILTER (WHERE 
      data_entregue > COALESCE(data_sla_laboratorio, data_prevista_pronto) OR
      (data_entregue IS NULL AND COALESCE(data_sla_laboratorio, data_prevista_pronto) < CURRENT_DATE)
    ) * 150)::NUMERIC as custo_atrasos
  FROM pedidos p
  WHERE 1=1
    AND (p_loja_id IS NULL OR p.loja_id = p_loja_id)
    AND (p_data_inicio IS NULL OR p.data_pedido >= p_data_inicio)
    AND (p_data_fim IS NULL OR p.data_pedido <= p_data_fim)
    AND p.status != 'CANCELADO';
END;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |
| get_performance_laboratorios    | 
BEGIN
  RETURN QUERY
  SELECT 
    COALESCE(l.nome, 'Laboratório Principal') as laboratorio,
    COUNT(*)::INTEGER as pedidos_total,
    COUNT(*) FILTER (WHERE 
      (p.data_entregue IS NOT NULL AND p.data_entregue <= COALESCE(p.data_sla_laboratorio, p.data_prevista_pronto)) OR
      (p.data_entregue IS NULL AND COALESCE(p.data_sla_laboratorio, p.data_prevista_pronto) >= CURRENT_DATE)
    )::INTEGER as pedidos_no_prazo,
    (COUNT(*) FILTER (WHERE 
      (p.data_entregue IS NOT NULL AND p.data_entregue <= COALESCE(p.data_sla_laboratorio, p.data_prevista_pronto)) OR
      (p.data_entregue IS NULL AND COALESCE(p.data_sla_laboratorio, p.data_prevista_pronto) >= CURRENT_DATE)
    ) * 100.0 / NULLIF(COUNT(*), 0))::NUMERIC(5,2) as taxa_cumprimento,
    -- Tempo médio baseado em data_prevista_pronto
    COALESCE(AVG(EXTRACT(DAY FROM (COALESCE(p.data_entregue, CURRENT_DATE) - p.data_pedido))), 5)::NUMERIC(5,1) as tempo_medio_producao,
    -- Score baseado na taxa de cumprimento + variação
    (80 + (COUNT(*) FILTER (WHERE 
      (p.data_entregue IS NOT NULL AND p.data_entregue <= COALESCE(p.data_sla_laboratorio, p.data_prevista_pronto)) OR
      (p.data_entregue IS NULL AND COALESCE(p.data_sla_laboratorio, p.data_prevista_pronto) >= CURRENT_DATE)
    ) * 20.0 / NULLIF(COUNT(*), 0)))::NUMERIC(4,1) as qualidade_score,
    CASE 
      WHEN (COUNT(*) FILTER (WHERE 
        (p.data_entregue IS NOT NULL AND p.data_entregue <= COALESCE(p.data_sla_laboratorio, p.data_prevista_pronto)) OR
        (p.data_entregue IS NULL AND COALESCE(p.data_sla_laboratorio, p.data_prevista_pronto) >= CURRENT_DATE)
      ) * 100.0 / NULLIF(COUNT(*), 0)) >= 95 THEN 'Excelente'
      WHEN (COUNT(*) FILTER (WHERE 
        (p.data_entregue IS NOT NULL AND p.data_entregue <= COALESCE(p.data_sla_laboratorio, p.data_prevista_pronto)) OR
        (p.data_entregue IS NULL AND COALESCE(p.data_sla_laboratorio, p.data_prevista_pronto) >= CURRENT_DATE)
      ) * 100.0 / NULLIF(COUNT(*), 0)) >= 85 THEN 'Muito Bom'
      WHEN (COUNT(*) FILTER (WHERE 
        (p.data_entregue IS NOT NULL AND p.data_entregue <= COALESCE(p.data_sla_laboratorio, p.data_prevista_pronto)) OR
        (p.data_entregue IS NULL AND COALESCE(p.data_sla_laboratorio, p.data_prevista_pronto) >= CURRENT_DATE)
      ) * 100.0 / NULLIF(COUNT(*), 0)) >= 75 THEN 'Bom'
      ELSE 'Necessita Melhoria'
    END as classificacao
  FROM pedidos p
  LEFT JOIN laboratorios l ON p.laboratorio_id = l.id
  WHERE p.data_pedido BETWEEN p_data_inicio AND p_data_fim
    AND p.status != 'CANCELADO'
  GROUP BY COALESCE(l.nome, 'Laboratório Principal')
  ORDER BY taxa_cumprimento DESC;
END;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |
| trigger_atualizar_datas_pedido  | 
BEGIN
  -- Atualizar data_entregue quando status muda para ENTREGUE
  IF NEW.status = 'ENTREGUE' AND (OLD.status IS NULL OR OLD.status != 'ENTREGUE') THEN
    NEW.data_entregue = CURRENT_DATE;
  END IF;
  
  -- Atualizar data_pagamento quando status muda para PAGO
  IF NEW.status = 'PAGO' AND (OLD.status IS NULL OR OLD.status != 'PAGO') THEN
    NEW.data_pagamento = CURRENT_DATE;
  END IF;
  
  -- Calcular data_prometida quando pedido é criado ou pago
  IF (TG_OP = 'INSERT') OR 
     (NEW.status = 'PAGO' AND (OLD.status IS NULL OR OLD.status != 'PAGO')) THEN
    
    -- Buscar SLA do laboratório + classe
    DECLARE
      sla_dias INTEGER := 5; -- padrão
    BEGIN
      -- Tentar buscar SLA específico da combinação lab+classe
      SELECT COALESCE(ls.sla_base_dias, cl.sla_base_dias, l.sla_padrao_dias, 5)
      INTO sla_dias
      FROM laboratorios l
      LEFT JOIN classes_lente cl ON cl.id = NEW.classe_lente_id
      LEFT JOIN laboratorio_sla ls ON ls.laboratorio_id = NEW.laboratorio_id 
        AND ls.classe_lente_id = NEW.classe_lente_id
      WHERE l.id = NEW.laboratorio_id;
      
      -- Ajustar por prioridade
      CASE NEW.prioridade
        WHEN 'URGENTE' THEN sla_dias := GREATEST(1, sla_dias - 3);
        WHEN 'ALTA' THEN sla_dias := GREATEST(2, sla_dias - 1);
        WHEN 'BAIXA' THEN sla_dias := sla_dias + 2;
        ELSE -- NORMAL, manter SLA base
      END CASE;
      
      -- Calcular data prometida
      NEW.data_prometida = COALESCE(NEW.data_pagamento, NEW.data_pedido) + (sla_dias || ' days')::INTERVAL;
    END;
  END IF;
  
  -- Sempre atualizar updated_at
  NEW.updated_at = NOW();
  
  RETURN NEW;
END;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |
| get_timeline_sla_7_dias         | 
BEGIN
  RETURN QUERY
  WITH datas AS (
    SELECT generate_series(
      CURRENT_DATE, 
      CURRENT_DATE + INTERVAL '6 days', 
      INTERVAL '1 day'
    )::DATE as data_ref
  )
  SELECT 
    d.data_ref as data_referencia,
    COUNT(p1.id) FILTER (WHERE 
      COALESCE(p1.data_sla_laboratorio, p1.data_prevista_pronto)::DATE = d.data_ref
    )::INTEGER as vencimentos_sla,
    COUNT(p2.id) FILTER (WHERE 
      COALESCE(p2.data_prometida, p2.data_prevista_pronto + INTERVAL '2 days')::DATE = d.data_ref
    )::INTEGER as entregas_prometidas,
    -- Capacidade estimada baseada em média histórica
    (CASE EXTRACT(DOW FROM d.data_ref)
      WHEN 0 THEN 8  -- Domingo
      WHEN 6 THEN 12 -- Sábado
      ELSE 20        -- Dias úteis
    END)::INTEGER as capacidade_estimada,
    -- Risco de gargalo
    (COUNT(p1.id) FILTER (WHERE 
      COALESCE(p1.data_sla_laboratorio, p1.data_prevista_pronto)::DATE = d.data_ref
    ) + COUNT(p2.id) FILTER (WHERE 
      COALESCE(p2.data_prometida, p2.data_prevista_pronto + INTERVAL '2 days')::DATE = d.data_ref
    )) > 
    (CASE EXTRACT(DOW FROM d.data_ref)
      WHEN 0 THEN 8
      WHEN 6 THEN 12
      ELSE 20
    END) as risco_gargalo,
    CASE 
      WHEN (COUNT(p1.id) + COUNT(p2.id)) > 20 THEN 'Programar horas extras'
      WHEN (COUNT(p1.id) + COUNT(p2.id)) > 15 THEN 'Monitorar capacidade'
      ELSE 'Capacidade normal'
    END as acoes_preventivas
  FROM datas d
  LEFT JOIN pedidos p1 ON COALESCE(p1.data_sla_laboratorio, p1.data_prevista_pronto)::DATE = d.data_ref
    AND p1.status IN ('PROCESSANDO', 'EM_PRODUCAO', 'AGUARDANDO_QUALIDADE')
  LEFT JOIN pedidos p2 ON COALESCE(p2.data_prometida, p2.data_prevista_pronto + INTERVAL '2 days')::DATE = d.data_ref
    AND p2.status IN ('PROCESSANDO', 'EM_PRODUCAO', 'AGUARDANDO_QUALIDADE')
  GROUP BY d.data_ref
  ORDER BY d.data_ref;
END;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |
| inserir_pedido_sem_trigger      | 
DECLARE
  novo_pedido_id UUID;
  v_numero_sequencial INTEGER;
  v_data_prometida DATE;
BEGIN
  novo_pedido_id := gen_random_uuid();
  
  SELECT COALESCE(MAX(p.numero_sequencial), 0) + 1
  INTO v_numero_sequencial 
  FROM pedidos p;
  
  IF p_data_prometida IS NULL THEN
    CASE p_prioridade
      WHEN 'URGENTE' THEN v_data_prometida := p_data_pedido + INTERVAL '2 days';
      WHEN 'ALTA' THEN v_data_prometida := p_data_pedido + INTERVAL '4 days';
      WHEN 'BAIXA' THEN v_data_prometida := p_data_pedido + INTERVAL '7 days';
      ELSE v_data_prometida := p_data_pedido + INTERVAL '5 days';
    END CASE;
  ELSE
    v_data_prometida := p_data_prometida;
  END IF;
  
  INSERT INTO pedidos (
    id, numero_sequencial, loja_id, laboratorio_id, classe_lente_id,
    status, prioridade, cliente_nome, cliente_telefone, observacoes,
    eh_garantia, data_pedido, data_prometida,
    data_prevista_pronto, data_sla_laboratorio,
    created_at, updated_at, created_by
  ) VALUES (
    novo_pedido_id, v_numero_sequencial, p_loja_id, p_laboratorio_id, p_classe_lente_id,
    p_status, p_prioridade, p_cliente_nome, p_cliente_telefone, p_observacoes,
    p_eh_garantia, p_data_pedido, v_data_prometida,
    v_data_prometida, v_data_prometida,
    NOW(), NOW(), 'funcao_bypass'
  );
  
  RETURN QUERY
  SELECT novo_pedido_id, v_numero_sequencial, p_cliente_nome, p_data_pedido, v_data_prometida, p_status, p_prioridade;
END;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   |
| inserir_timeline_pedido         | 
DECLARE
  v_responsavel_id UUID;
BEGIN
  -- Só registra se o status realmente mudou
  IF (TG_OP = 'INSERT') OR (OLD.status IS DISTINCT FROM NEW.status) THEN
    
    -- Tentar pegar o responsavel_id de forma segura
    BEGIN
      v_responsavel_id := CASE 
        WHEN NEW.updated_by IS NOT NULL AND NEW.updated_by ~ '^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$'
        THEN NEW.updated_by::UUID
        ELSE auth.uid()
      END;
    EXCEPTION WHEN OTHERS THEN
      v_responsavel_id := NULL;
    END;
    
    -- Inserir registro na timeline
    INSERT INTO pedidos_timeline (
      pedido_id,
      status_anterior,
      status_novo,
      responsavel_id,
      observacoes,
      created_at
    ) VALUES (
      NEW.id,
      CASE WHEN TG_OP = 'INSERT' THEN NULL ELSE OLD.status END,
      NEW.status,
      v_responsavel_id,
      CASE 
        WHEN TG_OP = 'INSERT' THEN 'Pedido criado'
        WHEN NEW.status = 'CANCELADO' THEN 'Pedido cancelado'
        WHEN NEW.status = 'ENTREGUE' THEN 'Pedido entregue ao cliente'
        WHEN NEW.status = 'AG_PAGAMENTO' THEN 'Aguardando confirmação de pagamento'
        WHEN NEW.status = 'PAGO' THEN 'Pagamento confirmado'
        WHEN NEW.status = 'PRODUCAO' THEN 'Enviado para produção'
        WHEN NEW.status = 'PRONTO' THEN 'Produção concluída'
        WHEN NEW.status = 'ENVIADO' THEN 'Enviado para a loja'
        WHEN NEW.status = 'CHEGOU' THEN 'Chegou na loja'
        ELSE 'Status atualizado: ' || OLD.status || ' → ' || NEW.status
      END,
      COALESCE(NEW.updated_at, NEW.created_at, NOW())
    );
    
  END IF;
  
  RETURN NEW;
END;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |
| get_alertas_sla_criticos        | 
BEGIN
  RETURN QUERY
  -- Alertas de atraso crítico
  SELECT 
    'atraso_' || p.id::TEXT as id,
    'atraso_critico'::TEXT as tipo,
    ('SLA Crítico - ' || ABS(p.dias_para_sla) || ' dias de atraso')::TEXT as titulo,
    ('OS #' || p.numero_sequencial || ' - ' || p.laboratorio_nome || 
     CASE WHEN p.eh_garantia THEN ' - GARANTIA' ELSE '' END)::TEXT as descricao,
    ('#' || p.numero_sequencial::TEXT) as pedido_os,
    p.laboratorio_nome as laboratorio,
    'Contatar laboratório imediatamente + verificar compensação cliente'::TEXT as acao_sugerida,
    'critica'::TEXT as severidade,
    p.dias_para_sla as dias_restantes
  FROM v_pedidos_kanban p
  WHERE p.dias_para_sla < -1  -- Mais de 1 dia de atraso
    AND p.status NOT IN ('ENTREGUE', 'CANCELADO')
    AND (p_loja_id IS NULL OR p.loja_id = p_loja_id)
  
  UNION ALL
  
  -- Alertas de SLA vencendo hoje/amanhã
  SELECT 
    'alerta_' || p.id::TEXT as id,
    'alerta_proximo'::TEXT as tipo,
    CASE 
      WHEN p.dias_para_sla = 0 THEN 'SLA vence hoje'
      WHEN p.dias_para_sla = 1 THEN 'SLA vence amanhã'
      ELSE 'SLA próximo do vencimento'
    END as titulo,
    ('OS #' || p.numero_sequencial || ' - ' || p.laboratorio_nome)::TEXT as descricao,
    ('#' || p.numero_sequencial::TEXT) as pedido_os,
    p.laboratorio_nome as laboratorio,
    'Acompanhar status de produção e avisar cliente se necessário'::TEXT as acao_sugerida,
    'alta'::TEXT as severidade,
    p.dias_para_sla as dias_restantes
  FROM v_pedidos_kanban p
  WHERE p.dias_para_sla BETWEEN 0 AND 1
    AND p.status NOT IN ('ENTREGUE', 'CANCELADO')
    AND (p_loja_id IS NULL OR p.loja_id = p_loja_id)
  
  ORDER BY dias_restantes ASC, severidade DESC
  LIMIT 10;
END;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |



-- 8. Verificar triggers na tabela pedidos
SELECT 
  trigger_name,
  event_manipulation,
  action_statement
FROM information_schema.triggers
WHERE event_object_table = 'pedidos';


| trigger_name                          | event_manipulation | action_statement                                       |
| ------------------------------------- | ------------------ | ------------------------------------------------------ |
| trigger_atualizar_datas_pedido        | INSERT             | EXECUTE FUNCTION trigger_atualizar_datas_pedido()      |
| trigger_atualizar_datas_pedido        | UPDATE             | EXECUTE FUNCTION trigger_atualizar_datas_pedido()      |
| trigger_auto_enviar_montagem          | UPDATE             | EXECUTE FUNCTION trigger_auto_enviar_montagem()        |
| trigger_calcular_margem_lente         | INSERT             | EXECUTE FUNCTION calcular_margem_lente()               |
| trigger_calcular_margem_lente         | UPDATE             | EXECUTE FUNCTION calcular_margem_lente()               |
| trigger_controle_os                   | INSERT             | EXECUTE FUNCTION sync_controle_os()                    |
| trigger_controle_os                   | UPDATE             | EXECUTE FUNCTION sync_controle_os()                    |
| trigger_criar_evento_timeline         | INSERT             | EXECUTE FUNCTION trigger_criar_evento_timeline()       |
| trigger_criar_evento_timeline         | UPDATE             | EXECUTE FUNCTION trigger_criar_evento_timeline()       |
| trigger_pedido_adicionar_os_sequencia | INSERT             | EXECUTE FUNCTION trigger_auto_adicionar_os_sequencia() |
| trigger_pedido_adicionar_os_sequencia | UPDATE             | EXECUTE FUNCTION trigger_auto_adicionar_os_sequencia() |
| trigger_pedidos_timeline              | INSERT             | EXECUTE FUNCTION inserir_timeline_pedido()             |
| trigger_pedidos_timeline              | UPDATE             | EXECUTE FUNCTION inserir_timeline_pedido()             |
| trigger_populate_data_prometida       | INSERT             | EXECUTE FUNCTION populate_data_prometida()             |
| trigger_populate_data_prometida       | UPDATE             | EXECUTE FUNCTION populate_data_prometida()             |


-- =====

=======================================================================
-- INSTRUÇÕES DE EXECUÇÃO
-- ============================================================================
-- 1. Execute no Supabase Dashboard (SQL Editor)
-- 2. Copie TODOS os resultados
-- 3. Cole aqui no chat para analisarmos juntos
-- 4. Especialmente importante: Query #2, #4 e #5
-- ============================================================================
