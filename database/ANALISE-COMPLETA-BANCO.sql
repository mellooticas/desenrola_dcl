-- =========================================
-- ANÁLISE COMPLETA DO BANCO DE DADOS
-- =========================================
-- Inventário total: tabelas, views, functions, triggers, policies

-- ========== 1. TABELAS ==========
-- Listar todas as tabelas com informações de uso
SELECT 
  c.relname as tablename,
  CASE WHEN c.relrowsecurity THEN 'true' ELSE 'false' END as tem_rls,
  pg_size_pretty(pg_total_relation_size(c.oid)) as tamanho,
  (SELECT COUNT(*) FROM pg_policies WHERE tablename = c.relname) as num_policies,
  (SELECT COUNT(*) FROM information_schema.triggers WHERE event_object_table = c.relname) as num_triggers,
  c.reltuples::bigint as estimativa_registros
FROM pg_class c
JOIN pg_namespace n ON n.oid = c.relnamespace
WHERE n.nspname = 'public'
  AND c.relkind = 'r'  -- apenas tabelas regulares
  AND c.relname NOT LIKE 'pg_%'
  AND c.relname NOT LIKE 'sql_%'
ORDER BY pg_total_relation_size(c.oid) DESC;

| tablename                     | tem_rls | tamanho | num_policies | num_triggers | estimativa_registros |
| ----------------------------- | ------- | ------- | ------------ | ------------ | -------------------- |
| os_sequencia                  | true    | 350 MB  | 4            | 1            | 4304                 |
| controle_os                   | true    | 75 MB   | 3            | 0            | 2006                 |
| pedido_eventos                | true    | 3960 kB | 8            | 0            | 8317                 |
| pedidos                       | true    | 3168 kB | 2            | 15           | 637                  |
| pedidos_timeline              | true    | 1200 kB | 3            | 1            | 4325                 |
| missoes_diarias               | true    | 376 kB  | 7            | 1            | 699                  |
| missao_templates              | false   | 112 kB  | 0            | 0            | -1                   |
| usuarios                      | false   | 80 kB   | 1            | 0            | 7                    |
| pedidos_historico             | true    | 64 kB   | 3            | 0            | -1                   |
| tratamentos                   | true    | 64 kB   | 2            | 0            | 6                    |
| pedido_tratamentos            | true    | 56 kB   | 3            | 0            | 6                    |
| lojas                         | false   | 48 kB   | 1            | 0            | -1                   |
| laboratorios                  | false   | 48 kB   | 2            | 1            | 0                    |
| role_permissions              | true    | 48 kB   | 3            | 0            | -1                   |
| role_status_permissoes_legacy | true    | 48 kB   | 3            | 0            | -1                   |
| loja_acoes_customizadas       | false   | 48 kB   | 0            | 1            | -1                   |
| os_nao_lancadas               | true    | 48 kB   | 5            | 1            | -1                   |
| alertas                       | true    | 48 kB   | 4            | 0            | -1                   |
| classes_lente                 | false   | 48 kB   | 1            | 0            | 19                   |
| user_sessions                 | true    | 48 kB   | 2            | 0            | -1                   |
| notificacoes                  | true    | 40 kB   | 3            | 0            | -1                   |
| renovacao_diaria              | false   | 40 kB   | 0            | 0            | -1                   |
| laboratorio_sla               | false   | 40 kB   | 1            | 0            | 78                   |
| colaboradores                 | true    | 32 kB   | 3            | 0            | -1                   |
| sistema_config                | false   | 32 kB   | 1            | 0            | -1                   |
| montadores                    | true    | 32 kB   | 11           | 1            | -1                   |
| desafios                      | false   | 32 kB   | 0            | 0            | -1                   |
| loja_configuracoes_horario    | false   | 24 kB   | 0            | 1            | -1                   |
| clientes                      | true    | 24 kB   | 3            | 0            | -1                   |
| desafios_participacao         | false   | 16 kB   | 0            | 0            | -1                   |



-- ========== 2. VIEWS ==========
-- Listar todas as views
SELECT 
  viewname as nome_view,
  definition as definicao_resumo
FROM pg_views
WHERE schemaname = 'public'
ORDER BY viewname;

| nome_view                          | definicao_resumo                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           |
| ---------------------------------- | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| v_alertas_criticos                 |  WITH alertas_laboratorios AS (
         SELECT 'LABORATÓRIO EM RISCO'::text AS tipo_alerta,
            'ALTA'::text AS prioridade,
            lab.nome AS laboratorio_nome,
            (('SLA muito baixo: '::text || round(sla_stats.sla_compliance, 1)) || '%'::text) AS problema,
            sla_stats.total_pedidos AS pedidos_afetados,
            sla_stats.faturamento_total AS valor_risco,
            sla_stats.sla_compliance AS indicador_numerico,
            'Revisar processos com laboratório e definir plano de ação'::text AS acao_sugerida,
            'Imediato (24h)'::text AS prazo_acao,
            'Gestor de Operações'::text AS responsavel
           FROM (laboratorios lab
             JOIN ( SELECT p.laboratorio_id,
                    count(*) AS total_pedidos,
                    round((((count(*) FILTER (WHERE (((p.status)::text = 'ENTREGUE'::text) AND (p.data_entregue <= p.data_prometida))))::numeric * 100.0) / (NULLIF(count(*) FILTER (WHERE ((p.status)::text = 'ENTREGUE'::text)), 0))::numeric), 2) AS sla_compliance,
                    sum(p.valor_pedido) AS faturamento_total
                   FROM pedidos p
                  WHERE (p.data_pedido >= (CURRENT_DATE - '90 days'::interval))
                  GROUP BY p.laboratorio_id
                 HAVING (count(*) >= 5)) sla_stats ON ((lab.id = sla_stats.laboratorio_id)))
          WHERE ((sla_stats.sla_compliance < (60)::numeric) AND (lab.ativo = true))
        UNION ALL
         SELECT 'PRODUÇÃO ATRASADA'::text AS tipo_alerta,
            'CRÍTICA'::text AS prioridade,
            lab.nome AS laboratorio_nome,
            (atraso_stats.pedidos_atrasados || ' pedidos com produção atrasada'::text) AS problema,
            atraso_stats.pedidos_atrasados AS pedidos_afetados,
            atraso_stats.valor_em_risco AS valor_risco,
            round((((atraso_stats.pedidos_atrasados)::numeric * 100.0) / (atraso_stats.total_pedidos)::numeric), 1) AS indicador_numerico,
            'Contatar laboratório urgentemente para status dos pedidos'::text AS acao_sugerida,
            'Imediato (4h)'::text AS prazo_acao,
            'Coordenador de Produção'::text AS responsavel
           FROM (laboratorios lab
             JOIN ( SELECT p.laboratorio_id,
                    count(*) AS total_pedidos,
                    count(*) FILTER (WHERE (p.producao_atrasada = true)) AS pedidos_atrasados,
                    sum(
                        CASE
                            WHEN (p.producao_atrasada = true) THEN p.valor_pedido
                            ELSE (0)::numeric
                        END) AS valor_em_risco
                   FROM pedidos p
                  WHERE ((p.data_pedido >= (CURRENT_DATE - '30 days'::interval)) AND ((p.status)::text = ANY ((ARRAY['PRODUCAO'::character varying, 'PRONTO'::character varying, 'ENVIADO'::character varying])::text[])))
                  GROUP BY p.laboratorio_id) atraso_stats ON ((lab.id = atraso_stats.laboratorio_id)))
          WHERE ((atraso_stats.pedidos_atrasados >= 3) AND (lab.ativo = true))
        UNION ALL
         SELECT 'PEDIDO URGENTE PARADO'::text AS tipo_alerta,
            'CRÍTICA'::text AS prioridade,
            lab.nome AS laboratorio_nome,
            (urgente_stats.pedidos_parados || ' pedidos urgentes há mais de 2 dias no mesmo status'::text) AS problema,
            urgente_stats.pedidos_parados AS pedidos_afetados,
            urgente_stats.valor_urgente AS valor_risco,
            urgente_stats.dias_medio_parado AS indicador_numerico,
            'Verificar status e desbloquear pedidos urgentes imediatamente'::text AS acao_sugerida,
            'Imediato (2h)'::text AS prazo_acao,
            'Supervisor de Produção'::text AS responsavel
           FROM (laboratorios lab
             JOIN ( SELECT p.laboratorio_id,
                    count(*) AS pedidos_parados,
                    sum(p.valor_pedido) AS valor_urgente,
                    avg((CURRENT_DATE - (p.updated_at)::date)) AS dias_medio_parado
                   FROM pedidos p
                  WHERE (((p.prioridade)::text = 'URGENTE'::text) AND ((p.status)::text <> ALL ((ARRAY['ENTREGUE'::character varying, 'CANCELADO'::character varying])::text[])) AND (p.updated_at <= (CURRENT_DATE - '2 days'::interval)))
                  GROUP BY p.laboratorio_id) urgente_stats ON ((lab.id = urgente_stats.laboratorio_id)))
          WHERE ((urgente_stats.pedidos_parados >= 1) AND (lab.ativo = true))
        UNION ALL
         SELECT 'VOLUME MUITO BAIXO'::text AS tipo_alerta,
            'MÉDIA'::text AS prioridade,
            lab.nome AS laboratorio_nome,
            (COALESCE(volume_stats.pedidos_mes, (0)::bigint) || ' pedidos no último mês (abaixo do esperado)'::text) AS problema,
            COALESCE(volume_stats.pedidos_mes, (0)::bigint) AS pedidos_afetados,
            COALESCE(volume_stats.faturamento_mes, (0)::numeric) AS valor_risco,
            COALESCE(volume_stats.pedidos_mes, (0)::bigint) AS indicador_numerico,
            'Verificar problemas de qualidade ou comunicação com laboratório'::text AS acao_sugerida,
            '1 semana'::text AS prazo_acao,
            'Gerente Comercial'::text AS responsavel
           FROM (laboratorios lab
             LEFT JOIN ( SELECT p.laboratorio_id,
                    count(*) AS pedidos_mes,
                    sum(p.valor_pedido) AS faturamento_mes
                   FROM pedidos p
                  WHERE (p.data_pedido >= (CURRENT_DATE - '30 days'::interval))
                  GROUP BY p.laboratorio_id) volume_stats ON ((lab.id = volume_stats.laboratorio_id)))
          WHERE ((COALESCE(volume_stats.pedidos_mes, (0)::bigint) < 5) AND (lab.ativo = true))
        UNION ALL
         SELECT 'PAGAMENTOS VENCIDOS'::text AS tipo_alerta,
            'ALTA'::text AS prioridade,
            'Sistema Financeiro'::text AS laboratorio_nome,
            (pagto_stats.pedidos_vencidos || ' pedidos com pagamento vencido há mais de 5 dias'::text) AS problema,
            pagto_stats.pedidos_vencidos AS pedidos_afetados,
            pagto_stats.valor_vencido AS valor_risco,
            pagto_stats.dias_medio_vencido AS indicador_numerico,
            'Entrar em contato com clientes para regularizar pagamentos'::text AS acao_sugerida,
            '2 dias úteis'::text AS prazo_acao,
            'Equipe Financeira'::text AS responsavel
           FROM ( SELECT count(*) AS pedidos_vencidos,
                    sum(p.valor_pedido) AS valor_vencido,
                    avg((CURRENT_DATE - p.data_limite_pagamento)) AS dias_medio_vencido
                   FROM pedidos p
                  WHERE (((p.status)::text = 'AG_PAGAMENTO'::text) AND (p.data_limite_pagamento IS NOT NULL) AND (p.data_limite_pagamento < (CURRENT_DATE - '5 days'::interval)))) pagto_stats
          WHERE (pagto_stats.pedidos_vencidos > 0)
        ), alertas_ordenados AS (
         SELECT alertas_laboratorios.tipo_alerta,
            alertas_laboratorios.prioridade,
            alertas_laboratorios.laboratorio_nome,
            alertas_laboratorios.problema,
            alertas_laboratorios.pedidos_afetados,
            alertas_laboratorios.valor_risco,
            alertas_laboratorios.indicador_numerico,
            alertas_laboratorios.acao_sugerida,
            alertas_laboratorios.prazo_acao,
            alertas_laboratorios.responsavel,
            row_number() OVER (ORDER BY
                CASE alertas_laboratorios.prioridade
                    WHEN 'CRÍTICA'::text THEN 1
                    WHEN 'ALTA'::text THEN 2
                    WHEN 'MÉDIA'::text THEN 3
                    ELSE 4
                END, alertas_laboratorios.valor_risco DESC, alertas_laboratorios.pedidos_afetados DESC) AS ordem_prioridade
           FROM alertas_laboratorios
        )
 SELECT alertas_ordenados.tipo_alerta,
    alertas_ordenados.prioridade,
    alertas_ordenados.laboratorio_nome,
    alertas_ordenados.problema,
    alertas_ordenados.pedidos_afetados,
    round(alertas_ordenados.valor_risco, 2) AS valor_risco,
    alertas_ordenados.indicador_numerico,
    alertas_ordenados.acao_sugerida,
    alertas_ordenados.prazo_acao,
    alertas_ordenados.responsavel,
    alertas_ordenados.ordem_prioridade
   FROM alertas_ordenados
  ORDER BY alertas_ordenados.ordem_prioridade; |
| v_analise_financeira               |  SELECT cl.categoria,
    count(p.id) AS volume_pedidos,
    count(*) FILTER (WHERE ((p.status)::text = 'ENTREGUE'::text)) AS pedidos_entregues,
    COALESCE(sum(p.valor_pedido), (0)::numeric) AS faturamento_total,
    round(avg(p.valor_pedido), 2) AS ticket_medio,
    round(avg(
        CASE
            WHEN (((p.status)::text = 'ENTREGUE'::text) AND (p.data_entregue IS NOT NULL) AND (p.data_pedido IS NOT NULL)) THEN (p.data_entregue - p.data_pedido)
            ELSE NULL::integer
        END), 1) AS lead_time_medio,
    round((((count(*) FILTER (WHERE (((p.status)::text = 'ENTREGUE'::text) AND (p.data_entregue <= p.data_prometida))))::numeric * 100.0) / (NULLIF(count(*) FILTER (WHERE ((p.status)::text = 'ENTREGUE'::text)), 0))::numeric), 2) AS sla_compliance,
    count(*) FILTER (WHERE ((p.status)::text = 'REGISTRADO'::text)) AS registrados,
    count(*) FILTER (WHERE ((p.status)::text = 'AG_PAGAMENTO'::text)) AS aguardando_pagamento,
    count(*) FILTER (WHERE ((p.status)::text = 'PRODUCAO'::text)) AS em_producao,
    count(*) FILTER (WHERE ((p.status)::text = 'ENTREGUE'::text)) AS entregues,
    round(avg((CURRENT_DATE - p.data_pedido)), 0) AS idade_media_dias,
    'N/A'::text AS laboratorio_mais_usado
   FROM (classes_lente cl
     LEFT JOIN pedidos p ON (((cl.id = p.classe_lente_id) AND (p.data_pedido >= (CURRENT_DATE - '90 days'::interval)))))
  WHERE (cl.ativa = true)
  GROUP BY cl.id, cl.categoria, cl.nome
 HAVING (count(p.id) > 0)
  ORDER BY COALESCE(sum(p.valor_pedido), (0)::numeric) DESC;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |
| v_analise_sazonalidade             |  SELECT EXTRACT(dow FROM p.data_pedido) AS dia_semana,
        CASE EXTRACT(dow FROM p.data_pedido)
            WHEN 0 THEN 'Domingo'::text
            WHEN 1 THEN 'Segunda'::text
            WHEN 2 THEN 'Terça'::text
            WHEN 3 THEN 'Quarta'::text
            WHEN 4 THEN 'Quinta'::text
            WHEN 5 THEN 'Sexta'::text
            WHEN 6 THEN 'Sábado'::text
            ELSE NULL::text
        END AS nome_dia_semana,
    count(*) AS total_pedidos,
    round(avg(p.valor_pedido), 2) AS ticket_medio,
    round(avg(
        CASE
            WHEN (((p.status)::text = 'ENTREGUE'::text) AND (p.data_entregue IS NOT NULL) AND (p.data_pedido IS NOT NULL)) THEN (p.data_entregue - p.data_pedido)
            ELSE NULL::integer
        END), 1) AS lead_time_medio,
    count(*) FILTER (WHERE ((p.prioridade)::text = 'URGENTE'::text)) AS pedidos_urgentes,
    count(DISTINCT p.laboratorio_id) AS labs_diferentes,
    round((((count(*))::numeric * 100.0) / sum(count(*)) OVER ()), 1) AS percentual_total
   FROM pedidos p
  WHERE (p.data_pedido >= (CURRENT_DATE - '90 days'::interval))
  GROUP BY (EXTRACT(dow FROM p.data_pedido))
  ORDER BY (EXTRACT(dow FROM p.data_pedido));                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
| v_correlacoes                      |  SELECT v_dashboard_bi.prioridade,
    v_dashboard_bi.classe_categoria,
    count(*) AS total_pedidos,
    round(avg(
        CASE
            WHEN ((v_dashboard_bi.prioridade)::text = 'URGENTE'::text) THEN ((v_dashboard_bi.lead_time_total_horas)::numeric / (24)::numeric)
            ELSE NULL::numeric
        END), 1) AS lead_time_urgente,
    round(avg(
        CASE
            WHEN ((v_dashboard_bi.prioridade)::text = 'NORMAL'::text) THEN ((v_dashboard_bi.lead_time_total_horas)::numeric / (24)::numeric)
            ELSE NULL::numeric
        END), 1) AS lead_time_normal,
    round(avg(
        CASE
            WHEN ((v_dashboard_bi.prioridade)::text = 'URGENTE'::text) THEN v_dashboard_bi.valor_pedido
            ELSE NULL::numeric
        END), 2) AS ticket_urgente,
    round(avg(
        CASE
            WHEN ((v_dashboard_bi.prioridade)::text = 'NORMAL'::text) THEN v_dashboard_bi.valor_pedido
            ELSE NULL::numeric
        END), 2) AS ticket_normal,
    round((((count(*) FILTER (WHERE ((v_dashboard_bi.status_sla = 'NO_PRAZO'::text) AND ((v_dashboard_bi.prioridade)::text = 'URGENTE'::text))))::numeric / (NULLIF(count(*) FILTER (WHERE (((v_dashboard_bi.status)::text = 'ENTREGUE'::text) AND ((v_dashboard_bi.prioridade)::text = 'URGENTE'::text))), 0))::numeric) * (100)::numeric), 1) AS sla_urgente,
    round((((count(*) FILTER (WHERE ((v_dashboard_bi.status_sla = 'NO_PRAZO'::text) AND ((v_dashboard_bi.prioridade)::text = 'NORMAL'::text))))::numeric / (NULLIF(count(*) FILTER (WHERE (((v_dashboard_bi.status)::text = 'ENTREGUE'::text) AND ((v_dashboard_bi.prioridade)::text = 'NORMAL'::text))), 0))::numeric) * (100)::numeric), 1) AS sla_normal
   FROM v_dashboard_bi
  WHERE ((v_dashboard_bi.data_pedido >= (CURRENT_DATE - '90 days'::interval)) AND (v_dashboard_bi.lead_time_total_horas IS NOT NULL))
  GROUP BY v_dashboard_bi.prioridade, v_dashboard_bi.classe_categoria
  ORDER BY v_dashboard_bi.classe_categoria, v_dashboard_bi.prioridade;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |
| v_dashboard_bi                     |  SELECT p.id,
    p.numero_sequencial,
    p.numero_os_fisica,
    p.status,
    p.prioridade,
    p.data_pedido,
    p.data_inicio_producao,
    p.data_conclusao_producao,
    p.lead_time_producao_horas,
    p.lead_time_total_horas,
    p.valor_pedido,
    l.nome AS loja_nome,
    l.codigo AS loja_codigo,
    lab.nome AS laboratorio_nome,
    lab.codigo AS laboratorio_codigo,
    cl.nome AS classe_nome,
    cl.categoria AS classe_categoria,
    cl.cor_badge,
    (EXTRACT(epoch FROM (p.data_conclusao_producao - p.data_inicio_producao)) / (3600)::numeric) AS horas_producao_real,
    ((EXTRACT(epoch FROM (now() - p.created_at)) / (24)::numeric) / (3600)::numeric) AS dias_desde_criacao,
        CASE
            WHEN (((p.status)::text = 'ENTREGUE'::text) AND (p.lead_time_total_horas <= (cl.sla_base_dias * 24))) THEN 'NO_PRAZO'::text
            WHEN (((p.status)::text = 'ENTREGUE'::text) AND (p.lead_time_total_horas > (cl.sla_base_dias * 24))) THEN 'ATRASADO'::text
            WHEN (((p.status)::text <> 'ENTREGUE'::text) AND (((EXTRACT(epoch FROM (now() - p.created_at)) / (24)::numeric) / (3600)::numeric) <= (cl.sla_base_dias)::numeric)) THEN 'EM_ANDAMENTO'::text
            ELSE 'RISCO_ATRASO'::text
        END AS status_sla,
    EXTRACT(year FROM p.data_pedido) AS ano,
    EXTRACT(month FROM p.data_pedido) AS mes,
    to_char((p.data_pedido)::timestamp with time zone, 'YYYY-MM'::text) AS ano_mes
   FROM (((pedidos p
     LEFT JOIN lojas l ON ((p.loja_id = l.id)))
     LEFT JOIN laboratorios lab ON ((p.laboratorio_id = lab.id)))
     LEFT JOIN classes_lente cl ON ((p.classe_lente_id = cl.id)));                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
| v_dashboard_kpis                   |  SELECT count(p.id) AS total_pedidos,
    count(*) FILTER (WHERE ((p.status)::text = 'ENTREGUE'::text)) AS entregues,
    round(avg(
        CASE
            WHEN (((p.status)::text = 'ENTREGUE'::text) AND (p.data_entregue IS NOT NULL) AND (p.data_pedido IS NOT NULL)) THEN (p.data_entregue - p.data_pedido)
            ELSE NULL::integer
        END), 1) AS lead_time_medio,
    count(*) FILTER (WHERE (p.pagamento_atrasado = true)) AS pedidos_atrasados,
    round(avg(p.valor_pedido), 2) AS ticket_medio,
    round((((count(*) FILTER (WHERE (((p.status)::text = 'ENTREGUE'::text) AND (p.data_entregue <= p.data_prometida))))::numeric * 100.0) / (NULLIF(count(*) FILTER (WHERE ((p.status)::text = 'ENTREGUE'::text)), 0))::numeric), 2) AS sla_compliance,
    count(DISTINCT p.laboratorio_id) AS labs_ativos,
    COALESCE(sum(p.valor_pedido), (0)::numeric) AS valor_total_vendas,
    COALESCE(sum(p.custo_lentes), (0)::numeric) AS custo_total_lentes,
        CASE
            WHEN (sum(p.valor_pedido) > (0)::numeric) THEN round((((sum(p.valor_pedido) - COALESCE(sum(p.custo_lentes), (0)::numeric)) / sum(p.valor_pedido)) * (100)::numeric), 2)
            ELSE (0)::numeric
        END AS margem_percentual,
    count(*) FILTER (WHERE (p.eh_garantia = true)) AS pedidos_garantia,
    0 AS total_pedidos_anterior,
    0 AS entregues_anterior,
    NULL::text AS lead_time_anterior,
    0 AS atrasados_anterior,
    NULL::text AS ticket_anterior,
    NULL::text AS margem_anterior,
    NULL::text AS sla_anterior,
    0 AS labs_anterior,
    'up'::text AS tendencia_pedidos,
    NULL::text AS variacao_pedidos,
    NULL::text AS variacao_lead_time,
    NULL::text AS variacao_sla
   FROM pedidos p;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
| v_dashboard_kpis_full              |  WITH dados_completos AS (
         SELECT count(*) AS total_pedidos,
            count(*) FILTER (WHERE ((pedidos.status)::text = 'ENTREGUE'::text)) AS entregues,
            round(avg(pedidos.valor_pedido), 2) AS ticket_medio,
            round(sum(pedidos.valor_pedido), 2) AS valor_total_vendas,
            count(DISTINCT pedidos.laboratorio_id) AS labs_ativos
           FROM pedidos
        )
 SELECT dados_completos.total_pedidos,
    dados_completos.entregues,
    dados_completos.ticket_medio,
    dados_completos.valor_total_vendas,
    dados_completos.labs_ativos
   FROM dados_completos;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   |
| v_dashboard_resumo                 |  SELECT count(*) AS total_pedidos,
    count(
        CASE
            WHEN ((pedidos.status)::text = 'REGISTRADO'::text) THEN 1
            ELSE NULL::integer
        END) AS registrados,
    count(
        CASE
            WHEN ((pedidos.status)::text = 'AG_PAGAMENTO'::text) THEN 1
            ELSE NULL::integer
        END) AS aguardando_pagamento,
    count(
        CASE
            WHEN ((pedidos.status)::text = 'PAGO'::text) THEN 1
            ELSE NULL::integer
        END) AS pagos,
    count(
        CASE
            WHEN ((pedidos.status)::text = 'PRODUCAO'::text) THEN 1
            ELSE NULL::integer
        END) AS em_producao,
    count(
        CASE
            WHEN ((pedidos.status)::text = 'PRONTO'::text) THEN 1
            ELSE NULL::integer
        END) AS prontos,
    count(
        CASE
            WHEN ((pedidos.status)::text = 'ENVIADO'::text) THEN 1
            ELSE NULL::integer
        END) AS enviados,
    count(
        CASE
            WHEN ((pedidos.status)::text = 'CHEGOU'::text) THEN 1
            ELSE NULL::integer
        END) AS chegaram,
    count(
        CASE
            WHEN ((pedidos.status)::text = 'ENTREGUE'::text) THEN 1
            ELSE NULL::integer
        END) AS entregues,
    count(
        CASE
            WHEN (pedidos.pagamento_atrasado = true) THEN 1
            ELSE NULL::integer
        END) AS pagamentos_atrasados,
    count(
        CASE
            WHEN (pedidos.producao_atrasada = true) THEN 1
            ELSE NULL::integer
        END) AS producao_atrasada,
    count(
        CASE
            WHEN (pedidos.requer_atencao = true) THEN 1
            ELSE NULL::integer
        END) AS requer_atencao
   FROM pedidos
  WHERE (pedidos.data_pedido >= (CURRENT_DATE - '30 days'::interval));                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
| v_evolucao_mensal                  |  SELECT date_trunc('month'::text, (p.data_pedido)::timestamp with time zone) AS periodo,
    to_char(date_trunc('month'::text, (p.data_pedido)::timestamp with time zone), 'Mon'::text) AS mes_nome,
    count(*) AS total_pedidos,
    count(*) FILTER (WHERE ((p.status)::text = 'ENTREGUE'::text)) AS entregues,
    round(avg(p.valor_pedido), 2) AS ticket_medio,
    round(avg(
        CASE
            WHEN (((p.status)::text = 'ENTREGUE'::text) AND (p.data_entregue IS NOT NULL) AND (p.data_pedido IS NOT NULL)) THEN (p.data_entregue - p.data_pedido)
            ELSE NULL::integer
        END), 1) AS lead_time_medio,
    round((((count(*) FILTER (WHERE (((p.status)::text = 'ENTREGUE'::text) AND (p.data_entregue <= p.data_prometida))))::numeric * 100.0) / (NULLIF(count(*) FILTER (WHERE ((p.status)::text = 'ENTREGUE'::text)), 0))::numeric), 2) AS sla_compliance,
    count(*) FILTER (WHERE (p.eh_garantia = true)) AS garantias,
    round((((count(*) FILTER (WHERE (p.eh_garantia = true)))::numeric * 100.0) / (count(*))::numeric), 1) AS taxa_garantia,
    COALESCE(sum(p.valor_pedido), (0)::numeric) AS faturamento_total,
    COALESCE(sum(p.custo_lentes), (0)::numeric) AS custo_total,
        CASE
            WHEN (sum(p.valor_pedido) > (0)::numeric) THEN round((((sum(p.valor_pedido) - COALESCE(sum(p.custo_lentes), (0)::numeric)) / sum(p.valor_pedido)) * (100)::numeric), 2)
            ELSE (0)::numeric
        END AS margem_percentual,
    count(DISTINCT p.laboratorio_id) AS labs_ativos,
    count(DISTINCT p.loja_id) AS lojas_ativas,
    count(*) FILTER (WHERE ((p.prioridade)::text = 'URGENTE'::text)) AS pedidos_urgentes
   FROM pedidos p
  GROUP BY (date_trunc('month'::text, (p.data_pedido)::timestamp with time zone))
  ORDER BY (date_trunc('month'::text, (p.data_pedido)::timestamp with time zone)) DESC;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |
| v_heatmap_sla                      |  SELECT v_dashboard_bi.laboratorio_nome,
    v_dashboard_bi.classe_categoria,
    v_dashboard_bi.classe_nome,
    count(*) AS total_pedidos,
    round((((count(*) FILTER (WHERE (v_dashboard_bi.status_sla = 'NO_PRAZO'::text)))::numeric / (NULLIF(count(*) FILTER (WHERE ((v_dashboard_bi.status)::text = 'ENTREGUE'::text)), 0))::numeric) * (100)::numeric), 1) AS sla_compliance,
    round(avg(((v_dashboard_bi.lead_time_total_horas)::numeric / (24)::numeric)), 1) AS lead_time_medio,
    count(*) FILTER (WHERE (v_dashboard_bi.status_sla = 'ATRASADO'::text)) AS pedidos_atrasados,
    round(avg(v_dashboard_bi.valor_pedido), 2) AS ticket_medio
   FROM v_dashboard_bi
  WHERE ((v_dashboard_bi.data_pedido >= (CURRENT_DATE - '90 days'::interval)) AND ((v_dashboard_bi.status)::text = ANY ((ARRAY['ENTREGUE'::character varying, 'ENVIADO'::character varying, 'CHEGOU'::character varying])::text[])))
  GROUP BY v_dashboard_bi.laboratorio_nome, v_dashboard_bi.classe_categoria, v_dashboard_bi.classe_nome
 HAVING (count(*) >= 1)
  ORDER BY (count(*)) DESC;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   |
| v_kanban_colunas                   |  SELECT 'pendente'::text AS coluna_id,
    'Pendente'::text AS coluna_nome,
    '⏳'::text AS icone,
    1 AS ordem,
    'Aguardando DCL escolher lente e registrar no laboratório'::text AS descricao,
    '#94a3b8'::text AS cor
UNION ALL
 SELECT 'rascunho'::text AS coluna_id,
    'Rascunho'::text AS coluna_nome,
    '📝'::text AS icone,
    2 AS ordem,
    'Pedido em rascunho'::text AS descricao,
    '#6b7280'::text AS cor
UNION ALL
 SELECT 'registrado'::text AS coluna_id,
    'Registrado'::text AS coluna_nome,
    '📋'::text AS icone,
    3 AS ordem,
    'Registrado no laboratório, aguardando número do pedido'::text AS descricao,
    '#3b82f6'::text AS cor
UNION ALL
 SELECT 'pago'::text AS coluna_id,
    'Pago'::text AS coluna_nome,
    '💰'::text AS icone,
    4 AS ordem,
    'Pagamento confirmado'::text AS descricao,
    '#eab308'::text AS cor
UNION ALL
 SELECT 'producao'::text AS coluna_id,
    'Produção'::text AS coluna_nome,
    '⚙️'::text AS icone,
    5 AS ordem,
    'Em produção no laboratório'::text AS descricao,
    '#f97316'::text AS cor
UNION ALL
 SELECT 'pronto'::text AS coluna_id,
    'Pronto'::text AS coluna_nome,
    '✅'::text AS icone,
    6 AS ordem,
    'Pronto no laboratório'::text AS descricao,
    '#8b5cf6'::text AS cor
UNION ALL
 SELECT 'enviado'::text AS coluna_id,
    'Enviado'::text AS coluna_nome,
    '📦'::text AS icone,
    7 AS ordem,
    'Laboratório enviou o produto'::text AS descricao,
    '#8b5cf6'::text AS cor
UNION ALL
 SELECT 'entregue'::text AS coluna_id,
    'Entregue'::text AS coluna_nome,
    '🎉'::text AS icone,
    8 AS ordem,
    'Produto entregue na loja'::text AS descricao,
    '#10b981'::text AS cor
  ORDER BY 4;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |
| v_kanban_fluxo_ativo               |  SELECT p.id,
    p.numero_sequencial,
    p.numero_os_fisica,
    p.numero_pedido_laboratorio,
    p.status,
    p.prioridade,
    p.cliente_nome,
    p.cliente_telefone,
    p.valor_pedido,
    p.custo_lentes,
    p.eh_garantia,
    p.observacoes,
    p.data_pedido,
    p.data_prevista_pronto,
    p.data_pagamento,
    p.forma_pagamento,
    p.created_at,
    p.updated_at,
    l.nome AS loja_nome,
    l.codigo AS loja_codigo,
    lab.nome AS laboratorio_nome,
    cl.nome AS classe_nome,
    cl.categoria AS classe_categoria,
    cl.cor_badge AS classe_cor_badge,
    (CURRENT_DATE - p.data_pedido) AS dias_desde_criacao,
        CASE
            WHEN ((p.data_prevista_pronto IS NOT NULL) AND (p.data_prevista_pronto < CURRENT_DATE)) THEN true
            ELSE false
        END AS em_atraso,
        CASE
            WHEN ((p.data_prevista_pronto IS NOT NULL) AND (p.data_prevista_pronto < CURRENT_DATE)) THEN (CURRENT_DATE - p.data_prevista_pronto)
            ELSE 0
        END AS dias_atraso
   FROM (((pedidos p
     LEFT JOIN lojas l ON ((p.loja_id = l.id)))
     LEFT JOIN laboratorios lab ON ((p.laboratorio_id = lab.id)))
     LEFT JOIN classes_lente cl ON ((p.classe_lente_id = cl.id)))
  WHERE (((p.status)::text = ANY ((ARRAY['REGISTRADO'::character varying, 'AG_PAGAMENTO'::character varying, 'PAGO'::character varying, 'PRODUCAO'::character varying, 'PRONTO'::character varying, 'ENVIADO'::character varying, 'CHEGOU'::character varying])::text[])) AND ((p.status)::text <> ALL ((ARRAY['ENTREGUE'::character varying, 'CANCELADO'::character varying])::text[])))
  ORDER BY
        CASE p.status
            WHEN 'REGISTRADO'::text THEN 1
            WHEN 'AG_PAGAMENTO'::text THEN 2
            WHEN 'PAGO'::text THEN 3
            WHEN 'PRODUCAO'::text THEN 4
            WHEN 'PRONTO'::text THEN 5
            WHEN 'ENVIADO'::text THEN 6
            WHEN 'CHEGOU'::text THEN 7
            ELSE NULL::integer
        END, p.created_at DESC;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |
| v_kpis_dashboard                   |  SELECT count(p.id) AS total_pedidos,
    count(*) FILTER (WHERE ((p.status)::text = 'ENTREGUE'::text)) AS entregues,
    round(avg(
        CASE
            WHEN (((p.status)::text = 'ENTREGUE'::text) AND (p.data_entregue IS NOT NULL) AND (p.data_pedido IS NOT NULL)) THEN (p.data_entregue - p.data_pedido)
            ELSE NULL::integer
        END), 1) AS lead_time_medio,
    count(*) FILTER (WHERE (p.pagamento_atrasado = true)) AS pedidos_atrasados,
    round(avg(p.valor_pedido), 2) AS ticket_medio,
    round((((count(*) FILTER (WHERE (((p.status)::text = 'ENTREGUE'::text) AND (p.data_entregue <= p.data_prometida))))::numeric * 100.0) / (NULLIF(count(*) FILTER (WHERE ((p.status)::text = 'ENTREGUE'::text)), 0))::numeric), 2) AS sla_compliance,
    count(DISTINCT p.laboratorio_id) AS labs_ativos,
    COALESCE(sum(p.valor_pedido), (0)::numeric) AS valor_total_vendas,
    COALESCE(sum(p.custo_lentes), (0)::numeric) AS custo_total_lentes,
        CASE
            WHEN (sum(p.valor_pedido) > (0)::numeric) THEN round((((sum(p.valor_pedido) - COALESCE(sum(p.custo_lentes), (0)::numeric)) / sum(p.valor_pedido)) * (100)::numeric), 2)
            ELSE (0)::numeric
        END AS margem_percentual
   FROM pedidos p;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   |
| v_lead_time_comparativo            |  WITH timeline_data AS (
         SELECT pt.pedido_id,
            min(pt.created_at) AS inicio_timeline,
            max(
                CASE
                    WHEN (pt.status_novo = 'ENTREGUE'::text) THEN pt.created_at
                    ELSE NULL::timestamp with time zone
                END) AS fim_timeline
           FROM pedidos_timeline pt
          GROUP BY pt.pedido_id
        ), lead_times AS (
         SELECT p.id,
            p.laboratorio_id,
            p.classe_lente_id,
            COALESCE(p.created_at, now()) AS created_at,
            p.status,
            td.inicio_timeline,
            td.fim_timeline,
                CASE
                    WHEN (td.fim_timeline IS NOT NULL) THEN (EXTRACT(epoch FROM (td.fim_timeline - COALESCE(p.created_at, now()))) / 86400.0)
                    WHEN (((p.status)::text = 'ENTREGUE'::text) AND (p.updated_at IS NOT NULL)) THEN (EXTRACT(epoch FROM (p.updated_at - COALESCE(p.created_at, now()))) / 86400.0)
                    ELSE (EXTRACT(epoch FROM (now() - COALESCE(p.created_at, now()))) / 86400.0)
                END AS lead_time_dias
           FROM (pedidos p
             LEFT JOIN timeline_data td ON ((p.id = td.pedido_id)))
          WHERE (((p.status)::text <> 'CANCELADO'::text) AND (COALESCE(p.created_at, now()) >= (now() - '1 year'::interval)))
        ), medias_por_combinacao AS (
         SELECT lt.laboratorio_id,
            lt.classe_lente_id,
            avg(lt.lead_time_dias) AS media_combinacao,
            count(*) AS total_pedidos_combinacao
           FROM lead_times lt
          WHERE ((lt.lead_time_dias > (0)::numeric) AND (lt.lead_time_dias < (365)::numeric))
          GROUP BY lt.laboratorio_id, lt.classe_lente_id
        ), medias_laboratorio AS (
         SELECT lt.laboratorio_id,
            avg(lt.lead_time_dias) AS media_laboratorio,
            count(*) AS total_pedidos_laboratorio
           FROM lead_times lt
          WHERE ((lt.lead_time_dias > (0)::numeric) AND (lt.lead_time_dias < (365)::numeric))
          GROUP BY lt.laboratorio_id
        ), medias_classe AS (
         SELECT lt.classe_lente_id,
            avg(lt.lead_time_dias) AS media_classe,
            count(*) AS total_pedidos_classe
           FROM lead_times lt
          WHERE ((lt.lead_time_dias > (0)::numeric) AND (lt.lead_time_dias < (365)::numeric))
          GROUP BY lt.classe_lente_id
        ), media_geral_calc AS (
         SELECT avg(lt.lead_time_dias) AS media_geral,
            count(*) AS total_pedidos_geral
           FROM lead_times lt
          WHERE ((lt.lead_time_dias > (0)::numeric) AND (lt.lead_time_dias < (365)::numeric))
        )
 SELECT mpc.laboratorio_id,
    mpc.classe_lente_id,
    COALESCE(ml.media_laboratorio, 5.0) AS media_laboratorio,
    COALESCE(mc.media_classe, 5.0) AS media_classe,
    COALESCE(mgc.media_geral, 5.0) AS media_geral,
    COALESCE(ml.total_pedidos_laboratorio, (0)::bigint) AS pedidos_laboratorio,
    COALESCE(mc.total_pedidos_classe, (0)::bigint) AS pedidos_classe,
    COALESCE(mgc.total_pedidos_geral, (0)::bigint) AS total_pedidos
   FROM (((medias_por_combinacao mpc
     LEFT JOIN medias_laboratorio ml ON ((mpc.laboratorio_id = ml.laboratorio_id)))
     LEFT JOIN medias_classe mc ON ((mpc.classe_lente_id = mc.classe_lente_id)))
     CROSS JOIN media_geral_calc mgc);                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |
| v_missoes_timeline                 |  SELECT md.id,
    md.loja_id,
    l.nome AS loja_nome,
    md.data_missao,
    md.status,
    md.data_vencimento,
    md.concluida_em,
    md.executada_por,
    md.qualidade_execucao,
    md.pontos_total,
    md.tempo_total_execucao_segundos,
    mt.nome AS missao_nome,
    mt.descricao,
    mt.tipo,
    mt.categoria,
    mt.icone,
    mt.cor_primary,
    mt.tempo_estimado_min,
    mt.requer_evidencia,
    mt.horario_inicio,
    mt.horario_limite,
        CASE
            WHEN (md.status = 'concluida'::text) THEN 'concluida'::text
            WHEN (md.data_vencimento < now()) THEN 'vencida'::text
            WHEN (md.data_vencimento < (now() + '01:00:00'::interval)) THEN 'urgente'::text
            ELSE 'no_prazo'::text
        END AS urgencia_status,
        CASE
            WHEN (mt.horario_inicio IS NULL) THEN (100)::numeric
            WHEN (CURRENT_TIME < (mt.horario_inicio)::time with time zone) THEN (0)::numeric
            WHEN (CURRENT_TIME > (COALESCE(mt.horario_limite, '18:00:00'::time without time zone))::time with time zone) THEN (100)::numeric
            ELSE round(((EXTRACT(epoch FROM (CURRENT_TIME - (mt.horario_inicio)::interval)) / EXTRACT(epoch FROM (COALESCE(mt.horario_limite, '18:00:00'::time without time zone) - mt.horario_inicio))) * (100)::numeric))
        END AS progresso_tempo,
    md.created_at,
    md.updated_at
   FROM ((missoes_diarias md
     JOIN missao_templates mt ON ((md.template_id = mt.id)))
     JOIN lojas l ON ((md.loja_id = l.id)))
  ORDER BY md.data_missao DESC,
        CASE mt.tipo
            WHEN 'critica'::text THEN 1
            WHEN 'especial'::text THEN 2
            WHEN 'rapida'::text THEN 3
            WHEN 'bonus'::text THEN 4
            ELSE NULL::integer
        END, COALESCE(mt.horario_inicio, '08:00:00'::time without time zone);                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
| v_montadores_ativos                |  SELECT montadores.id,
    montadores.nome,
    montadores.tipo,
        CASE
            WHEN (montadores.tipo = 'INTERNO'::text) THEN ('🔧 '::text || montadores.nome)
            WHEN (montadores.tipo = 'LABORATORIO'::text) THEN ('🧪 '::text || montadores.nome)
            ELSE montadores.nome
        END AS nome_display
   FROM montadores
  WHERE (montadores.ativo = true)
  ORDER BY
        CASE montadores.tipo
            WHEN 'INTERNO'::text THEN 1
            WHEN 'LABORATORIO'::text THEN 2
            ELSE NULL::integer
        END, montadores.nome;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |
| v_pedido_timeline_completo         |  WITH timeline_with_lag AS (
         SELECT pt.id,
            pt.pedido_id,
            pt.status_anterior,
            pt.status_novo,
            pt.responsavel_id,
            pt.observacoes,
            pt.created_at,
            pt.updated_at,
            COALESCE(u.nome, 'Sistema'::text) AS responsavel_nome,
            u.email AS responsavel_email,
            lag(pt.created_at) OVER (PARTITION BY pt.pedido_id ORDER BY pt.created_at) AS etapa_anterior_data,
            lag(pt.status_novo) OVER (PARTITION BY pt.pedido_id ORDER BY pt.created_at) AS status_anterior_real,
            row_number() OVER (PARTITION BY pt.pedido_id ORDER BY pt.created_at) AS ordem_etapa
           FROM (pedidos_timeline pt
             LEFT JOIN usuarios u ON ((pt.responsavel_id = u.id)))
        )
 SELECT twl.id,
    twl.pedido_id,
    twl.status_anterior,
    twl.status_novo,
    twl.responsavel_id,
    twl.observacoes,
    twl.created_at,
    twl.updated_at,
    twl.responsavel_nome,
    twl.responsavel_email,
    twl.etapa_anterior_data,
    twl.status_anterior_real,
    twl.ordem_etapa,
        CASE
            WHEN (twl.etapa_anterior_data IS NOT NULL) THEN (EXTRACT(epoch FROM (twl.created_at - twl.etapa_anterior_data)) / 3600.0)
            ELSE (0)::numeric
        END AS tempo_etapa_anterior_horas,
        CASE
            WHEN (twl.etapa_anterior_data IS NOT NULL) THEN (EXTRACT(epoch FROM (twl.created_at - twl.etapa_anterior_data)) / 86400.0)
            ELSE (0)::numeric
        END AS tempo_etapa_anterior_dias,
        CASE upper(TRIM(BOTH FROM COALESCE(twl.status_novo, ''::text)))
            WHEN 'REGISTRADO'::text THEN 'Registrado'::text
            WHEN 'AG_PAGAMENTO'::text THEN 'Aguardando Pagamento'::text
            WHEN 'PAGO'::text THEN 'Pago'::text
            WHEN 'PRODUCAO'::text THEN 'Em Produção'::text
            WHEN 'PRONTO'::text THEN 'Pronto no DCL'::text
            WHEN 'ENVIADO'::text THEN 'Enviado para Loja'::text
            WHEN 'CHEGOU'::text THEN 'Chegou na Loja'::text
            WHEN 'ENTREGUE'::text THEN 'Entregue ao Cliente'::text
            WHEN 'CANCELADO'::text THEN 'Cancelado'::text
            ELSE COALESCE(twl.status_novo, 'Indefinido'::text)
        END AS status_label,
        CASE upper(TRIM(BOTH FROM COALESCE(twl.status_novo, ''::text)))
            WHEN 'REGISTRADO'::text THEN '#6B7280'::text
            WHEN 'AG_PAGAMENTO'::text THEN '#EAB308'::text
            WHEN 'PAGO'::text THEN '#3B82F6'::text
            WHEN 'PRODUCAO'::text THEN '#8B5CF6'::text
            WHEN 'PRONTO'::text THEN '#6366F1'::text
            WHEN 'ENVIADO'::text THEN '#06B6D4'::text
            WHEN 'CHEGOU'::text THEN '#F97316'::text
            WHEN 'ENTREGUE'::text THEN '#10B981'::text
            WHEN 'CANCELADO'::text THEN '#EF4444'::text
            ELSE '#6B7280'::text
        END AS status_color
   FROM timeline_with_lag twl
  ORDER BY twl.pedido_id, twl.created_at;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |
| v_pedidos_historico                |  SELECT p.id,
    p.numero_sequencial,
    p.numero_os_fisica,
    p.status,
    p.cliente_nome,
    p.valor_pedido,
    p.data_pedido,
    p.data_entregue,
    p.created_at,
    p.updated_at,
    l.nome AS loja_nome,
    l.codigo AS loja_codigo,
    lab.nome AS laboratorio_nome,
    cl.nome AS classe_nome,
        CASE
            WHEN (((p.status)::text = 'ENTREGUE'::text) AND (p.data_entregue IS NOT NULL)) THEN (p.data_entregue - p.data_pedido)
            WHEN ((p.status)::text = 'CANCELADO'::text) THEN ((p.updated_at)::date - p.data_pedido)
            ELSE NULL::integer
        END AS lead_time_total_dias,
        CASE
            WHEN ((p.status)::text = 'CANCELADO'::text) THEN p.observacoes
            ELSE NULL::text
        END AS motivo_cancelamento
   FROM (((pedidos p
     LEFT JOIN lojas l ON ((p.loja_id = l.id)))
     LEFT JOIN laboratorios lab ON ((p.laboratorio_id = lab.id)))
     LEFT JOIN classes_lente cl ON ((p.classe_lente_id = cl.id)))
  WHERE ((p.status)::text = ANY ((ARRAY['ENTREGUE'::character varying, 'CANCELADO'::character varying])::text[]))
  ORDER BY
        CASE p.status
            WHEN 'ENTREGUE'::text THEN 1
            WHEN 'CANCELADO'::text THEN 2
            ELSE NULL::integer
        END, p.updated_at DESC;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           |
| v_pedidos_kanban                   |  SELECT p.id,
    p.numero_sequencial,
    p.loja_id,
    p.laboratorio_id,
    p.classe_lente_id,
    p.status,
    p.prioridade,
    p.data_pedido,
    p.data_prometida,
    p.data_limite_pagamento,
    p.data_prevista_pronto,
    p.data_pagamento,
    p.data_entregue,
    p.valor_pedido,
    p.forma_pagamento,
    p.cliente_nome,
    p.cliente_telefone,
    p.pagamento_atrasado,
    p.producao_atrasada,
    p.requer_atencao,
    p.observacoes,
    p.observacoes_internas,
    p.created_at,
    p.updated_at,
    p.created_by,
    p.numero_os_fisica,
    p.data_inicio_producao,
    p.data_conclusao_producao,
    p.lead_time_producao_horas,
    p.lead_time_total_horas,
    p.laboratorio_responsavel_producao,
    p.updated_by,
    p.custo_lentes,
    p.eh_garantia,
    p.observacoes_garantia,
    p.numero_pedido_laboratorio,
    p.vendedor_id,
    p.esferico_od,
    p.cilindrico_od,
    p.eixo_od,
    p.adicao_od,
    p.esferico_oe,
    p.cilindrico_oe,
    p.eixo_oe,
    p.adicao_oe,
    p.distancia_pupilar,
    p.material_lente,
    p.indice_refracao,
    p.montador_id,
    p.data_envio_montagem,
    p.data_prevista_montagem,
    p.data_sla_laboratorio,
    p.observacoes_sla,
    p.grupo_canonico_id,
    p.lente_selecionada_id,
    p.fornecedor_lente_id,
    p.preco_lente,
    p.custo_lente,
    p.margem_lente_percentual,
    p.nome_lente,
    p.nome_grupo_canonico,
    p.tratamentos_lente,
    p.selecao_automatica,
    p.lente_metadata,
    p.montador_nome,
    p.montador_local,
    p.montador_contato,
    p.custo_montagem,
    p.data_montagem,
    l.nome AS loja_nome,
    l.codigo AS loja_codigo,
    l.margem_seguranca_dias,
    l.alerta_sla_dias,
    lab.nome AS laboratorio_nome,
    lab.codigo AS laboratorio_codigo,
    lab.sla_padrao_dias,
    cl.nome AS classe_nome,
    cl.categoria AS classe_categoria,
    cl.cor_badge AS classe_cor,
    cl.sla_base_dias AS classe_sla_dias,
        CASE
            WHEN (p.data_sla_laboratorio < CURRENT_DATE) THEN true
            ELSE false
        END AS sla_atrasado,
        CASE
            WHEN (p.data_sla_laboratorio <= (CURRENT_DATE + ('1 day'::interval * (COALESCE(l.alerta_sla_dias, 1))::double precision))) THEN true
            ELSE false
        END AS sla_alerta,
    (p.data_sla_laboratorio - CURRENT_DATE) AS dias_para_sla,
    (p.data_prometida - CURRENT_DATE) AS dias_para_promessa
   FROM (((pedidos p
     LEFT JOIN lojas l ON ((p.loja_id = l.id)))
     LEFT JOIN laboratorios lab ON ((p.laboratorio_id = lab.id)))
     LEFT JOIN classes_lente cl ON ((p.classe_lente_id = cl.id)));                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          |
| v_pedidos_montagem                 |  SELECT p.id,
    p.numero_sequencial,
    p.loja_id,
    p.laboratorio_id,
    p.classe_lente_id,
    p.status,
    p.prioridade,
    p.data_pedido,
    p.data_prometida,
    p.data_limite_pagamento,
    p.data_prevista_pronto,
    p.data_pagamento,
    p.data_entregue,
    p.valor_pedido,
    p.forma_pagamento,
    p.cliente_nome,
    p.cliente_telefone,
    p.pagamento_atrasado,
    p.producao_atrasada,
    p.requer_atencao,
    p.observacoes,
    p.observacoes_internas,
    p.created_at,
    p.updated_at,
    p.created_by,
    p.numero_os_fisica,
    p.data_inicio_producao,
    p.data_conclusao_producao,
    p.lead_time_producao_horas,
    p.lead_time_total_horas,
    p.laboratorio_responsavel_producao,
    p.updated_by,
    p.custo_lentes,
    p.eh_garantia,
    p.observacoes_garantia,
    p.numero_pedido_laboratorio,
    p.vendedor_id,
    p.esferico_od,
    p.cilindrico_od,
    p.eixo_od,
    p.adicao_od,
    p.esferico_oe,
    p.cilindrico_oe,
    p.eixo_oe,
    p.adicao_oe,
    p.distancia_pupilar,
    p.material_lente,
    p.indice_refracao,
    p.montador_id,
    p.data_envio_montagem,
    p.data_prevista_montagem,
    m.nome AS montador_nome,
    m.tipo AS montador_tipo,
    l.nome AS loja_nome,
    lab.nome AS laboratorio_nome,
    cl.nome AS classe_nome
   FROM ((((pedidos p
     LEFT JOIN montadores m ON ((p.montador_id = m.id)))
     LEFT JOIN lojas l ON ((p.loja_id = l.id)))
     LEFT JOIN laboratorios lab ON ((p.laboratorio_id = lab.id)))
     LEFT JOIN classes_lente cl ON ((p.classe_lente_id = cl.id)))
  WHERE (p.montador_id IS NOT NULL);                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |
| v_projecoes                        |  SELECT 'Próximos 3 meses'::text AS periodo,
    180 AS pedidos_projetados,
    1550.00 AS ticket_projetado,
    4.2 AS lead_time_projetado,
    279000.00 AS faturamento_projetado,
    8.5 AS crescimento_percentual_mensal;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
| v_usuario_permissoes_kanban        |  SELECT u.id AS usuario_id,
    u.email,
    u.nome,
    u.role,
    rsp.status_pedido,
    rsp.pode_visualizar,
    rsp.pode_editar,
    rsp.pode_mover_para,
    rsp.acoes_especiais,
    l.nome AS loja_nome,
    l.codigo AS loja_codigo
   FROM ((usuarios u
     LEFT JOIN role_status_permissoes_legacy rsp ON ((u.role = rsp.role)))
     LEFT JOIN lojas l ON ((u.loja_id = l.id)))
  WHERE ((u.ativo = true) AND ((rsp.status_pedido)::text = ANY ((ARRAY['REGISTRADO'::character varying, 'AG_PAGAMENTO'::character varying, 'PAGO'::character varying, 'PRODUCAO'::character varying, 'PRONTO'::character varying, 'ENVIADO'::character varying, 'CHEGOU'::character varying])::text[])))
  ORDER BY u.email,
        CASE rsp.status_pedido
            WHEN 'REGISTRADO'::text THEN 1
            WHEN 'AG_PAGAMENTO'::text THEN 2
            WHEN 'PAGO'::text THEN 3
            WHEN 'PRODUCAO'::text THEN 4
            WHEN 'PRONTO'::text THEN 5
            WHEN 'ENVIADO'::text THEN 6
            WHEN 'CHEGOU'::text THEN 7
            ELSE NULL::integer
        END;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           |
| view_controle_os_estatisticas      |  SELECT c.loja_id,
    l.nome AS loja_nome,
    count(*) AS total_os_esperadas,
    count(*) FILTER (WHERE c.lancado) AS total_lancadas,
    count(*) FILTER (WHERE (NOT c.lancado)) AS total_nao_lancadas,
    count(j.id) FILTER (WHERE j.resolvido) AS total_justificadas,
    count(j.id) FILTER (WHERE (NOT j.resolvido)) AS total_pendentes,
    count(*) FILTER (WHERE ((NOT c.lancado) AND ((j.id IS NULL) OR (NOT j.resolvido)))) AS total_precisa_atencao,
    round((((count(*) FILTER (WHERE c.lancado))::numeric / (NULLIF(count(*), 0))::numeric) * (100)::numeric), 2) AS percentual_lancamento
   FROM ((controle_os c
     LEFT JOIN lojas l ON ((l.id = c.loja_id)))
     LEFT JOIN os_nao_lancadas j ON (((j.numero_os = c.numero_os) AND (j.loja_id = c.loja_id))))
  GROUP BY c.loja_id, l.nome;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |
| view_controle_os_gaps              |  SELECT c.numero_os,
    c.loja_id,
    l.nome AS loja_nome,
    c.lancado,
    c.data_lancamento,
    c.created_at,
    j.justificativa,
    j.tipo_justificativa,
    j.resolvido AS justificativa_resolvida,
        CASE
            WHEN c.lancado THEN 'lancada'::text
            WHEN j.resolvido THEN 'justificada'::text
            WHEN ((j.id IS NOT NULL) AND (NOT j.resolvido)) THEN 'pendente_justificativa'::text
            ELSE 'nao_lancada'::text
        END AS status,
    ((NOT c.lancado) AND ((j.id IS NULL) OR (NOT j.resolvido))) AS precisa_atencao
   FROM ((controle_os c
     LEFT JOIN lojas l ON ((l.id = c.loja_id)))
     LEFT JOIN os_nao_lancadas j ON (((j.numero_os = c.numero_os) AND (j.loja_id = c.loja_id))))
  WHERE (c.lancado = false);                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |
| view_kpis_montadores               |  SELECT m.id,
    m.nome,
    m.tipo,
    m.laboratorio_id,
    l.nome AS laboratorio_nome,
    count(
        CASE
            WHEN ((p.status)::text = 'ENVIADO'::text) THEN 1
            ELSE NULL::integer
        END) AS em_montagem_atual,
    count(
        CASE
            WHEN (((p.status)::text = ANY ((ARRAY['CHEGOU'::character varying, 'ENTREGUE'::character varying])::text[])) AND (date(p.updated_at) = CURRENT_DATE)) THEN 1
            ELSE NULL::integer
        END) AS concluidos_hoje,
    count(
        CASE
            WHEN (((p.status)::text = ANY ((ARRAY['CHEGOU'::character varying, 'ENTREGUE'::character varying])::text[])) AND (p.updated_at >= date_trunc('week'::text, (CURRENT_DATE)::timestamp with time zone))) THEN 1
            ELSE NULL::integer
        END) AS concluidos_semana,
    count(
        CASE
            WHEN (((p.status)::text = ANY ((ARRAY['CHEGOU'::character varying, 'ENTREGUE'::character varying])::text[])) AND (p.updated_at >= date_trunc('month'::text, (CURRENT_DATE)::timestamp with time zone))) THEN 1
            ELSE NULL::integer
        END) AS concluidos_mes,
    avg(
        CASE
            WHEN ((p.status)::text = ANY ((ARRAY['CHEGOU'::character varying, 'ENTREGUE'::character varying])::text[])) THEN (EXTRACT(epoch FROM (p.updated_at - p.created_at)) / (3600)::numeric)
            ELSE NULL::numeric
        END) AS tempo_medio_horas,
    count(
        CASE
            WHEN ((p.status)::text = ANY ((ARRAY['CHEGOU'::character varying, 'ENTREGUE'::character varying])::text[])) THEN 1
            ELSE NULL::integer
        END) AS total_montagens
   FROM ((montadores m
     LEFT JOIN pedidos p ON ((p.montador_id = m.id)))
     LEFT JOIN laboratorios l ON ((m.laboratorio_id = l.id)))
  WHERE (m.ativo = true)
  GROUP BY m.id, m.nome, m.tipo, m.laboratorio_id, l.nome;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
| view_os_estatisticas               |  SELECT view_os_gaps.loja_id,
    view_os_gaps.loja_nome,
    count(*) AS total_os_esperadas,
    count(*) FILTER (WHERE (view_os_gaps.status = 'lancada'::text)) AS total_lancadas,
    count(*) FILTER (WHERE (view_os_gaps.status = 'nao_lancada'::text)) AS total_nao_lancadas,
    count(*) FILTER (WHERE (view_os_gaps.status = 'justificada'::text)) AS total_justificadas,
    count(*) FILTER (WHERE (view_os_gaps.status = 'pendente_justificativa'::text)) AS total_pendentes,
    count(*) FILTER (WHERE view_os_gaps.precisa_atencao) AS total_precisa_atencao,
    round((((count(*) FILTER (WHERE (view_os_gaps.status = 'lancada'::text)))::numeric / (NULLIF(count(*), 0))::numeric) * (100)::numeric), 2) AS percentual_lancamento
   FROM view_os_gaps
  GROUP BY view_os_gaps.loja_id, view_os_gaps.loja_nome;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |
| view_os_gaps                       |  WITH os_esperadas AS (
         SELECT seq.numero_os,
            seq.loja_id,
            l_1.nome AS loja_nome,
            seq.data_esperada,
            seq.origem
           FROM (os_sequencia seq
             LEFT JOIN lojas l_1 ON ((l_1.id = seq.loja_id)))
        ), os_lancadas AS (
         SELECT (pedidos.numero_os_fisica)::integer AS numero_os,
            pedidos.loja_id
           FROM pedidos
          WHERE ((pedidos.numero_os_fisica IS NOT NULL) AND ((pedidos.numero_os_fisica)::text ~ '^[0-9]+$'::text))
        ), os_justificadas AS (
         SELECT os_nao_lancadas.numero_os,
            os_nao_lancadas.loja_id,
            os_nao_lancadas.justificativa,
            os_nao_lancadas.tipo_justificativa,
            os_nao_lancadas.resolvido
           FROM os_nao_lancadas
        )
 SELECT e.numero_os,
    e.loja_id,
    e.loja_nome,
    e.data_esperada,
    e.origem,
        CASE
            WHEN (l.numero_os IS NOT NULL) THEN 'lancada'::text
            WHEN ((j.numero_os IS NOT NULL) AND j.resolvido) THEN 'justificada'::text
            WHEN ((j.numero_os IS NOT NULL) AND (NOT j.resolvido)) THEN 'pendente_justificativa'::text
            ELSE 'nao_lancada'::text
        END AS status,
    j.justificativa,
    j.tipo_justificativa,
    ((l.numero_os IS NULL) AND ((j.numero_os IS NULL) OR (NOT j.resolvido))) AS precisa_atencao
   FROM ((os_esperadas e
     LEFT JOIN os_lancadas l ON (((l.numero_os = e.numero_os) AND (l.loja_id = e.loja_id))))
     LEFT JOIN os_justificadas j ON (((j.numero_os = e.numero_os) AND (j.loja_id = e.loja_id))))
  ORDER BY e.numero_os DESC;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
| view_performance_diaria_montadores |  SELECT m.id AS montador_id,
    m.nome AS montador_nome,
    date(p.updated_at) AS data,
    count(*) AS montagens_concluidas,
    avg((EXTRACT(epoch FROM (p.updated_at - p.created_at)) / (3600)::numeric)) AS tempo_medio_horas
   FROM (pedidos p
     JOIN montadores m ON ((p.montador_id = m.id)))
  WHERE (((p.status)::text = ANY ((ARRAY['CHEGOU'::character varying, 'ENTREGUE'::character varying])::text[])) AND (p.updated_at >= (CURRENT_DATE - '30 days'::interval)))
  GROUP BY m.id, m.nome, (date(p.updated_at))
  ORDER BY (date(p.updated_at)) DESC, (count(*)) DESC;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                |
| view_ranking_montadores            |  SELECT row_number() OVER (ORDER BY (count(*)) DESC) AS ranking,
    m.id AS montador_id,
    m.nome AS montador_nome,
    m.tipo,
    count(*) AS total_montagens,
    avg((EXTRACT(epoch FROM (p.updated_at - p.created_at)) / (3600)::numeric)) AS tempo_medio_horas
   FROM (pedidos p
     JOIN montadores m ON ((p.montador_id = m.id)))
  WHERE (((p.status)::text = ANY ((ARRAY['CHEGOU'::character varying, 'ENTREGUE'::character varying])::text[])) AND (p.updated_at >= date_trunc('month'::text, (CURRENT_DATE)::timestamp with time zone)))
  GROUP BY m.id, m.nome, m.tipo;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |
| view_relatorio_montagens           |  SELECT p.id,
    p.numero_sequencial,
    p.status,
    p.cliente_nome,
    p.created_at AS data_registro,
    p.updated_at AS ultima_atualizacao,
    p.loja_id,
    lo.nome AS loja_nome,
    m.id AS montador_id,
    m.nome AS montador_nome,
    m.tipo AS montador_tipo,
    l.id AS laboratorio_id,
    l.nome AS laboratorio_nome,
        CASE p.status
            WHEN 'ENVIADO'::text THEN 'Em Montagem'::character varying
            WHEN 'CHEGOU'::text THEN 'Montagem Concluída'::character varying
            WHEN 'ENTREGUE'::text THEN 'Entregue ao Cliente'::character varying
            ELSE p.status
        END AS status_legivel
   FROM (((pedidos p
     LEFT JOIN montadores m ON ((p.montador_id = m.id)))
     LEFT JOIN laboratorios l ON ((p.laboratorio_id = l.id)))
     LEFT JOIN lojas lo ON ((p.loja_id = lo.id)))
  WHERE (p.montador_id IS NOT NULL);                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           |



-- ========== 3. FUNCTIONS ==========
-- Listar todas as functions/procedures
SELECT 
  p.proname as nome_function,
  pg_get_function_arguments(p.oid) as argumentos,
  CASE p.prokind
    WHEN 'f' THEN 'FUNCTION'
    WHEN 'p' THEN 'PROCEDURE'
    WHEN 'a' THEN 'AGGREGATE'
    WHEN 'w' THEN 'WINDOW'
  END as tipo
FROM pg_proc p
JOIN pg_namespace n ON p.pronamespace = n.oid
WHERE n.nspname = 'public'
  AND p.proname NOT LIKE 'pg_%'
ORDER BY p.proname;

| nome_function                       | argumentos                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                | tipo     |
| ----------------------------------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | -------- |
| add_business_days                   | start_date date, days integer, laboratorio_id uuid DEFAULT NULL::uuid                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     | FUNCTION |
| alterar_status_pedido               | pedido_uuid uuid, novo_status character varying, observacao text DEFAULT NULL::text, usuario text DEFAULT NULL::text                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      | FUNCTION |
| aplicar_configuracoes_loja_horarios |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           | FUNCTION |
| atualizar_flags_atraso              | p_missao_id uuid                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          | FUNCTION |
| atualizar_liga_automatica           |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           | FUNCTION |
| auto_entregar_pedido                |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           | FUNCTION |
| brasil_now                          |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           | FUNCTION |
| brasil_today                        |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           | FUNCTION |
| calcular_datas_pos_pagamento        | pedido_id uuid                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            | FUNCTION |
| calcular_dias_diferenca             | data_fim date, data_inicio date                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           | FUNCTION |
| calcular_dias_diferenca_timestamp   | timestamp_fim timestamp with time zone, data_inicio date                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  | FUNCTION |
| calcular_dias_uteis                 | data_inicio date, dias_adicionar integer                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  | FUNCTION |
| calcular_lead_time                  |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           | FUNCTION |
| calcular_liga                       | pontos_mes integer                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        | FUNCTION |
| calcular_margem_lente               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           | FUNCTION |
| calcular_pontos_missao              | p_missao_id uuid                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          | FUNCTION |
| calcular_pontuacao_diaria           | p_loja_id uuid, p_data date                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               | FUNCTION |
| calcular_sla                        | p_data_pagamento timestamp with time zone, p_laboratorio_id uuid                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          | FUNCTION |
| calcular_sla_com_tratamentos        | pedido_uuid uuid                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          | FUNCTION |
| calcular_sla_pedido                 | pedido_uuid uuid                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          | FUNCTION |
| cancelar_missao                     | p_missao_id uuid, p_motivo text, p_usuario text                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           | FUNCTION |
| concluir_missao                     | p_missao_id uuid, p_executada_por text, p_qualidade integer DEFAULT 5, p_observacoes text DEFAULT NULL::text, p_evidencia_urls text[] DEFAULT '{}'::text[]                                                                                                                                                                                                                                                                                                                                                                                                                                                                                | FUNCTION |
| concluir_missao_simples             | p_missao_id uuid, p_executada_por text, p_qualidade integer DEFAULT 5, p_observacoes text DEFAULT NULL::text                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              | FUNCTION |
| criar_alerta                        | pedido_uuid uuid, tipo_alerta text, titulo_alerta text, mensagem_alerta text, destinatario_alerta text DEFAULT NULL::text, loja_uuid uuid DEFAULT NULL::uuid                                                                                                                                                                                                                                                                                                                                                                                                                                                                              | FUNCTION |
| criar_laboratorio_para_montador     |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           | FUNCTION |
| criar_montador_para_laboratorio     |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           | FUNCTION |
| criar_pedido_com_permissao          | p_loja_id uuid, p_laboratorio_id uuid, p_classe_lente_id uuid, p_cliente_nome text, p_numero_pedido_laboratorio text DEFAULT NULL::text                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   | FUNCTION |
| criar_pedido_simples                | p_loja_id uuid, p_laboratorio_id uuid, p_classe_lente_id uuid, p_cliente_nome text, p_cliente_telefone text DEFAULT NULL::text, p_numero_os_fisica text DEFAULT NULL::text, p_numero_pedido_laboratorio text DEFAULT NULL::text, p_valor_pedido numeric DEFAULT NULL::numeric, p_custo_lentes numeric DEFAULT NULL::numeric, p_eh_garantia boolean DEFAULT false, p_observacoes text DEFAULT NULL::text, p_observacoes_garantia text DEFAULT NULL::text, p_prioridade text DEFAULT 'NORMAL'::text, p_data_prometida_cliente date DEFAULT NULL::date, p_tratamentos_ids uuid[] DEFAULT NULL::uuid[], p_montador_id uuid DEFAULT NULL::uuid | FUNCTION |
| criar_pedidos_realistas             |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           | FUNCTION |
| cron_renovacao_diaria               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           | FUNCTION |
| delegar_missao                      | p_missao_id uuid, p_delegar_para uuid, p_motivo text, p_delegado_por text                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 | FUNCTION |
| deve_executar_renovacao             |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           | FUNCTION |
| enviar_para_montagem                | p_pedido_id uuid, p_montador_id uuid, p_usuario text DEFAULT NULL::text                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   | FUNCTION |
| executar_renovacao_diaria           |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           | FUNCTION |
| gerar_missoes_com_configuracoes     | p_data date DEFAULT CURRENT_DATE                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          | FUNCTION |
| gerar_missoes_diarias               | p_loja_id uuid, p_data date DEFAULT CURRENT_DATE                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          | FUNCTION |
| get_alertas_sla_criticos            | p_loja_id uuid DEFAULT NULL::uuid                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         | FUNCTION |
| get_alertas_sla_criticos            |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           | FUNCTION |
| get_dashboard_realtime              |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           | FUNCTION |
| get_metricas_periodo                | data_inicio date, data_fim date                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           | FUNCTION |
| get_performance_laboratorios        | p_loja_id uuid DEFAULT NULL::uuid, p_data_inicio date DEFAULT NULL::date, p_data_fim date DEFAULT NULL::date                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              | FUNCTION |
| get_performance_laboratorios        | p_data_inicio date DEFAULT (CURRENT_DATE - '30 days'::interval), p_data_fim date DEFAULT CURRENT_DATE                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     | FUNCTION |
| get_sla_metricas                    | p_loja_id uuid DEFAULT NULL::uuid, p_data_inicio date DEFAULT NULL::date, p_data_fim date DEFAULT NULL::date                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              | FUNCTION |
| get_timeline_sla_7_dias             |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           | FUNCTION |
| get_timeline_sla_7_dias             | p_loja_id uuid DEFAULT NULL::uuid                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         | FUNCTION |
| get_tratamentos_pedido              | pedido_uuid uuid                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          | FUNCTION |
| iniciar_missao                      | p_missao_id uuid, p_usuario text                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          | FUNCTION |
| inserir_novo_pedido                 | p_loja_id uuid, p_laboratorio_id uuid, p_classe_lente_id uuid, p_cliente_nome text, p_numero_pedido_laboratorio text DEFAULT NULL::text, p_valor_pedido numeric DEFAULT NULL::numeric, p_observacoes text DEFAULT NULL::text, p_prioridade text DEFAULT 'NORMAL'::text                                                                                                                                                                                                                                                                                                                                                                    | FUNCTION |
| inserir_pedido_sem_trigger          | p_loja_id uuid, p_laboratorio_id uuid, p_classe_lente_id uuid, p_status text, p_prioridade text, p_cliente_nome text, p_cliente_telefone text DEFAULT NULL::text, p_observacoes text DEFAULT NULL::text, p_eh_garantia boolean DEFAULT false, p_data_pedido date DEFAULT CURRENT_DATE, p_data_prometida date DEFAULT NULL::date                                                                                                                                                                                                                                                                                                           | FUNCTION |
| inserir_timeline_pedido             |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           | FUNCTION |
| is_demo_user                        |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           | FUNCTION |
| justificar_os_nao_lancada           | p_numero_os integer, p_loja_id uuid, p_justificativa text, p_tipo_justificativa text, p_usuario_id uuid                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   | FUNCTION |
| log_status_change                   |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           | FUNCTION |
| marcar_alerta_lido                  | alerta_id uuid                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            | FUNCTION |
| marcar_pagamento                    | pedido_uuid uuid, data_pag date DEFAULT CURRENT_DATE, forma_pag text DEFAULT 'PIX'::text, usuario text DEFAULT NULL::text                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 | FUNCTION |
| marcar_pago                         | pedido_id uuid, p_data_pagamento date, p_forma_pagamento text DEFAULT NULL::text, p_usuario_id uuid DEFAULT NULL::uuid                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    | FUNCTION |
| mover_para_historico                | pedido_uuid uuid, novo_status character varying                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           | FUNCTION |
| pausar_missao                       | p_missao_id uuid, p_motivo text DEFAULT NULL::text                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        | FUNCTION |
| popular_sequencia_dinamica          | p_loja_id uuid, p_numero_inicial integer DEFAULT NULL::integer, p_margem_futura integer DEFAULT 1000                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      | FUNCTION |
| popular_sequencia_os                | p_loja_id uuid, p_numero_inicial integer, p_numero_final integer, p_origem text DEFAULT 'importacao'::text                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                | FUNCTION |
| populate_data_prometida             |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           | FUNCTION |
| proxima_renovacao                   |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           | FUNCTION |
| recalcular_sla_pedido               | pedido_uuid uuid                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          | FUNCTION |
| refresh_dashboard_views             |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           | FUNCTION |
| registrar_evento                    | pedido_uuid uuid, tipo_evento character varying, titulo_evento text, descricao_evento text DEFAULT NULL::text, status_ant character varying DEFAULT NULL::character varying, status_nov character varying DEFAULT NULL::character varying, usuario_evento text DEFAULT NULL::text                                                                                                                                                                                                                                                                                                                                                         | FUNCTION |
| set_usuario_password                | p_email text, p_password text                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             | FUNCTION |
| simple_updated_at                   |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           | FUNCTION |
| simular_evolucao_pedidos            |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           | FUNCTION |
| status_ultima_renovacao             |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           | FUNCTION |
| sync_controle_os                    |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           | FUNCTION |
| sync_controle_os_from_pedido        |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           | FUNCTION |
| testar_trigger_sistema              |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           | FUNCTION |
| trg_set_updated_at                  |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           | FUNCTION |
| trigger_atualizar_datas_pedido      |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           | FUNCTION |
| trigger_atualizar_sla               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           | FUNCTION |
| trigger_auto_adicionar_os_sequencia |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           | FUNCTION |
| trigger_auto_enviar_montagem        |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           | FUNCTION |
| trigger_criar_evento_timeline       |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           | FUNCTION |
| trigger_gerar_missoes_diarias       |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           | FUNCTION |
| trigger_pedido_avancado             |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           | FUNCTION |
| trigger_pedido_mudanca              |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           | FUNCTION |
| trigger_registrar_historico         |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           | FUNCTION |
| trigger_set_updated_at              |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           | FUNCTION |
| trigger_updated_at                  |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           | FUNCTION |
| trigger_verificar_alertas           |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           | FUNCTION |
| update_pedidos_timeline_updated_at  |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           | FUNCTION |
| update_updated_at_column            |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           | FUNCTION |
| validate_usuario_login              | p_email text, p_password text                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             | FUNCTION |
| verificar_alertas_automaticos       |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           | FUNCTION |


-- ========== 4. TRIGGERS ==========
-- Listar todos os triggers
SELECT 
  t.trigger_name,
  t.event_object_table as tabela,
  t.event_manipulation as evento,
  t.action_statement as acao
FROM information_schema.triggers t
WHERE t.trigger_schema = 'public'
ORDER BY t.event_object_table, t.trigger_name;

| trigger_name                                 | tabela                     | evento | acao                                                   |
| -------------------------------------------- | -------------------------- | ------ | ------------------------------------------------------ |
| trg_criar_montador_para_laboratorio          | laboratorios               | INSERT | EXECUTE FUNCTION criar_montador_para_laboratorio()     |
| update_loja_acoes_customizadas_updated_at    | loja_acoes_customizadas    | UPDATE | EXECUTE FUNCTION update_updated_at_column()            |
| update_loja_configuracoes_horario_updated_at | loja_configuracoes_horario | UPDATE | EXECUTE FUNCTION update_updated_at_column()            |
| tr_missoes_updated_at                        | missoes_diarias            | UPDATE | EXECUTE FUNCTION simple_updated_at()                   |
| trg_criar_laboratorio_para_montador          | montadores                 | INSERT | EXECUTE FUNCTION criar_laboratorio_para_montador()     |
| os_nao_lancadas_updated_at                   | os_nao_lancadas            | UPDATE | EXECUTE FUNCTION trigger_set_updated_at()              |
| os_sequencia_updated_at                      | os_sequencia               | UPDATE | EXECUTE FUNCTION trigger_set_updated_at()              |
| trigger_atualizar_datas_pedido               | pedidos                    | INSERT | EXECUTE FUNCTION trigger_atualizar_datas_pedido()      |
| trigger_atualizar_datas_pedido               | pedidos                    | UPDATE | EXECUTE FUNCTION trigger_atualizar_datas_pedido()      |
| trigger_auto_enviar_montagem                 | pedidos                    | UPDATE | EXECUTE FUNCTION trigger_auto_enviar_montagem()        |
| trigger_calcular_margem_lente                | pedidos                    | INSERT | EXECUTE FUNCTION calcular_margem_lente()               |
| trigger_calcular_margem_lente                | pedidos                    | UPDATE | EXECUTE FUNCTION calcular_margem_lente()               |
| trigger_controle_os                          | pedidos                    | UPDATE | EXECUTE FUNCTION sync_controle_os()                    |
| trigger_controle_os                          | pedidos                    | INSERT | EXECUTE FUNCTION sync_controle_os()                    |
| trigger_criar_evento_timeline                | pedidos                    | INSERT | EXECUTE FUNCTION trigger_criar_evento_timeline()       |
| trigger_criar_evento_timeline                | pedidos                    | UPDATE | EXECUTE FUNCTION trigger_criar_evento_timeline()       |
| trigger_pedido_adicionar_os_sequencia        | pedidos                    | INSERT | EXECUTE FUNCTION trigger_auto_adicionar_os_sequencia() |
| trigger_pedido_adicionar_os_sequencia        | pedidos                    | UPDATE | EXECUTE FUNCTION trigger_auto_adicionar_os_sequencia() |
| trigger_pedidos_timeline                     | pedidos                    | UPDATE | EXECUTE FUNCTION inserir_timeline_pedido()             |
| trigger_pedidos_timeline                     | pedidos                    | INSERT | EXECUTE FUNCTION inserir_timeline_pedido()             |
| trigger_populate_data_prometida              | pedidos                    | INSERT | EXECUTE FUNCTION populate_data_prometida()             |
| trigger_populate_data_prometida              | pedidos                    | UPDATE | EXECUTE FUNCTION populate_data_prometida()             |
| update_pedidos_timeline_updated_at           | pedidos_timeline           | UPDATE | EXECUTE FUNCTION update_pedidos_timeline_updated_at()  |


-- ========== 5. POLICIES RLS ==========
-- Listar todas as policies
SELECT 
  schemaname,
  tablename,
  policyname,
  permissive,
  roles,
  cmd as operacao
FROM pg_policies
WHERE schemaname = 'public'
ORDER BY tablename, policyname;


| schemaname | tablename                     | policyname                                         | permissive | roles           | operacao |
| ---------- | ----------------------------- | -------------------------------------------------- | ---------- | --------------- | -------- |
| public     | alertas                       | Acesso completo para autenticados                  | PERMISSIVE | {authenticated} | ALL      |
| public     | alertas                       | Allow all alertas                                  | PERMISSIVE | {public}        | ALL      |
| public     | alertas                       | anon_all_access                                    | PERMISSIVE | {anon}          | ALL      |
| public     | alertas                       | authenticated_all_access                           | PERMISSIVE | {authenticated} | ALL      |
| public     | classes_lente                 | Allow all classes_lente                            | PERMISSIVE | {public}        | ALL      |
| public     | clientes                      | Acesso completo para autenticados                  | PERMISSIVE | {authenticated} | ALL      |
| public     | clientes                      | anon_all_access                                    | PERMISSIVE | {anon}          | ALL      |
| public     | clientes                      | authenticated_all_access                           | PERMISSIVE | {authenticated} | ALL      |
| public     | colaboradores                 | Permitir leitura para todos                        | PERMISSIVE | {authenticated} | SELECT   |
| public     | colaboradores                 | anon_all_access                                    | PERMISSIVE | {anon}          | ALL      |
| public     | colaboradores                 | authenticated_all_access                           | PERMISSIVE | {authenticated} | ALL      |
| public     | controle_os                   | Usuarios podem ver controle_os de sua loja         | PERMISSIVE | {authenticated} | SELECT   |
| public     | controle_os                   | anon_all_access                                    | PERMISSIVE | {anon}          | ALL      |
| public     | controle_os                   | authenticated_all_access                           | PERMISSIVE | {authenticated} | ALL      |
| public     | laboratorio_sla               | Allow all laboratorio_sla                          | PERMISSIVE | {public}        | ALL      |
| public     | laboratorios                  | Allow all laboratorios                             | PERMISSIVE | {public}        | ALL      |
| public     | laboratorios                  | Allow read laboratorios                            | PERMISSIVE | {public}        | SELECT   |
| public     | lojas                         | Allow all lojas                                    | PERMISSIVE | {public}        | ALL      |
| public     | missoes_diarias               | Enable delete access for all users                 | PERMISSIVE | {public}        | DELETE   |
| public     | missoes_diarias               | Enable insert access for all users                 | PERMISSIVE | {public}        | INSERT   |
| public     | missoes_diarias               | Enable read access for all users                   | PERMISSIVE | {public}        | SELECT   |
| public     | missoes_diarias               | Enable update access for all users                 | PERMISSIVE | {public}        | UPDATE   |
| public     | missoes_diarias               | anon_all_access                                    | PERMISSIVE | {anon}          | ALL      |
| public     | missoes_diarias               | authenticated_all_access                           | PERMISSIVE | {authenticated} | ALL      |
| public     | missoes_diarias               | temp_dev_policy                                    | PERMISSIVE | {public}        | ALL      |
| public     | montadores                    | Montadores: INSERT/UPDATE para gestores            | PERMISSIVE | {authenticated} | ALL      |
| public     | montadores                    | Montadores: SELECT para autenticados               | PERMISSIVE | {authenticated} | SELECT   |
| public     | montadores                    | Usuários anônimos podem visualizar montadores      | PERMISSIVE | {anon}          | SELECT   |
| public     | montadores                    | Usuários autenticados podem visualizar montadores  | PERMISSIVE | {authenticated} | SELECT   |
| public     | montadores                    | anon_all_access                                    | PERMISSIVE | {anon}          | ALL      |
| public     | montadores                    | authenticated_all_access                           | PERMISSIVE | {authenticated} | ALL      |
| public     | montadores                    | montadores_all                                     | PERMISSIVE | {authenticated} | ALL      |
| public     | montadores                    | montadores_delete                                  | PERMISSIVE | {authenticated} | DELETE   |
| public     | montadores                    | montadores_insert                                  | PERMISSIVE | {authenticated} | INSERT   |
| public     | montadores                    | montadores_select                                  | PERMISSIVE | {authenticated} | SELECT   |
| public     | montadores                    | montadores_update                                  | PERMISSIVE | {authenticated} | UPDATE   |
| public     | notificacoes                  | Acesso completo para autenticados                  | PERMISSIVE | {authenticated} | ALL      |
| public     | notificacoes                  | anon_all_access                                    | PERMISSIVE | {anon}          | ALL      |
| public     | notificacoes                  | authenticated_all_access                           | PERMISSIVE | {authenticated} | ALL      |
| public     | os_nao_lancadas               | anon_all_access                                    | PERMISSIVE | {anon}          | ALL      |
| public     | os_nao_lancadas               | authenticated_all_access                           | PERMISSIVE | {authenticated} | ALL      |
| public     | os_nao_lancadas               | os_nao_lancadas_insert_all                         | PERMISSIVE | {authenticated} | INSERT   |
| public     | os_nao_lancadas               | os_nao_lancadas_select_all                         | PERMISSIVE | {authenticated} | SELECT   |
| public     | os_nao_lancadas               | os_nao_lancadas_update_all                         | PERMISSIVE | {authenticated} | UPDATE   |
| public     | os_sequencia                  | anon_all_access                                    | PERMISSIVE | {anon}          | ALL      |
| public     | os_sequencia                  | authenticated_all_access                           | PERMISSIVE | {authenticated} | ALL      |
| public     | os_sequencia                  | os_sequencia_insert_all                            | PERMISSIVE | {authenticated} | INSERT   |
| public     | os_sequencia                  | os_sequencia_select_all                            | PERMISSIVE | {authenticated} | SELECT   |
| public     | pedido_eventos                | Acesso completo para autenticados                  | PERMISSIVE | {authenticated} | ALL      |
| public     | pedido_eventos                | Allow all pedido_eventos                           | PERMISSIVE | {public}        | ALL      |
| public     | pedido_eventos                | Todos authenticated podem atualizar pedido_eventos | PERMISSIVE | {authenticated} | UPDATE   |
| public     | pedido_eventos                | Todos authenticated podem deletar pedido_eventos   | PERMISSIVE | {authenticated} | DELETE   |
| public     | pedido_eventos                | Todos authenticated podem inserir pedido_eventos   | PERMISSIVE | {authenticated} | INSERT   |
| public     | pedido_eventos                | Todos authenticated podem ler pedido_eventos       | PERMISSIVE | {authenticated} | SELECT   |
| public     | pedido_eventos                | anon_all_access                                    | PERMISSIVE | {anon}          | ALL      |
| public     | pedido_eventos                | authenticated_all_access                           | PERMISSIVE | {authenticated} | ALL      |
| public     | pedido_tratamentos            | Acesso completo para autenticados                  | PERMISSIVE | {authenticated} | ALL      |
| public     | pedido_tratamentos            | anon_all_access                                    | PERMISSIVE | {anon}          | ALL      |
| public     | pedido_tratamentos            | authenticated_all_access                           | PERMISSIVE | {authenticated} | ALL      |
| public     | pedidos                       | anon_all_access                                    | PERMISSIVE | {anon}          | ALL      |
| public     | pedidos                       | authenticated_all_access                           | PERMISSIVE | {authenticated} | ALL      |
| public     | pedidos_historico             | Permitir leitura para todos                        | PERMISSIVE | {authenticated} | SELECT   |
| public     | pedidos_historico             | anon_all_access                                    | PERMISSIVE | {anon}          | ALL      |
| public     | pedidos_historico             | authenticated_all_access                           | PERMISSIVE | {authenticated} | ALL      |
| public     | pedidos_timeline              | anon_all_access                                    | PERMISSIVE | {anon}          | ALL      |
| public     | pedidos_timeline              | authenticated_all_access                           | PERMISSIVE | {authenticated} | ALL      |
| public     | pedidos_timeline              | policy_universal_timeline                          | PERMISSIVE | {authenticated} | ALL      |
| public     | role_permissions              | Permitir leitura para todos                        | PERMISSIVE | {authenticated} | SELECT   |
| public     | role_permissions              | anon_all_access                                    | PERMISSIVE | {anon}          | ALL      |
| public     | role_permissions              | authenticated_all_access                           | PERMISSIVE | {authenticated} | ALL      |
| public     | role_status_permissoes_legacy | Permitir leitura para todos                        | PERMISSIVE | {authenticated} | SELECT   |
| public     | role_status_permissoes_legacy | anon_all_access                                    | PERMISSIVE | {anon}          | ALL      |
| public     | role_status_permissoes_legacy | authenticated_all_access                           | PERMISSIVE | {authenticated} | ALL      |
| public     | sistema_config                | Allow all sistema_config                           | PERMISSIVE | {public}        | ALL      |
| public     | tratamentos                   | anon_all_access                                    | PERMISSIVE | {anon}          | ALL      |
| public     | tratamentos                   | authenticated_all_access                           | PERMISSIVE | {authenticated} | ALL      |
| public     | user_sessions                 | anon_all_access                                    | PERMISSIVE | {anon}          | ALL      |
| public     | user_sessions                 | authenticated_all_access                           | PERMISSIVE | {authenticated} | ALL      |
| public     | usuarios                      | Allow all usuarios                                 | PERMISSIVE | {public}        | ALL      |

-- ========== 6. ANÁLISE DE USO - TABELAS VAZIAS ==========
-- Identificar tabelas sem registros (candidatas a remoção)
SELECT 
  c.relname as tablename,
  (SELECT COUNT(*) FROM information_schema.columns WHERE table_name = c.relname) as num_colunas,
  c.reltuples::bigint as estimativa_registros
FROM pg_class c
JOIN pg_namespace n ON n.oid = c.relnamespace
WHERE n.nspname = 'public'
  AND c.relkind = 'r'
  AND c.reltuples = 0
ORDER BY c.relname;

| tablename    | num_colunas | estimativa_registros |
| ------------ | ----------- | -------------------- |
| laboratorios | 8           | 0                    |



-- ========== 7. DEPENDÊNCIAS DE VIEWS ==========
-- Ver quais views dependem de quais tabelas
SELECT DISTINCT
  v.viewname as view_name,
  d.refobjid::regclass as dependencia_tabela
FROM pg_views v
JOIN pg_depend d ON d.objid = (SELECT oid FROM pg_class WHERE relname = v.viewname AND relkind = 'v')
WHERE v.schemaname = 'public'
  AND d.refobjid::regclass::text NOT LIKE 'pg_%'
ORDER BY v.viewname, d.refobjid::regclass;


| view_name                          | dependencia_tabela |
| ---------------------------------- | ------------------ |
| v_alertas_criticos                 | 49606              |
| v_analise_financeira               | 49606              |
| v_analise_sazonalidade             | 49606              |
| v_correlacoes                      | 49606              |
| v_dashboard_bi                     | 49606              |
| v_dashboard_kpis                   | 49606              |
| v_dashboard_kpis_full              | 49606              |
| v_dashboard_resumo                 | 49606              |
| v_evolucao_mensal                  | 49606              |
| v_heatmap_sla                      | 49606              |
| v_kanban_colunas                   | 49606              |
| v_kanban_fluxo_ativo               | 49606              |
| v_kpis_dashboard                   | 49606              |
| v_lead_time_comparativo            | 49606              |
| v_missoes_timeline                 | 49606              |
| v_montadores_ativos                | 49606              |
| v_pedido_timeline_completo         | 49606              |
| v_pedidos_historico                | 49606              |
| v_pedidos_kanban                   | 49606              |
| v_pedidos_montagem                 | 49606              |
| v_projecoes                        | 49606              |
| v_usuario_permissoes_kanban        | 49606              |
| view_controle_os_estatisticas      | 49606              |
| view_controle_os_gaps              | 49606              |
| view_kpis_montadores               | 49606              |
| view_os_estatisticas               | 49606              |
| view_os_gaps                       | 49606              |
| view_performance_diaria_montadores | 49606              |
| view_ranking_montadores            | 49606              |
| view_relatorio_montagens           | 49606              |

